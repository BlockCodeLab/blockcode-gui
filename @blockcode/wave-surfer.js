var Or=Object.create;var{defineProperty:Io,getPrototypeOf:Wr,getOwnPropertyNames:Gr}=Object;var Ur=Object.prototype.hasOwnProperty;var ur=(o,r,t)=>{t=o!=null?Or(Wr(o)):{};const i=r||!o||!o.__esModule?Io(t,"default",{value:o,enumerable:!0}):t;for(let n of Gr(o))if(!Ur.call(i,n))Io(i,n,{get:()=>o[n],enumerable:!0});return i};var Fr=(o,r)=>()=>(r||o((r={exports:{}}).exports,r),r.exports);var bo=Fr((Z1,ko)=>{var nt=function(o,r){r=r||{};var{numberOfChannels:t,sampleRate:i}=o,n=r.float32?3:1,h=n===3?32:16,d;if(t===2)d=dt(o.getChannelData(0),o.getChannelData(1));else d=o.getChannelData(0);return ht(d,n,i,t,h)},ht=function(o,r,t,i,n){var h=n/8,d=i*h,s=new ArrayBuffer(44+o.length*h),c=new DataView(s);if(D(c,0,"RIFF"),c.setUint32(4,36+o.length*h,!0),D(c,8,"WAVE"),D(c,12,"fmt "),c.setUint32(16,16,!0),c.setUint16(20,r,!0),c.setUint16(22,i,!0),c.setUint32(24,t,!0),c.setUint32(28,t*d,!0),c.setUint16(32,d,!0),c.setUint16(34,n,!0),D(c,36,"data"),c.setUint32(40,o.length*h,!0),r===1)st(c,44,o);else ct(c,44,o);return s},dt=function(o,r){var t=o.length+r.length,i=new Float32Array(t),n=0,h=0;while(n<t)i[n++]=o[h],i[n++]=r[h],h++;return i},ct=function(o,r,t){for(var i=0;i<t.length;i++,r+=4)o.setFloat32(r,t[i],!0)},st=function(o,r,t){for(var i=0;i<t.length;i++,r+=2){var n=Math.max(-1,Math.min(1,t[i]));o.setInt16(r,n<0?n*32768:n*32767,!0)}},D=function(o,r,t){for(var i=0;i<t.length;i++)o.setUint8(r+i,t.charCodeAt(i))};ko.exports=nt});function _o(o){let r="";for(let t=0;t<o.length;t+=3)r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[o[t]>>2],r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(o[t]&3)<<4|o[t+1]>>4],r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(o[t+1]&15)<<2|o[t+2]>>6],r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[o[t+2]&63];if(o.length%3===2)r=r.substring(0,r.length-1)+"=";else if(o.length%3===1)r=r.substring(0,r.length-2)+"==";return r}function To(o){let r=new Uint8Array(256);for(let n=0;n<"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".length;n++)r["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charCodeAt(n)]=n;let t=o.length*0.75;if(o[o.length-1]==="="){if(t--,o[o.length-2]==="=")t--}let i=new Uint8Array(t);for(let n=0,h=0;n<o.length;n+=4){let d=r[o.charCodeAt(n)],s=r[o.charCodeAt(n+1)],c=r[o.charCodeAt(n+2)],e=r[o.charCodeAt(n+3)];i[h++]=d<<2|s>>4,i[h++]=(s&15)<<4|c>>2,i[h++]=(c&3)<<6|e&63}return i}function Lo(o,r,t,i){if(["32f","64"].indexOf(r)>-1&&["32f","64"].indexOf(i)>-1){t.set(o);return}Ro(r),Ro(i);let n=_r(r,i),h={oldMin:Math.pow(2,parseInt(r,10))/2,newMin:Math.pow(2,parseInt(i,10))/2,oldMax:Math.pow(2,parseInt(r,10))/2-1,newMax:Math.pow(2,parseInt(i,10))/2-1};ao(r,o,!0);for(let d=0,s=o.length;d<s;d++)t[d]=n(o[d],h);ao(i,t,!1)}var Sr=function(o,r){if(o>0)o=parseInt(o/r.oldMax*r.newMax,10);else o=parseInt(o/r.oldMin*r.newMin,10);return o},Pr=function(o,r){return parseInt(o>0?o*r.newMax:o*r.newMin,10)},Ir=function(o,r){return o>0?o/r.oldMax:o/r.oldMin},_r=function(o,r){let t=function(i){return i};if(o!=r)if(["32f","64"].includes(o))t=Pr;else if(["32f","64"].includes(r))t=Ir;else t=Sr;return t},Ro=function(o){if(o!="32f"&&o!="64"&&(parseInt(o,10)<"8"||parseInt(o,10)>"53"))throw new Error("Invalid bit depth.")},ao=function(o,r,t){if(o=="8"){let i=t?-128:128;for(let n=0,h=r.length;n<h;n++)r[n]=r[n]+=i}};function Yo(o){let r={index:0,predicted:0,step:7},t=new Uint8Array(o.length),i=[],n=0,h=0;for(let s=0,c=o.length;s<c;s++){if(s%505==0&&s!=0)t.set(Tr(i,r),n),n+=256,i=[],h++;i.push(o[s])}let d=o.length/2;if(d%2)d++;return t.slice(0,d+512+h*4)}function qo(o,r=256){let t={index:0,predicted:0,step:7},i=new Int16Array(o.length*2),n=[],h=0;for(let d=0,s=o.length;d<s;d++){if(d%r==0&&d!=0){let c=Rr(n,t);i.set(c,h),h+=c.length,n=[]}n.push(o[d])}return i}var Tr=function(o,r){let t=Zr(o[0],r);for(let i=3,n=o.length;i<n;i+=2){let h=p(o[i],r),d=p(o[i+1],r);t.push(d<<4|h)}return t},Rr=function(o,r){r.predicted=ar(o[1]<<8|o[0]),r.index=o[2],r.step=oo[r.index];let t=[r.predicted,r.predicted];for(let i=4,n=o.length;i<n;i++){let h=o[i],d=h>>4,s=d<<4^h;t.push($o(s,r)),t.push($o(d,r))}return t},ar=function(o){return o>32768?o-65536:o},p=function(o,r){let t=o-r.predicted,i=0;if(t>=0)i=0;else i=8,t=-t;let n=oo[r.index],h=n>>3;if(t>n)i|=4,t-=n,h+=n;if(n>>=1,t>n)i|=2,t-=n,h+=n;if(n>>=1,t>n)i|=1,h+=n;return Lr(i,h,r),i},Lr=function(o,r,t){if(o&8)t.predicted-=r;else t.predicted+=r;if(t.predicted<-32768)t.predicted=-32768;else if(t.predicted>32767)t.predicted=32767;if(t.index+=Zo[o&7],t.index<0)t.index=0;else if(t.index>88)t.index=88},$o=function(o,r){let t=0;if(o&4)t+=r.step;if(o&2)t+=r.step>>1;if(o&1)t+=r.step>>2;if(t+=r.step>>3,o&8)t=-t;if(r.predicted+=t,r.predicted>32767)r.predicted=32767;else if(r.predicted<-32767)r.predicted=-32767;return $r(o,r),r.predicted},$r=function(o,r){if(r.index+=Zo[o],r.index<0)r.index=0;else if(r.index>88)r.index=88;r.step=oo[r.index]},Zr=function(o,r){p(o,r);let t=[];return t.push(o&255),t.push(o>>8&255),t.push(r.index),t.push(0),t},Zo=[-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8],oo=[7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767];function Br(o){let r;o=o==-32768?-32767:o;let t=~o>>8&128;if(!t)o=o*-1;if(o>32635)o=32635;if(o>=256){let i=qr[o>>8&127],n=o>>i+3&15;r=i<<4|n}else r=o>>4;return r^(t^85)}function zr(o){let r=0;if(o^=85,(o&128)!==0)o&=-129,r=-1;let t=((o&240)>>4)+4,i=0;if(t!=4)i=1<<t|(o&15)<<t-4|1<<t-5;else i=o<<1|1;return i=r===0?i:-i,i*8*-1}function Bo(o){let r=new Uint8Array(o.length);for(let t=0,i=o.length;t<i;t++)r[t]=Br(o[t]);return r}function zo(o){let r=new Int16Array(o.length);for(let t=0,i=o.length;t<i;t++)r[t]=zr(o[t]);return r}var qr=[1,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7];function Xr(o){let r,t,i,n;if(r=o>>8&128,r!=0)o=-o;if(o=o+132,o>32635)o=32635;return t=Kr[o>>7&255],i=o>>t+3&15,n=~(r|t<<4|i),n}function Vr(o){let r,t,i,n;if(o=~o,r=o&128,t=o>>4&7,i=o&15,n=Jr[t]+(i<<t+3),r!=0)n=-n;return n}function Qo(o){let r=new Uint8Array(o.length);for(let t=0,i=o.length;t<i;t++)r[t]=Xr(o[t]);return r}function Ko(o){let r=new Int16Array(o.length);for(let t=0,i=o.length;t<i;t++)r[t]=Vr(o[t]);return r}var Kr=[0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],Jr=[0,132,396,924,1980,4092,8316,16764];function ro(o,r,t=0,i=o.length){for(let n=t;n<i;n+=r)yr(o,r,n)}var yr=function(o,r,t){r--;for(let i=0;i<r;i++){let n=o[t+i];o[t+i]=o[t+r],o[t+r]=n,r--}};function Jo(o,r=0,t=o.length){let i="";for(let n=r;n<t;){let h=128,d=191,s=!1,c=o[n++];if(c>=0&&c<=127)i+=String.fromCharCode(c);else{let e=0;if(c>=194&&c<=223)e=1;else if(c>=224&&c<=239){if(e=2,o[n]===224)h=160;if(o[n]===237)d=159}else if(c>=240&&c<=244){if(e=3,o[n]===240)h=144;if(o[n]===244)d=143}else s=!0;c=c&(1<<8-e-1)-1;for(let l=0;l<e;l++){if(o[n]<h||o[n]>d)s=!0;c=c<<6|o[n]&63,n++}if(s)i+=String.fromCharCode(65533);else if(c<=65535)i+=String.fromCharCode(c);else c-=65536,i+=String.fromCharCode((c>>10&1023)+55296,(c&1023)+56320)}}return i}function to(o,r,t=0){let i=0,n=o.length;while(i<n){let h=o.codePointAt(i);if(h<128)r[t]=h,t++;else{let d=0,s=0;if(h<=2047)d=1,s=192;else if(h<=65535)d=2,s=224;else if(h<=1114111)d=3,s=240,i++;r[t]=(h>>6*d)+s,t++;while(d>0)r[t]=128|h>>6*(d-1)&63,t++,d--}i++}return t}class io{constructor(o,r=!1){if(this.bits=o,this.offset=Math.ceil(o/8),this.max=Math.pow(2,o)-1,this.min=0,this.unpack=this.unpack_,r)this.max=Math.pow(2,o)/2-1,this.min=-this.max-1,this.unpack=this.unpackSigned_}pack(o,r,t=0){r=this.clamp_(Math.round(r));for(let i=0,n=this.offset;i<n;i++)o[t]=Math.floor(r/Math.pow(2,i*8))&255,t++;return t}unpack_(o,r=0){let t=0;for(let i=0;i<this.offset;i++)t+=o[r+i]*Math.pow(256,i);return t}unpackSigned_(o,r=0){return this.sign_(this.unpack_(o,r))}clamp_(o){if(o>this.max)return this.max;else if(o<this.min)return this.min;return o}sign_(o){if(o>this.max)o-=this.max*2+2;return o}}var no=function(o){let r=Math.floor(o),t=o-r;if(t<0.5)return r;if(t>0.5)return r+1;return r%2?r+1:r};class V{constructor(o,r){this.offset=Math.ceil((o+r)/8),this.ebits=o,this.fbits=r,this.bias=(1<<o-1)-1,this.biasP2=Math.pow(2,this.bias+1),this.ebitsFbits=o+r,this.fbias=Math.pow(2,-(8*this.offset-1-o))}pack(o,r,t){if(Math.abs(r)>this.biasP2-this.ebitsFbits*2)r=r<0?-1/0:1/0;let i=((r=+r)||1/r)<0?1:r<0?1:0;r=Math.abs(r);let n=Math.min(Math.floor(Math.log(r)/Math.LN2),1023),h=no(r/Math.pow(2,n)*Math.pow(2,this.fbits));if(r!==r)h=Math.pow(2,this.fbits-1),n=(1<<this.ebits)-1;else if(r!==0)if(r>=Math.pow(2,1-this.bias)){if(h/Math.pow(2,this.fbits)>=2)n=n+1,h=1;if(n>this.bias)n=(1<<this.ebits)-1,h=0;else n=n+this.bias,h=no(h)-Math.pow(2,this.fbits)}else h=no(r/Math.pow(2,1-this.bias-this.fbits)),n=0;return this.packFloatBits_(o,t,i,n,h)}unpack(o,r){let t=(1<<this.ebits)-1,i,n="";for(let s=this.offset-1;s>=0;s--){let c=o[s+r].toString(2);n+="00000000".substring(c.length)+c}let h=n.charAt(0)=="1"?-1:1;n=n.substring(1);let d=parseInt(n.substring(0,this.ebits),2);if(n=n.substring(this.ebits),d==t){if(parseInt(n,2)!==0)return NaN;return h*(1/0)}else if(d===0)d+=1,i=parseInt(n,2);else i=parseInt("1"+n,2);return h*i*this.fbias*Math.pow(2,d-this.bias)}packFloatBits_(o,r,t,i,n){let h=[];h.push(t);for(let l=this.ebits;l>0;l-=1)h[l]=i%2?1:0,i=Math.floor(i/2);let d=h.length;for(let l=this.fbits;l>0;l-=1)h[d+l]=n%2?1:0,n=Math.floor(n/2);let s=h.join(""),c=this.offset+r-1,e=r;while(c>=r)o[c]=parseInt(s.substring(0,8),2),s=s.substring(8),c--,e++;return e}}function L(o,r=0,t=o.length){return Jo(o,r,t)}function O(o){let r=[];return to(o,r),r}function ho(o,r,t=0){return to(o,r,t)}function co(o,r,t,i=0){r=r||{};let n=Vo(r.bits,r.fp,r.signed),h=Math.ceil(r.bits/8),d=0,s=i;for(let c=o.length;d<c;d++)i=n.pack(t,o[d],i);if(r.be)ro(t,h,s,i);return i}function a(o,r,t,i=0,n=o.length){r=r||{};let h=Vo(r.bits,r.fp,r.signed);if(n=Dr(o,i,n,h.offset),r.be){let d=xr(o);if(r.be)ro(d,h.offset,i,n);Xo(d,t,i,n,h)}else Xo(o,t,i,n,h)}function J(o,r,t,i=0){return co([o],r,t,i)}function v(o,r){let t=[];return J(o,r,t,0),t}function $(o,r,t=0){let i=[];return a(o,r,i,t,t+Math.ceil(r.bits/8)),i[0]}var Xo=function(o,r,t,i,n){let h=n.offset;for(let d=0,s=t;s<i;s+=h,d++)r[d]=n.unpack(o,s)},xr=function(o){return new Uint8Array(o)},Dr=function(o,r,t,i){let n=(t-r)%i;return t-n},Vo=function(o,r,t){if(r&&o==32)return new V(8,23);else if(r&&o==64)return new V(11,52);return new io(o,t)};class so{constructor(){this.container="",this.chunkSize=0,this.format="",this.signature=null,this.head=0,this.uInt32={bits:32,be:!1},this.supported_containers=["RIFF","RIFX"]}setSignature(o){if(this.head=0,this.container=this.readString(o,4),this.supported_containers.indexOf(this.container)===-1)throw Error("Not a supported format.");this.uInt32.be=this.container==="RIFX",this.chunkSize=this.readUInt32(o),this.format=this.readString(o,4),this.signature={chunkId:this.container,chunkSize:this.chunkSize,format:this.format,subChunks:this.getSubChunksIndex_(o)}}findChunk(o,r=!1){let t=this.signature.subChunks,i=[];for(let n=0;n<t.length;n++)if(t[n].chunkId==o)if(r)i.push(t[n]);else return t[n];if(o=="LIST")return i.length?i:null;return null}readString(o,r){let t="";return t=L(o,this.head,this.head+r),this.head+=r,t}readUInt32(o){let r=$(o,this.uInt32,this.head);return this.head+=4,r}getSubChunksIndex_(o){let r=[],t=this.head;while(t<=o.length-8)r.push(this.getSubChunkIndex_(o,t)),t+=8+r[r.length-1].chunkSize,t=t%2?t+1:t;return r}getSubChunkIndex_(o,r){let t={chunkId:this.getChunkId_(o,r),chunkSize:this.getChunkSize_(o,r)};if(t.chunkId=="LIST")t.format=L(o,r+8,r+12),this.head+=4,t.subChunks=this.getSubChunksIndex_(o);else{let i=t.chunkSize%2?t.chunkSize+1:t.chunkSize;this.head=r+8+i,t.chunkData={start:r+8,end:this.head}}return t}getChunkId_(o,r){return this.head+=4,L(o,r,r+4)}getChunkSize_(o,r){return this.head+=4,$(o,this.uInt32,r+4)}}class j extends so{constructor(){super();this.supported_containers.push("RF64"),this.fmt={chunkId:"",chunkSize:0,audioFormat:0,numChannels:0,sampleRate:0,byteRate:0,blockAlign:0,bitsPerSample:0,cbSize:0,validBitsPerSample:0,dwChannelMask:0,subformat:[]},this.fact={chunkId:"",chunkSize:0,dwSampleLength:0},this.cue={chunkId:"",chunkSize:0,dwCuePoints:0,points:[]},this.smpl={chunkId:"",chunkSize:0,dwManufacturer:0,dwProduct:0,dwSamplePeriod:0,dwMIDIUnityNote:0,dwMIDIPitchFraction:0,dwSMPTEFormat:0,dwSMPTEOffset:0,dwNumSampleLoops:0,dwSamplerData:0,loops:[]},this.bext={chunkId:"",chunkSize:0,description:"",originator:"",originatorReference:"",originationDate:"",originationTime:"",timeReference:[0,0],version:0,UMID:"",loudnessValue:0,loudnessRange:0,maxTruePeakLevel:0,maxMomentaryLoudness:0,maxShortTermLoudness:0,reserved:"",codingHistory:""},this.iXML={chunkId:"",chunkSize:0,value:""},this.ds64={chunkId:"",chunkSize:0,riffSizeHigh:0,riffSizeLow:0,dataSizeHigh:0,dataSizeLow:0,originationTime:0,sampleCountHigh:0,sampleCountLow:0},this.data={chunkId:"",chunkSize:0,samples:new Uint8Array(0)},this.LIST=[],this.junk={chunkId:"",chunkSize:0,chunkData:[]},this._PMX={chunkId:"",chunkSize:0,value:""},this.uInt16={bits:16,be:!1,signed:!1,fp:!1}}fromBuffer(o,r=!0){if(this.clearHeaders(),this.setSignature(o),this.uInt16.be=this.uInt32.be,this.format!="WAVE")throw Error('Could not find the "WAVE" format identifier');this.readDs64Chunk_(o),this.readFmtChunk_(o),this.readFactChunk_(o),this.readBextChunk_(o),this.readiXMLChunk_(o),this.readCueChunk_(o),this.readSmplChunk_(o),this.readDataChunk_(o,r),this.readJunkChunk_(o),this.readLISTChunk_(o),this.read_PMXChunk_(o)}clearHeaders(){let o=new j;Object.assign(this.fmt,o.fmt),Object.assign(this.fact,o.fact),Object.assign(this.cue,o.cue),Object.assign(this.smpl,o.smpl),Object.assign(this.bext,o.bext),Object.assign(this.iXML,o.iXML),Object.assign(this.ds64,o.ds64),Object.assign(this.data,o.data),this.LIST=[],Object.assign(this.junk,o.junk),Object.assign(this._PMX,o._PMX)}readFmtChunk_(o){let r=this.findChunk("fmt ");if(r)this.head=r.chunkData.start,this.fmt.chunkId=r.chunkId,this.fmt.chunkSize=r.chunkSize,this.fmt.audioFormat=this.readUInt16_(o),this.fmt.numChannels=this.readUInt16_(o),this.fmt.sampleRate=this.readUInt32(o),this.fmt.byteRate=this.readUInt32(o),this.fmt.blockAlign=this.readUInt16_(o),this.fmt.bitsPerSample=this.readUInt16_(o),this.readFmtExtension_(o);else throw Error('Could not find the "fmt " chunk')}readFmtExtension_(o){if(this.fmt.chunkSize>16){if(this.fmt.cbSize=this.readUInt16_(o),this.fmt.chunkSize>18){if(this.fmt.validBitsPerSample=this.readUInt16_(o),this.fmt.chunkSize>20)this.fmt.dwChannelMask=this.readUInt32(o),this.fmt.subformat=[this.readUInt32(o),this.readUInt32(o),this.readUInt32(o),this.readUInt32(o)]}}}readFactChunk_(o){let r=this.findChunk("fact");if(r)this.head=r.chunkData.start,this.fact.chunkId=r.chunkId,this.fact.chunkSize=r.chunkSize,this.fact.dwSampleLength=this.readUInt32(o)}readCueChunk_(o){let r=this.findChunk("cue ");if(r){this.head=r.chunkData.start,this.cue.chunkId=r.chunkId,this.cue.chunkSize=r.chunkSize,this.cue.dwCuePoints=this.readUInt32(o);for(let t=0;t<this.cue.dwCuePoints;t++)this.cue.points.push({dwName:this.readUInt32(o),dwPosition:this.readUInt32(o),fccChunk:this.readString(o,4),dwChunkStart:this.readUInt32(o),dwBlockStart:this.readUInt32(o),dwSampleOffset:this.readUInt32(o)})}}readSmplChunk_(o){let r=this.findChunk("smpl");if(r){this.head=r.chunkData.start,this.smpl.chunkId=r.chunkId,this.smpl.chunkSize=r.chunkSize,this.smpl.dwManufacturer=this.readUInt32(o),this.smpl.dwProduct=this.readUInt32(o),this.smpl.dwSamplePeriod=this.readUInt32(o),this.smpl.dwMIDIUnityNote=this.readUInt32(o),this.smpl.dwMIDIPitchFraction=this.readUInt32(o),this.smpl.dwSMPTEFormat=this.readUInt32(o),this.smpl.dwSMPTEOffset=this.readUInt32(o),this.smpl.dwNumSampleLoops=this.readUInt32(o),this.smpl.dwSamplerData=this.readUInt32(o);for(let t=0;t<this.smpl.dwNumSampleLoops;t++)this.smpl.loops.push({dwName:this.readUInt32(o),dwType:this.readUInt32(o),dwStart:this.readUInt32(o),dwEnd:this.readUInt32(o),dwFraction:this.readUInt32(o),dwPlayCount:this.readUInt32(o)})}}readDataChunk_(o,r){let t=this.findChunk("data");if(t){if(this.data.chunkId="data",this.data.chunkSize=t.chunkSize,r)this.data.samples=o.slice(t.chunkData.start,t.chunkData.end)}else throw Error('Could not find the "data" chunk')}readBextChunk_(o){let r=this.findChunk("bext");if(r)this.head=r.chunkData.start,this.bext.chunkId=r.chunkId,this.bext.chunkSize=r.chunkSize,this.bext.description=this.readString(o,256),this.bext.originator=this.readString(o,32),this.bext.originatorReference=this.readString(o,32),this.bext.originationDate=this.readString(o,10),this.bext.originationTime=this.readString(o,8),this.bext.timeReference=[this.readUInt32(o),this.readUInt32(o)],this.bext.version=this.readUInt16_(o),this.bext.UMID=this.readString(o,64),this.bext.loudnessValue=this.readUInt16_(o),this.bext.loudnessRange=this.readUInt16_(o),this.bext.maxTruePeakLevel=this.readUInt16_(o),this.bext.maxMomentaryLoudness=this.readUInt16_(o),this.bext.maxShortTermLoudness=this.readUInt16_(o),this.bext.reserved=this.readString(o,180),this.bext.codingHistory=this.readString(o,this.bext.chunkSize-602)}readiXMLChunk_(o){let r=this.findChunk("iXML");if(r)this.head=r.chunkData.start,this.iXML.chunkId=r.chunkId,this.iXML.chunkSize=r.chunkSize,this.iXML.value=L(o,this.head,this.head+this.iXML.chunkSize)}readDs64Chunk_(o){let r=this.findChunk("ds64");if(r)this.head=r.chunkData.start,this.ds64.chunkId=r.chunkId,this.ds64.chunkSize=r.chunkSize,this.ds64.riffSizeHigh=this.readUInt32(o),this.ds64.riffSizeLow=this.readUInt32(o),this.ds64.dataSizeHigh=this.readUInt32(o),this.ds64.dataSizeLow=this.readUInt32(o),this.ds64.originationTime=this.readUInt32(o),this.ds64.sampleCountHigh=this.readUInt32(o),this.ds64.sampleCountLow=this.readUInt32(o);else if(this.container=="RF64")throw Error('Could not find the "ds64" chunk')}readLISTChunk_(o){let r=this.findChunk("LIST",!0);if(r!==null)for(let t=0;t<r.length;t++){let i=r[t];this.LIST.push({chunkId:i.chunkId,chunkSize:i.chunkSize,format:i.format,subChunks:[]});for(let n=0;n<i.subChunks.length;n++)this.readLISTSubChunks_(i.subChunks[n],i.format,o)}}readLISTSubChunks_(o,r,t){if(r=="adtl"){if(["labl","note","ltxt"].indexOf(o.chunkId)>-1)this.readLISTadtlSubChunks_(t,o)}else if(r=="INFO")this.readLISTINFOSubChunks_(t,o)}readLISTadtlSubChunks_(o,r){this.head=r.chunkData.start;let t={chunkId:r.chunkId,chunkSize:r.chunkSize,dwName:this.readUInt32(o)};if(r.chunkId=="ltxt")t.dwSampleLength=this.readUInt32(o),t.dwPurposeID=this.readUInt32(o),t.dwCountry=this.readUInt16_(o),t.dwLanguage=this.readUInt16_(o),t.dwDialect=this.readUInt16_(o),t.dwCodePage=this.readUInt16_(o),t.value="";else t.value=this.readZSTR_(o,this.head);this.LIST[this.LIST.length-1].subChunks.push(t)}readLISTINFOSubChunks_(o,r){this.head=r.chunkData.start,this.LIST[this.LIST.length-1].subChunks.push({chunkId:r.chunkId,chunkSize:r.chunkSize,value:this.readZSTR_(o,this.head)})}readJunkChunk_(o){let r=this.findChunk("junk");if(r)this.junk={chunkId:r.chunkId,chunkSize:r.chunkSize,chunkData:[].slice.call(o.slice(r.chunkData.start,r.chunkData.end))}}read_PMXChunk_(o){let r=this.findChunk("_PMX");if(r)this.head=r.chunkData.start,this._PMX.chunkId=r.chunkId,this._PMX.chunkSize=r.chunkSize,this._PMX.value=L(o,this.head,this.head+this._PMX.chunkSize)}readZSTR_(o,r=0){for(let t=r;t<o.length;t++)if(this.head++,o[t]===0)break;return L(o,r,this.head-1)}readUInt16_(o){let r=$(o,this.uInt16,this.head);return this.head+=2,r}}function I(o,r){let t=O(o);for(let i=t.length;i<r;i++)t.push(0);return t}class eo extends j{toBuffer(){this.uInt16.be=this.container==="RIFX",this.uInt32.be=this.uInt16.be;let o=[this.getJunkBytes_(),this.getDs64Bytes_(),this.getBextBytes_(),this.getiXMLBytes_(),this.getFmtBytes_(),this.getFactBytes_(),O(this.data.chunkId),v(this.data.samples.length,this.uInt32),this.data.samples,this.getCueBytes_(),this.getSmplBytes_(),this.getLISTBytes_(),this.get_PMXBytes_()],r=0;for(let n=0;n<o.length;n++)r+=o[n].length;let t=new Uint8Array(r+12),i=0;i=ho(this.container,t,i),i=J(r+4,this.uInt32,t,i),i=ho(this.format,t,i);for(let n=0;n<o.length;n++)t.set(o[n],i),i+=o[n].length;return t}getBextBytes_(){let o=[];if(this.enforceBext_(),this.bext.chunkId)this.bext.chunkSize=602+this.bext.codingHistory.length,o=o.concat(O(this.bext.chunkId),v(602+this.bext.codingHistory.length,this.uInt32),I(this.bext.description,256),I(this.bext.originator,32),I(this.bext.originatorReference,32),I(this.bext.originationDate,10),I(this.bext.originationTime,8),v(this.bext.timeReference[0],this.uInt32),v(this.bext.timeReference[1],this.uInt32),v(this.bext.version,this.uInt16),I(this.bext.UMID,64),v(this.bext.loudnessValue,this.uInt16),v(this.bext.loudnessRange,this.uInt16),v(this.bext.maxTruePeakLevel,this.uInt16),v(this.bext.maxMomentaryLoudness,this.uInt16),v(this.bext.maxShortTermLoudness,this.uInt16),I(this.bext.reserved,180),I(this.bext.codingHistory,this.bext.codingHistory.length));return this.enforceByteLen_(o),o}enforceBext_(){for(let o in this.bext)if(this.bext.hasOwnProperty(o)){if(this.bext[o]&&o!="timeReference"){this.bext.chunkId="bext";break}}if(this.bext.timeReference[0]||this.bext.timeReference[1])this.bext.chunkId="bext"}getiXMLBytes_(){let o=[];if(this.iXML.chunkId){let r=O(this.iXML.value);this.iXML.chunkSize=r.length,o=o.concat(O(this.iXML.chunkId),v(this.iXML.chunkSize,this.uInt32),r)}return this.enforceByteLen_(o),o}getDs64Bytes_(){let o=[];if(this.ds64.chunkId)o=o.concat(O(this.ds64.chunkId),v(this.ds64.chunkSize,this.uInt32),v(this.ds64.riffSizeHigh,this.uInt32),v(this.ds64.riffSizeLow,this.uInt32),v(this.ds64.dataSizeHigh,this.uInt32),v(this.ds64.dataSizeLow,this.uInt32),v(this.ds64.originationTime,this.uInt32),v(this.ds64.sampleCountHigh,this.uInt32),v(this.ds64.sampleCountLow,this.uInt32));return this.enforceByteLen_(o),o}getCueBytes_(){let o=[];if(this.cue.chunkId){let r=this.getCuePointsBytes_();o=o.concat(O(this.cue.chunkId),v(r.length+4,this.uInt32),v(this.cue.dwCuePoints,this.uInt32),r)}return this.enforceByteLen_(o),o}getCuePointsBytes_(){let o=[];for(let r=0;r<this.cue.dwCuePoints;r++)o=o.concat(v(this.cue.points[r].dwName,this.uInt32),v(this.cue.points[r].dwPosition,this.uInt32),O(this.cue.points[r].fccChunk),v(this.cue.points[r].dwChunkStart,this.uInt32),v(this.cue.points[r].dwBlockStart,this.uInt32),v(this.cue.points[r].dwSampleOffset,this.uInt32));return o}getSmplBytes_(){let o=[];if(this.smpl.chunkId){let r=this.getSmplLoopsBytes_();o=o.concat(O(this.smpl.chunkId),v(r.length+36,this.uInt32),v(this.smpl.dwManufacturer,this.uInt32),v(this.smpl.dwProduct,this.uInt32),v(this.smpl.dwSamplePeriod,this.uInt32),v(this.smpl.dwMIDIUnityNote,this.uInt32),v(this.smpl.dwMIDIPitchFraction,this.uInt32),v(this.smpl.dwSMPTEFormat,this.uInt32),v(this.smpl.dwSMPTEOffset,this.uInt32),v(this.smpl.dwNumSampleLoops,this.uInt32),v(this.smpl.dwSamplerData,this.uInt32),r)}return this.enforceByteLen_(o),o}getSmplLoopsBytes_(){let o=[];for(let r=0;r<this.smpl.dwNumSampleLoops;r++)o=o.concat(v(this.smpl.loops[r].dwName,this.uInt32),v(this.smpl.loops[r].dwType,this.uInt32),v(this.smpl.loops[r].dwStart,this.uInt32),v(this.smpl.loops[r].dwEnd,this.uInt32),v(this.smpl.loops[r].dwFraction,this.uInt32),v(this.smpl.loops[r].dwPlayCount,this.uInt32));return o}getFactBytes_(){let o=[];if(this.fact.chunkId)o=o.concat(O(this.fact.chunkId),v(this.fact.chunkSize,this.uInt32),v(this.fact.dwSampleLength,this.uInt32));return this.enforceByteLen_(o),o}getFmtBytes_(){let o=[];if(this.fmt.chunkId){let r=o.concat(O(this.fmt.chunkId),v(this.fmt.chunkSize,this.uInt32),v(this.fmt.audioFormat,this.uInt16),v(this.fmt.numChannels,this.uInt16),v(this.fmt.sampleRate,this.uInt32),v(this.fmt.byteRate,this.uInt32),v(this.fmt.blockAlign,this.uInt16),v(this.fmt.bitsPerSample,this.uInt16),this.getFmtExtensionBytes_());return this.enforceByteLen_(r),r}throw Error('Could not find the "fmt " chunk')}getFmtExtensionBytes_(){let o=[];if(this.fmt.chunkSize>16)o=o.concat(v(this.fmt.cbSize,this.uInt16));if(this.fmt.chunkSize>18)o=o.concat(v(this.fmt.validBitsPerSample,this.uInt16));if(this.fmt.chunkSize>20)o=o.concat(v(this.fmt.dwChannelMask,this.uInt32));if(this.fmt.chunkSize>24)o=o.concat(v(this.fmt.subformat[0],this.uInt32),v(this.fmt.subformat[1],this.uInt32),v(this.fmt.subformat[2],this.uInt32),v(this.fmt.subformat[3],this.uInt32));return o}getLISTBytes_(){let o=[];for(let r=0;r<this.LIST.length;r++){let t=this.getLISTSubChunksBytes_(this.LIST[r].subChunks,this.LIST[r].format);o=o.concat(O(this.LIST[r].chunkId),v(t.length+4,this.uInt32),O(this.LIST[r].format),t)}return this.enforceByteLen_(o),o}getLISTSubChunksBytes_(o,r){let t=[];for(let i=0,n=o.length;i<n;i++){if(r=="INFO")t=t.concat(this.getLISTINFOSubChunksBytes_(o[i]));else if(r=="adtl")t=t.concat(this.getLISTadtlSubChunksBytes_(o[i]));this.enforceByteLen_(t)}return t}getLISTINFOSubChunksBytes_(o){let r=[],t=I(o.value,o.value.length);return r=r.concat(O(o.chunkId),v(t.length+1,this.uInt32),t),r.push(0),r}getLISTadtlSubChunksBytes_(o){let r=[];if(["labl","note"].indexOf(o.chunkId)>-1){let t=I(o.value,o.value.length);r=r.concat(O(o.chunkId),v(t.length+4+1,this.uInt32),v(o.dwName,this.uInt32),t),r.push(0)}else if(o.chunkId=="ltxt")r=r.concat(this.getLtxtChunkBytes_(o));return r}getLtxtChunkBytes_(o){return[].concat(O(o.chunkId),v(o.value.length+20,this.uInt32),v(o.dwName,this.uInt32),v(o.dwSampleLength,this.uInt32),v(o.dwPurposeID,this.uInt32),v(o.dwCountry,this.uInt16),v(o.dwLanguage,this.uInt16),v(o.dwDialect,this.uInt16),v(o.dwCodePage,this.uInt16),I(o.value,o.value.length))}get_PMXBytes_(){let o=[];if(this._PMX.chunkId){let r=O(this._PMX.value);this._PMX.chunkSize=r.length,o=o.concat(O(this._PMX.chunkId),v(this._PMX.chunkSize,this.uInt32),r)}return this.enforceByteLen_(o),o}getJunkBytes_(){let o=[];if(this.junk.chunkId)return o.concat(O(this.junk.chunkId),v(this.junk.chunkData.length,this.uInt32),this.junk.chunkData);return this.enforceByteLen_(o),o}enforceByteLen_(o){if(o.length%2)o.push(0)}}function jo(o){let r=[];if(o.length>0)if(o[0].constructor!==Number){r=new Float64Array(o[0].length*o.length);for(let t=0,i=o[0].length,n=0;t<i;t++)for(let h=0,d=o.length;h<d;h++,n++)r[n]=o[h][t]}else r=o;return r}function yo(o,r,t=Float64Array){let i=[];for(let n=0;n<r;n++)i[n]=new t(o.length/r);for(let n=0;n<r;n++)for(let h=n,d=0;h<o.length;h+=r,d++)i[n][d]=o[h];return i}function xo(o,r){let t=o*r/8;if(o<1||t>65535)return!1;return!0}function y(o,r,t){let i=o*(r/8)*t;if(t<1||i>4294967295)return!1;return!0}var mr=function(o){let r=0;if(o===1)r=4;else if(o===2)r=3;else if(o===4)r=51;else if(o===6)r=63;else if(o===8)r=1599;return r};class vo extends eo{constructor(){super();this.bitDepth="0",this.dataType={bits:0,be:!1},this.WAV_AUDIO_FORMATS={"4":17,"8":1,"8a":6,"8m":7,"16":1,"24":1,"32":1,"32f":3,"64":3}}fromScratch(o,r,t,i,n){n=n||{},this.clearHeaders(),this.newWavFile_(o,r,t,i,n)}fromBuffer(o,r=!0){super.fromBuffer(o,r),this.bitDepthFromFmt_(),this.updateDataType_()}toBuffer(){return this.validateWavHeader_(),super.toBuffer()}getSamples(o=!1,r=Float64Array){let t=new r(this.data.samples.length/(this.dataType.bits/8));if(a(this.data.samples,this.dataType,t,0,this.data.samples.length),!o&&this.fmt.numChannels>1)return yo(t,this.fmt.numChannels,r);return t}getSample(o){if(o=o*(this.dataType.bits/8),o+this.dataType.bits/8>this.data.samples.length)throw new Error("Range error");return $(this.data.samples.slice(o,o+this.dataType.bits/8),this.dataType)}setSample(o,r){if(o=o*(this.dataType.bits/8),o+this.dataType.bits/8>this.data.samples.length)throw new Error("Range error");J(r,this.dataType,this.data.samples,o,!0)}getiXML(){return this.iXML.value}setiXML(o){if(typeof o!=="string")throw new TypeError("iXML value must be a string.");this.iXML.value=o,this.iXML.chunkId="iXML"}get_PMX(){return this._PMX.value}set_PMX(o){if(typeof o!=="string")throw new TypeError("_PMX value must be a string.");this._PMX.value=o,this._PMX.chunkId="_PMX"}newWavFile_(o,r,t,i,n){if(!n.container)n.container="RIFF";this.container=n.container,this.bitDepth=t,i=jo(i),this.updateDataType_();let h=this.dataType.bits/8;this.data.samples=new Uint8Array(i.length*h),co(i,this.dataType,this.data.samples,0,!0),this.makeWavHeader_(t,o,r,h,this.data.samples.length,n),this.data.chunkId="data",this.data.chunkSize=this.data.samples.length,this.validateWavHeader_()}makeWavHeader_(o,r,t,i,n,h){if(o=="4")this.createADPCMHeader_(o,r,t,i,n,h);else if(o=="8a"||o=="8m")this.createALawMulawHeader_(o,r,t,i,n,h);else if(Object.keys(this.WAV_AUDIO_FORMATS).indexOf(o)==-1||r>2)this.createExtensibleHeader_(o,r,t,i,n,h);else this.createPCMHeader_(o,r,t,i,n,h)}createPCMHeader_(o,r,t,i,n,h){this.container=h.container,this.chunkSize=36+n,this.format="WAVE",this.bitDepth=o,this.fmt={chunkId:"fmt ",chunkSize:16,audioFormat:this.WAV_AUDIO_FORMATS[o]||65534,numChannels:r,sampleRate:t,byteRate:r*i*t,blockAlign:r*i,bitsPerSample:parseInt(o,10),cbSize:0,validBitsPerSample:0,dwChannelMask:0,subformat:[]}}createADPCMHeader_(o,r,t,i,n,h){this.createPCMHeader_(o,r,t,i,n,h),this.chunkSize=40+n,this.fmt.chunkSize=20,this.fmt.byteRate=4055,this.fmt.blockAlign=256,this.fmt.bitsPerSample=4,this.fmt.cbSize=2,this.fmt.validBitsPerSample=505,this.fact={chunkId:"fact",chunkSize:4,dwSampleLength:n*2}}createExtensibleHeader_(o,r,t,i,n,h){this.createPCMHeader_(o,r,t,i,n,h),this.chunkSize=60+n,this.fmt.chunkSize=40,this.fmt.bitsPerSample=(parseInt(o,10)-1|7)+1,this.fmt.cbSize=22,this.fmt.validBitsPerSample=parseInt(o,10),this.fmt.dwChannelMask=mr(r),this.fmt.subformat=[1,1048576,2852126848,1905997824]}createALawMulawHeader_(o,r,t,i,n,h){this.createPCMHeader_(o,r,t,i,n,h),this.chunkSize=40+n,this.fmt.chunkSize=20,this.fmt.cbSize=2,this.fmt.validBitsPerSample=8,this.fact={chunkId:"fact",chunkSize:4,dwSampleLength:n}}bitDepthFromFmt_(){if(this.fmt.audioFormat===3&&this.fmt.bitsPerSample===32)this.bitDepth="32f";else if(this.fmt.audioFormat===6)this.bitDepth="8a";else if(this.fmt.audioFormat===7)this.bitDepth="8m";else this.bitDepth=this.fmt.bitsPerSample.toString()}validateBitDepth_(){if(!this.WAV_AUDIO_FORMATS[this.bitDepth]){if(parseInt(this.bitDepth,10)>8&&parseInt(this.bitDepth,10)<54)return!0;throw new Error("Invalid bit depth.")}return!0}updateDataType_(){if(this.dataType={bits:(parseInt(this.bitDepth,10)-1|7)+1,fp:this.bitDepth=="32f"||this.bitDepth=="64",signed:this.bitDepth!="8",be:this.container=="RIFX"},["4","8a","8m"].indexOf(this.bitDepth)>-1)this.dataType.bits=8,this.dataType.signed=!1}validateWavHeader_(){if(this.validateBitDepth_(),!xo(this.fmt.numChannels,this.fmt.bitsPerSample))throw new Error("Invalid number of channels.");if(!y(this.fmt.numChannels,this.fmt.bitsPerSample,this.fmt.sampleRate))throw new Error("Invalid sample rate.")}}var kr=function(o){if(o.constructor!==String)throw new Error("Invalid tag name.");else if(o.length<4)for(let r=0,t=4-o.length;r<t;r++)o+=" ";return o};class lo extends vo{getTag(o){let r=this.getTagIndex_(o);if(r.TAG!==null)return this.LIST[r.LIST].subChunks[r.TAG].value;return null}setTag(o,r){o=kr(o);let t=this.getTagIndex_(o);if(t.TAG!==null)this.LIST[t.LIST].subChunks[t.TAG].chunkSize=r.length+1,this.LIST[t.LIST].subChunks[t.TAG].value=r;else if(t.LIST!==null)this.LIST[t.LIST].subChunks.push({chunkId:o,chunkSize:r.length+1,value:r});else this.LIST.push({chunkId:"LIST",chunkSize:8+r.length+1,format:"INFO",subChunks:[]}),this.LIST[this.LIST.length-1].subChunks.push({chunkId:o,chunkSize:r.length+1,value:r})}deleteTag(o){let r=this.getTagIndex_(o);if(r.TAG!==null)return this.LIST[r.LIST].subChunks.splice(r.TAG,1),!0;return!1}listTags(){let o=this.getLISTIndex("INFO"),r={};if(o!==null)for(let t=0,i=this.LIST[o].subChunks.length;t<i;t++)r[this.LIST[o].subChunks[t].chunkId]=this.LIST[o].subChunks[t].value;return r}getLISTIndex(o){for(let r=0,t=this.LIST.length;r<t;r++)if(this.LIST[r].format==o)return r;return null}getTagIndex_(o){let r={LIST:null,TAG:null};for(let t=0,i=this.LIST.length;t<i;t++)if(this.LIST[t].format=="INFO"){r.LIST=t;for(let n=0,h=this.LIST[t].subChunks.length;n<h;n++)if(this.LIST[t].subChunks[n].chunkId==o){r.TAG=n;break}break}return r}}class x extends lo{listCuePoints(){let o=this.getCuePoints_();for(let r=0,t=o.length;r<t;r++){if(o[r].position=o[r].dwSampleOffset/this.fmt.sampleRate*1000,o[r].dwSampleLength)o[r].end=o[r].dwSampleLength/this.fmt.sampleRate*1000,o[r].end+=o[r].position;else o[r].end=null;delete o[r].value}return o}setCuePoint(o){if(this.cue.chunkId="cue ",!o.label)o.label="";let r=this.getCuePoints_();if(this.clearLISTadtl_(),this.cue.points=[],o.dwSampleOffset=o.position*this.fmt.sampleRate/1000,o.dwSampleLength=0,o.end)o.dwSampleLength=o.end*this.fmt.sampleRate/1000-o.dwSampleOffset;if(r.length===0)this.setCuePoint_(o,1);else this.setCuePointInOrder_(r,o);this.cue.dwCuePoints=this.cue.points.length}deleteCuePoint(o){this.cue.chunkId="cue ";let r=this.getCuePoints_();this.clearLISTadtl_();let t=this.cue.points.length;this.cue.points=[];for(let i=0;i<t;i++)if(i+1!==o)this.setCuePoint_(r[i],i+1);if(this.cue.dwCuePoints=this.cue.points.length,this.cue.dwCuePoints)this.cue.chunkId="cue ";else this.cue.chunkId="",this.clearLISTadtl_()}updateLabel(o,r){let t=this.getLISTIndex("adtl");if(t!==null){for(let i=0,n=this.LIST[t].subChunks.length;i<n;i++)if(this.LIST[t].subChunks[i].dwName==o)this.LIST[t].subChunks[i].value=r}}getCuePoints_(){let o=[];for(let r=0;r<this.cue.points.length;r++){let t=this.cue.points[r],i=this.getDataForCuePoint_(t.dwName);i.label=i.value?i.value:"",i.dwPosition=t.dwPosition,i.fccChunk=t.fccChunk,i.dwChunkStart=t.dwChunkStart,i.dwBlockStart=t.dwBlockStart,i.dwSampleOffset=t.dwSampleOffset,o.push(i)}return o}getDataForCuePoint_(o){let r=this.getLISTIndex("adtl"),t={};if(r!==null)this.getCueDataFromLIST_(t,r,o);return t}getCueDataFromLIST_(o,r,t){for(let i=0,n=this.LIST[r].subChunks.length;i<n;i++)if(this.LIST[r].subChunks[i].dwName==t){let h=this.LIST[r].subChunks[i];o.value=h.value||o.value,o.dwName=h.dwName||0,o.dwSampleLength=h.dwSampleLength||0,o.dwPurposeID=h.dwPurposeID||0,o.dwCountry=h.dwCountry||0,o.dwLanguage=h.dwLanguage||0,o.dwDialect=h.dwDialect||0,o.dwCodePage=h.dwCodePage||0}}setCuePoint_(o,r){this.cue.points.push({dwName:r,dwPosition:o.dwPosition?o.dwPosition:0,fccChunk:o.fccChunk?o.fccChunk:"data",dwChunkStart:o.dwChunkStart?o.dwChunkStart:0,dwBlockStart:o.dwBlockStart?o.dwBlockStart:0,dwSampleOffset:o.dwSampleOffset}),this.setLabl_(o,r)}setCuePointInOrder_(o,r){let t=!1;for(let i=0;i<o.length;i++)if(o[i].dwSampleOffset>r.dwSampleOffset&&!t)this.setCuePoint_(r,i+1),this.setCuePoint_(o[i],i+2),t=!0;else this.setCuePoint_(o[i],t?i+2:i+1);if(!t)this.setCuePoint_(r,this.cue.points.length+1)}clearLISTadtl_(){for(let o=0,r=this.LIST.length;o<r;o++)if(this.LIST[o].format=="adtl")this.LIST.splice(o)}setLabl_(o,r){let t=this.getLISTIndex("adtl");if(t===null)this.LIST.push({chunkId:"LIST",chunkSize:4,format:"adtl",subChunks:[]}),t=this.LIST.length-1;if(this.setLabelText_(t,o,r),o.dwSampleLength)this.setLtxtChunk_(t,o,r)}setLabelText_(o,r,t){this.LIST[o].subChunks.push({chunkId:"labl",chunkSize:4,dwName:t,value:r.label}),this.LIST[o].chunkSize+=12}setLtxtChunk_(o,r,t){this.LIST[o].subChunks.push({chunkId:"ltxt",chunkSize:20,dwName:t,dwSampleLength:r.dwSampleLength,dwPurposeID:r.dwPurposeID||0,dwCountry:r.dwCountry||0,dwLanguage:r.dwLanguage||0,dwDialect:r.dwDialect||0,dwCodePage:r.dwCodePage||0,value:r.label}),this.LIST[o].chunkSize+=28}}var br=function(o){return Math.exp(-o/2*o/2)},fr=function(o){return function(r){return pr(r)*o(r)}},pr=function(o){if(o===0)return 1;return Math.sin(Math.PI*o)/(Math.PI*o)};class go{constructor(o,r,t){if(this.length_=o,this.scaleFactor_=(o-1)/r,this.interpolate=this.sinc,t.method==="point")this.interpolate=this.point;else if(t.method==="linear")this.interpolate=this.linear;else if(t.method==="cubic")this.interpolate=this.cubic;this.tangentFactor_=1-Math.max(0,Math.min(1,t.tension||0)),this.sincFilterSize_=t.sincFilterSize||1,this.kernel_=fr(t.sincWindow||br)}point(o,r){return this.getClippedInput_(Math.round(this.scaleFactor_*o),r)}linear(o,r){o=this.scaleFactor_*o;let t=Math.floor(o);return o-=t,(1-o)*this.getClippedInput_(t,r)+o*this.getClippedInput_(t+1,r)}cubic(o,r){o=this.scaleFactor_*o;let t=Math.floor(o),i=[this.getTangent_(t,r),this.getTangent_(t+1,r)],n=[this.getClippedInput_(t,r),this.getClippedInput_(t+1,r)];o-=t;let h=o*o,d=o*h;return(2*d-3*h+1)*n[0]+(d-2*h+o)*i[0]+(-2*d+3*h)*n[1]+(d-h)*i[1]}sinc(o,r){o=this.scaleFactor_*o;let t=Math.floor(o),i=t-this.sincFilterSize_+1,n=t+this.sincFilterSize_,h=0;for(let d=i;d<=n;d++)h+=this.kernel_(o-d)*this.getClippedInput_(d,r);return h}getTangent_(o,r){return this.tangentFactor_*(this.getClippedInput_(o+1,r)-this.getClippedInput_(o-1,r))/2}getClippedInput_(o,r){if(0<=o&&o<this.length_)return r[o];return 0}}class wo{constructor(o,r,t){let i=2*Math.PI*t/r,n=0;this.filters=[];for(let h=0;h<=o;h++){if(h-o/2===0)this.filters[h]=i;else this.filters[h]=Math.sin(i*(h-o/2))/(h-o/2),this.filters[h]*=0.54-0.46*Math.cos(2*Math.PI*h/o);n=n+this.filters[h]}for(let h=0;h<=o;h++)this.filters[h]/=n;this.z=this.initZ_()}filter(o){this.z.buf[this.z.pointer]=o;let r=0;for(let t=0,i=this.z.buf.length;t<i;t++)r+=this.filters[t]*this.z.buf[(this.z.pointer+t)%this.z.buf.length];return this.z.pointer=(this.z.pointer+1)%this.z.buf.length,r}reset(){this.z=this.initZ_()}initZ_(){let o=[];for(let r=0;r<this.filters.length-1;r++)o.push(0);return{buf:o,pointer:0}}}class Eo{constructor(o,r,t){let i=[];for(let n=0;n<o;n++)i.push(this.getCoeffs_({Fs:r,Fc:t,Q:0.5/Math.sin(Math.PI/(o*2)*(n+0.5))}));this.stages=[];for(let n=0;n<i.length;n++)this.stages[n]={b0:i[n].b[0],b1:i[n].b[1],b2:i[n].b[2],a1:i[n].a[0],a2:i[n].a[1],k:i[n].k,z:[0,0]}}filter(o){let r=o;for(let t=0,i=this.stages.length;t<i;t++)r=this.runStage_(t,r);return r}getCoeffs_(o){let r={};r.a=[],r.b=[];let t=this.preCalc_(o,r);return r.k=1,r.b.push((1-t.cw)/(2*t.a0)),r.b.push(2*r.b[0]),r.b.push(r.b[0]),r}preCalc_(o,r){let t={},i=2*Math.PI*o.Fc/o.Fs;return t.alpha=Math.sin(i)/(2*o.Q),t.cw=Math.cos(i),t.a0=1+t.alpha,r.a0=t.a0,r.a.push(-2*t.cw/t.a0),r.k=1,r.a.push((1-t.alpha)/t.a0),t}runStage_(o,r){let t=r*this.stages[o].k-this.stages[o].a1*this.stages[o].z[0]-this.stages[o].a2*this.stages[o].z[1],i=this.stages[o].b0*t+this.stages[o].b1*this.stages[o].z[0]+this.stages[o].b2*this.stages[o].z[1];return this.stages[o].z[1]=this.stages[o].z[0],this.stages[o].z[0]=t,i}reset(){for(let o=0;o<this.stages.length;o++)this.stages[o].z=[0,0]}}function Ao(o,r,t,i=null){i=i||{};let n=(t-r)/r+1,h=new Float64Array(o.length*n);i.method=i.method||"cubic";let d=new go(o.length,h.length,{method:i.method,tension:i.tension||0,sincFilterSize:i.sincFilterSize||6,sincWindow:i.sincWindow||void 0,clip:i.clip||"mirror"});if(i.LPF===void 0)i.LPF=ot[i.method];if(i.LPF){i.LPFType=i.LPFType||"IIR";const s=rt[i.LPFType];if(t>r){let c=new s(i.LPForder||Do[i.LPFType],t,r/2);tt(o,h,d,c)}else{let c=new s(i.LPForder||Do[i.LPFType],r,t/2);it(o,h,d,c)}}else mo(o,h,d);return h}var mo=function(o,r,t){for(let i=0,n=r.length;i<n;i++)r[i]=t.interpolate(i,o)},tt=function(o,r,t,i){for(let n=0,h=r.length;n<h;n++)r[n]=i.filter(t.interpolate(n,o));i.reset();for(let n=r.length-1;n>=0;n--)r[n]=i.filter(r[n])},it=function(o,r,t,i){for(let n=0,h=o.length;n<h;n++)o[n]=i.filter(o[n]);i.reset();for(let n=o.length-1;n>=0;n--)o[n]=i.filter(o[n]);mo(o,r,t)},ot={point:!1,linear:!1,cubic:!0,sinc:!0},Do={IIR:16,FIR:71},rt={IIR:Eo,FIR:wo};var X=function(o,r){let t=o/r;if(t%2)t++;return t};class Mo extends x{toRIFF(){let o=new Float64Array(X(this.data.samples.length,this.dataType.bits/8));a(this.data.samples,this.dataType,o,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,this.bitDepth,o,{container:"RIFF"})}toRIFX(){let o=new Float64Array(X(this.data.samples.length,this.dataType.bits/8));a(this.data.samples,this.dataType,o,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,this.bitDepth,o,{container:"RIFX"})}toIMAADPCM(){if(this.fmt.sampleRate!==8000)throw new Error("Only 8000 Hz files can be compressed as IMA-ADPCM.");else if(this.fmt.numChannels!==1)throw new Error("Only mono files can be compressed as IMA-ADPCM.");else{this.assure16Bit_();let o=new Int16Array(X(this.data.samples.length,2));a(this.data.samples,this.dataType,o,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"4",Yo(o),{container:this.correctContainer_()})}}fromIMAADPCM(o="16"){if(this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"16",qo(this.data.samples,this.fmt.blockAlign),{container:this.correctContainer_()}),o!="16")this.toBitDepth(o)}toALaw(){this.assure16Bit_();let o=new Int16Array(X(this.data.samples.length,2));a(this.data.samples,this.dataType,o,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"8a",Bo(o),{container:this.correctContainer_()})}fromALaw(o="16"){if(this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"16",zo(this.data.samples),{container:this.correctContainer_()}),o!="16")this.toBitDepth(o)}toMuLaw(){this.assure16Bit_();let o=new Int16Array(X(this.data.samples.length,2));a(this.data.samples,this.dataType,o,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"8m",Qo(o),{container:this.correctContainer_()})}fromMuLaw(o="16"){if(this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"16",Ko(this.data.samples),{container:this.correctContainer_()}),o!="16")this.toBitDepth(o)}toBitDepth(o,r=!0){let t=o,i=this.bitDepth;if(!r){if(o!="32f")t=this.dataType.bits.toString();i=""+this.dataType.bits}this.assureUncompressed_();let n=this.getSamples(!0),h=new Float64Array(n.length);Lo(n,i,h,t),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,o,h,{container:this.correctContainer_()})}toSampleRate(o,r){this.validateResample_(o);let t=this.getSamples(),i=[];if(t.constructor===Float64Array)i=Ao(t,this.fmt.sampleRate,o,r);else for(let n=0;n<t.length;n++)i.push(Ao(t[n],this.fmt.sampleRate,o,r));this.fromExisting_(this.fmt.numChannels,o,this.bitDepth,i,{container:this.correctContainer_()})}validateResample_(o){if(!y(this.fmt.numChannels,this.fmt.bitsPerSample,o))throw new Error("Invalid sample rate.");else if(["4","8a","8m"].indexOf(this.bitDepth)>-1)throw new Error("wavefile can\'t change the sample rate of compressed files.")}assure16Bit_(){if(this.assureUncompressed_(),this.bitDepth!="16")this.toBitDepth("16")}assureUncompressed_(){if(this.bitDepth=="8a")this.fromALaw();else if(this.bitDepth=="8m")this.fromMuLaw();else if(this.bitDepth=="4")this.fromIMAADPCM()}correctContainer_(){return this.container=="RF64"?"RIFF":this.container}fromExisting_(o,r,t,i,n){let h=new x;Object.assign(this.fmt,h.fmt),Object.assign(this.fact,h.fact),Object.assign(this.ds64,h.ds64),Object.assign(this.data,h.data),this.newWavFile_(o,r,t,i,n)}}class q extends Mo{constructor(o){super();if(o)this.fromBuffer(o)}fromBase64(o){this.fromBuffer(To(o))}toBase64(){return _o(this.toBuffer())}toDataURI(){return"data:audio/wav;base64,"+this.toBase64()}fromDataURI(o){this.fromBase64(o.replace("data:audio/wav;base64,",""))}}import{useState as Lt} from"preact/hooks";import{useEditor as $t} from"@blockcode/core";import{useState as At} from"preact/hooks";import{useLocale as Mt,useLayout as Ct,useEditor as Nt} from"@blockcode/core";import{IconSelector as Ht,ActionButton as Ot} from"@blockcode/ui";var fo=ur(bo(),1);function po(o){return new Promise(async(r,t)=>{const i=new FileReader;i.readAsArrayBuffer(o),i.addEventListener("load",()=>{const n=new q;try{n.fromBuffer(new Uint8Array(i.result)),n.toBitDepth(8),n.toSampleRate(11025)}catch(h){t(h)}r(n)})})}async function or(o){const r=new q,i=await new AudioContext().decodeAudioData(await o.arrayBuffer());return r.fromBuffer(new Uint8Array(fo.default(i))),r.toBitDepth(8),r.toSampleRate(11025),r}async function rr(o){const t=await(await fetch(o,{})).arrayBuffer(),i=new q;return i.fromBuffer(new Uint8Array(t)),i}function Co(o){const r=Math.floor(o/60),t=Math.floor(o%60);return`${r}:${`00${t}`.slice(-2)}.${o.toFixed(3).slice(-3)}`}function B(o=32){const r=[];for(let t=0;t<o;t++)r[t]="0123456789abcdefghijklmnopqrstuvwxyz".charAt(Math.random()*"0123456789abcdefghijklmnopqrstuvwxyz".length);return r.join("")}function Z(o){const r=globalThis.document,t=r.createElement("style");t.appendChild(r.createTextNode(o)),r.head.append(t)}Z("._5PgNba_selector-wrapper{background:var(--ui-secondary);width:150px;position:relative}._5PgNba_selector-items-wrapper{width:150px;min-height:100%;padding-bottom:100px}._5PgNba_selector-item{width:5rem;height:5rem;margin:.5rem auto}._5PgNba_delete-menu-item:hover{background:var(--error-primary)}._5PgNba_add-button-wrapper{background:linear-gradient(transparent,var(--ui-secondary));width:100%;height:100px;display:flex;position:absolute;bottom:0;left:0;right:0}._5PgNba_add-button{margin:.75rem auto}");var Y={selectorWrapper:"_5PgNba_selector-wrapper",addButton:"_5PgNba_add-button",selectorItem:"_5PgNba_selector-item",selectorItemsWrapper:"_5PgNba_selector-items-wrapper",addButtonWrapper:"_5PgNba_add-button-wrapper",deleteMenuItem:"_5PgNba_delete-menu-item"};var tr="./assets/icon-thumb-a541e14895441e52.svg";var ir="./assets/icon-sound-14bb688cabf50625.svg";var nr="./assets/icon-search-da6ddbb0d3689046.svg";var z="./assets/icon-record-f368333f0c930073.svg";var hr="./assets/icon-surprise-8aa9e285645a254d.svg";var dr="./assets/icon-file-upload-8698118c8522bf00.svg";import{jsx as m,jsxs as Wt} from"preact/jsx-runtime";function No({soundList:o,soundIndex:r,onSelect:t,onSetupLibrary:i}){const[n,h]=At(!1),{getText:d}=Mt(),{createAlert:s,removeAlert:c}=Ct(),{addAsset:e,deleteAsset:l}=Nt(),{SoundsLibrary:g}=i(),w=()=>h(!0),E=()=>h(!1),N=async(C)=>{const M=B();s("importing",{id:M});const F=await rr(`./assets/${C.id}.wav`);e({...C,id:M,type:"audio/wav",data:F.toBase64(),sampleCount:F.data.chunkSize}),c(M),t(o.length)},u=()=>N(g.surprise()),U=()=>{const C=document.createElement("input");C.type="file",C.accept="audio/wav",C.multiple=!0,C.click(),C.addEventListener("change",async(M)=>{const F=B();s("importing",{id:F});try{for(let S of M.target.files){const T=B(),R=S.name.slice(0,S.name.lastIndexOf(".")),P=await po(S);console.log(P),e({id:T,type:S.type,name:R,data:P.toBase64(),rate:P.fmt.sampleRate,sampleCount:P.data.chunkSize})}c(F)}catch(S){s({id:F,message:d("waveSurfer.error.formatNotSupperted","This wav format is not supported.")},2000)}})},G=()=>{e({id:B(),type:"audio/wav",name:d("waveSurfer.surfer.sound","Sound"),data:"UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAABErAAABAAgAZGF0YQAAAAA=",rate:11025,sampleCount:0,record:!0}),t(o.length)},A=(C)=>{l(o[C].id)};return Wt("div",{className:Y.selectorWrapper,children:[m(Ht,{displayOrder:!0,id:"paint-selector",className:Y.selectorItemsWrapper,items:o.map((C,M)=>({...C,details:`${Co(C.sampleCount/C.rate||0)}`,icon:tr,order:M,className:Y.selectorItem,contextMenu:[[{label:d("waveSurfer.contextMenu.export","export"),disabled:!0}],[{label:d("waveSurfer.contextMenu.delete","delete"),className:Y.deleteMenuItem,disabled:o.length<=1,onClick:()=>A(M)}]]})),selectedIndex:r,onSelect:t,onDelete:A}),m("div",{className:Y.addButtonWrapper,children:m(Ot,{tooltipPlacement:"right",className:Y.addButton,icon:ir,tooltip:d("waveSurfer.actionButton.sound","Choose a Sound"),onClick:w,moreButtons:[{icon:dr,tooltip:d("waveSurfer.actionButton.upload","Upload Sound"),onClick:U},{icon:hr,tooltip:d("waveSurfer.actionButton.surprise","Surprise"),onClick:u},{icon:z,tooltip:d("waveSurfer.actionButton.record","Record"),onClick:G},{icon:nr,tooltip:d("waveSurfer.actionButton.sound","Choose a Sound"),onClick:w}]})}),n&&g&&m(g,{onClose:E,onSelect:N})]})}var W=function(o,r,t,i){return new(t||(t=Promise))(function(n,h){function d(e){try{c(i.next(e))}catch(l){h(l)}}function s(e){try{c(i.throw(e))}catch(l){h(l)}}function c(e){var l;e.done?n(e.value):(l=e.value,l instanceof t?l:new t(function(g){g(l)})).then(d,s)}c((i=i.apply(o,r||[])).next())})},er=function(o,r){const t=r.xmlns?document.createElementNS(r.xmlns,o):document.createElement(o);for(let[i,n]of Object.entries(r))if(i==="children")for(let[h,d]of Object.entries(r))typeof d=="string"?t.appendChild(document.createTextNode(d)):t.appendChild(er(h,d));else i==="style"?Object.assign(t.style,n):i==="textContent"?t.textContent=n:t.setAttribute(i,n.toString());return t},sr=function(o,r,t){const i=er(o,r||{});return t==null||t.appendChild(i),i};class K{constructor(){this.listeners={}}on(o,r,t){if(this.listeners[o]||(this.listeners[o]=new Set),this.listeners[o].add(r),t==null?void 0:t.once){const i=()=>{this.un(o,i),this.un(o,r)};return this.on(o,i),i}return()=>this.un(o,r)}un(o,r){var t;(t=this.listeners[o])===null||t===void 0||t.delete(r)}once(o,r){return this.on(o,r,{once:!0})}unAll(){this.listeners={}}emit(o,...r){this.listeners[o]&&this.listeners[o].forEach((t)=>t(...r))}}var cr={decode:function(o,r){return W(this,void 0,void 0,function*(){const t=new AudioContext({sampleRate:r});return t.decodeAudioData(o).finally(()=>t.close())})},createBuffer:function(o,r){return typeof o[0]=="number"&&(o=[o]),function(t){const i=t[0];if(i.some((n)=>n>1||n<-1)){const n=i.length;let h=0;for(let d=0;d<n;d++){const s=Math.abs(i[d]);s>h&&(h=s)}for(let d of t)for(let s=0;s<n;s++)d[s]/=h}}(o),{duration:r,length:o[0].length,sampleRate:o[0].length/r,numberOfChannels:o.length,getChannelData:(t)=>o==null?void 0:o[t],copyFromChannel:AudioBuffer.prototype.copyFromChannel,copyToChannel:AudioBuffer.prototype.copyToChannel}}},Gt=Object.freeze({__proto__:null,createElement:sr,default:sr}),Ut={fetchBlob:function(o,r,t){return W(this,void 0,void 0,function*(){const i=yield fetch(o,t);if(i.status>=400)throw new Error(`Failed to fetch ${o}: ${i.status} (${i.statusText})`);return function(n,h){W(this,void 0,void 0,function*(){if(!n.body||!n.headers)return;const d=n.body.getReader(),s=Number(n.headers.get("Content-Length"))||0;let c=0;const e=(g)=>W(this,void 0,void 0,function*(){c+=(g==null?void 0:g.length)||0;const w=Math.round(c/s*100);h(w)}),l=()=>W(this,void 0,void 0,function*(){let g;try{g=yield d.read()}catch(w){return}g.done||(e(g.value),yield l())});l()})}(i.clone(),r),i.blob()})}};class vr extends K{constructor(o){super(),this.isExternalMedia=!1,o.media?(this.media=o.media,this.isExternalMedia=!0):this.media=document.createElement("audio"),o.mediaControls&&(this.media.controls=!0),o.autoplay&&(this.media.autoplay=!0),o.playbackRate!=null&&this.onMediaEvent("canplay",()=>{o.playbackRate!=null&&(this.media.playbackRate=o.playbackRate)},{once:!0})}onMediaEvent(o,r,t){return this.media.addEventListener(o,r,t),()=>this.media.removeEventListener(o,r,t)}getSrc(){return this.media.currentSrc||this.media.src||""}revokeSrc(){const o=this.getSrc();o.startsWith("blob:")&&URL.revokeObjectURL(o)}canPlayType(o){return this.media.canPlayType(o)!==""}setSrc(o,r){if(this.getSrc()===o)return;this.revokeSrc();const t=r instanceof Blob&&this.canPlayType(r.type)?URL.createObjectURL(r):o;this.media.src=t}destroy(){this.media.pause(),this.isExternalMedia||(this.media.remove(),this.revokeSrc(),this.media.src="",this.media.load())}setMediaElement(o){this.media=o}play(){return W(this,void 0,void 0,function*(){return this.media.play()})}pause(){this.media.pause()}isPlaying(){return!this.media.paused&&!this.media.ended}setTime(o){this.media.currentTime=o}getDuration(){return this.media.duration}getCurrentTime(){return this.media.currentTime}getVolume(){return this.media.volume}setVolume(o){this.media.volume=o}getMuted(){return this.media.muted}setMuted(o){this.media.muted=o}getPlaybackRate(){return this.media.playbackRate}isSeeking(){return this.media.seeking}setPlaybackRate(o,r){r!=null&&(this.media.preservesPitch=r),this.media.playbackRate=o}getMediaElement(){return this.media}setSinkId(o){return this.media.setSinkId(o)}}class k extends K{constructor(o,r){super(),this.timeouts=[],this.isScrollable=!1,this.audioData=null,this.resizeObserver=null,this.lastContainerWidth=0,this.isDragging=!1,this.subscriptions=[],this.subscriptions=[],this.options=o;const t=this.parentFromOptionsContainer(o.container);this.parent=t;const[i,n]=this.initHtml();t.appendChild(i),this.container=i,this.scrollContainer=n.querySelector(".scroll"),this.wrapper=n.querySelector(".wrapper"),this.canvasWrapper=n.querySelector(".canvases"),this.progressWrapper=n.querySelector(".progress"),this.cursor=n.querySelector(".cursor"),r&&n.appendChild(r),this.initEvents()}parentFromOptionsContainer(o){let r;if(typeof o=="string"?r=document.querySelector(o):o instanceof HTMLElement&&(r=o),!r)throw new Error("Container not found");return r}initEvents(){const o=(t)=>{const i=this.wrapper.getBoundingClientRect(),n=t.clientX-i.left,h=t.clientY-i.top;return[n/i.width,h/i.height]};this.wrapper.addEventListener("click",(t)=>{const[i,n]=o(t);this.emit("click",i,n)}),this.wrapper.addEventListener("dblclick",(t)=>{const[i,n]=o(t);this.emit("dblclick",i,n)}),this.options.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.scrollContainer.addEventListener("scroll",()=>{const{scrollLeft:t,scrollWidth:i,clientWidth:n}=this.scrollContainer,h=t/i,d=(t+n)/i;this.emit("scroll",h,d)});const r=this.createDelay(100);this.resizeObserver=new ResizeObserver(()=>{r().then(()=>this.onContainerResize()).catch(()=>{})}),this.resizeObserver.observe(this.scrollContainer)}onContainerResize(){const o=this.parent.clientWidth;o===this.lastContainerWidth&&this.options.height!=="auto"||(this.lastContainerWidth=o,this.reRender())}initDrag(){this.subscriptions.push(function(o,r,t,i,n=3,h=0,d=100){if(!o)return()=>{};const s=matchMedia("(pointer: coarse)").matches;let c=()=>{};const e=(l)=>{if(l.button!==h)return;l.preventDefault(),l.stopPropagation();let{clientX:g,clientY:w}=l,E=!1;const N=Date.now(),u=(M)=>{if(M.preventDefault(),M.stopPropagation(),s&&Date.now()-N<d)return;const{clientX:F,clientY:S}=M,T=F-g,R=S-w;if(E||Math.abs(T)>n||Math.abs(R)>n){const P=o.getBoundingClientRect(),{left:So,top:Po}=P;E||(t==null||t(g-So,w-Po),E=!0),r(T,R,F-So,S-Po),g=F,w=S}},U=(M)=>{if(E){const{clientX:F,clientY:S}=M,T=o.getBoundingClientRect(),{left:R,top:P}=T;i==null||i(F-R,S-P)}c()},G=(M)=>{M.relatedTarget&&M.relatedTarget!==document.documentElement||U(M)},A=(M)=>{E&&(M.stopPropagation(),M.preventDefault())},C=(M)=>{E&&M.preventDefault()};document.addEventListener("pointermove",u),document.addEventListener("pointerup",U),document.addEventListener("pointerout",G),document.addEventListener("pointercancel",G),document.addEventListener("touchmove",C,{passive:!1}),document.addEventListener("click",A,{capture:!0}),c=()=>{document.removeEventListener("pointermove",u),document.removeEventListener("pointerup",U),document.removeEventListener("pointerout",G),document.removeEventListener("pointercancel",G),document.removeEventListener("touchmove",C),setTimeout(()=>{document.removeEventListener("click",A,{capture:!0})},10)}};return o.addEventListener("pointerdown",e),()=>{c(),o.removeEventListener("pointerdown",e)}}(this.wrapper,(o,r,t)=>{this.emit("drag",Math.max(0,Math.min(1,t/this.wrapper.getBoundingClientRect().width)))},(o)=>{this.isDragging=!0,this.emit("dragstart",Math.max(0,Math.min(1,o/this.wrapper.getBoundingClientRect().width)))},(o)=>{this.isDragging=!1,this.emit("dragend",Math.max(0,Math.min(1,o/this.wrapper.getBoundingClientRect().width)))}))}getHeight(o,r){var t;const i=((t=this.audioData)===null||t===void 0?void 0:t.numberOfChannels)||1;if(o==null)return 128;if(!isNaN(Number(o)))return Number(o);if(o==="auto"){const n=this.parent.clientHeight||128;return(r==null?void 0:r.every((h)=>!h.overlay))?n/i:n}return 128}initHtml(){const o=document.createElement("div"),r=o.attachShadow({mode:"open"});return r.innerHTML=`\n      <style>\n        :host {\n          user-select: none;\n          min-width: 1px;\n        }\n        :host audio {\n          display: block;\n          width: 100%;\n        }\n        :host .scroll {\n          overflow-x: auto;\n          overflow-y: hidden;\n          width: 100%;\n          position: relative;\n        }\n        :host .noScrollbar {\n          scrollbar-color: transparent;\n          scrollbar-width: none;\n        }\n        :host .noScrollbar::-webkit-scrollbar {\n          display: none;\n          -webkit-appearance: none;\n        }\n        :host .wrapper {\n          position: relative;\n          overflow: visible;\n          z-index: 2;\n        }\n        :host .canvases {\n          min-height: ${this.getHeight(this.options.height,this.options.splitChannels)}px;\n        }\n        :host .canvases > div {\n          position: relative;\n        }\n        :host canvas {\n          display: block;\n          position: absolute;\n          top: 0;\n          image-rendering: pixelated;\n        }\n        :host .progress {\n          pointer-events: none;\n          position: absolute;\n          z-index: 2;\n          top: 0;\n          left: 0;\n          width: 0;\n          height: 100%;\n          overflow: hidden;\n        }\n        :host .progress > div {\n          position: relative;\n        }\n        :host .cursor {\n          pointer-events: none;\n          position: absolute;\n          z-index: 5;\n          top: 0;\n          left: 0;\n          height: 100%;\n          border-radius: 2px;\n        }\n      </style>\n\n      <div class="scroll" part="scroll">\n        <div class="wrapper" part="wrapper">\n          <div class="canvases" part="canvases"></div>\n          <div class="progress" part="progress"></div>\n          <div class="cursor" part="cursor"></div>\n        </div>\n      </div>\n    `,[o,r]}setOptions(o){if(this.options.container!==o.container){const r=this.parentFromOptionsContainer(o.container);r.appendChild(this.container),this.parent=r}o.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.options=o,this.reRender()}getWrapper(){return this.wrapper}getScroll(){return this.scrollContainer.scrollLeft}setScroll(o){this.scrollContainer.scrollLeft=o}setScrollPercentage(o){const{scrollWidth:r}=this.scrollContainer,t=r*o;this.setScroll(t)}destroy(){var o;this.subscriptions.forEach((r)=>r()),this.container.remove(),(o=this.resizeObserver)===null||o===void 0||o.disconnect()}createDelay(o=10){let r,t;const i=()=>{r&&clearTimeout(r),t&&t()};return this.timeouts.push(i),()=>new Promise((n,h)=>{i(),t=h,r=setTimeout(()=>{r=void 0,t=void 0,n()},o)})}convertColorValues(o){if(!Array.isArray(o))return o||"";if(o.length<2)return o[0]||"";const r=document.createElement("canvas"),t=r.getContext("2d"),i=r.height*(window.devicePixelRatio||1),n=t.createLinearGradient(0,0,0,i),h=1/(o.length-1);return o.forEach((d,s)=>{const c=s*h;n.addColorStop(c,d)}),n}renderBarWaveform(o,r,t,i){const n=o[0],h=o[1]||o[0],d=n.length,{width:s,height:c}=t.canvas,e=c/2,l=window.devicePixelRatio||1,g=r.barWidth?r.barWidth*l:1,w=r.barGap?r.barGap*l:r.barWidth?g/2:0,E=r.barRadius||0,N=s/(g+w)/d,u=E&&"roundRect"in t?"roundRect":"rect";t.beginPath();let U=0,G=0,A=0;for(let C=0;C<=d;C++){const M=Math.round(C*N);if(M>U){const T=Math.round(G*e*i),R=T+Math.round(A*e*i)||1;let P=e-T;r.barAlign==="top"?P=0:r.barAlign==="bottom"&&(P=c-R),t[u](U*(g+w),P,g,R,E),U=M,G=0,A=0}const F=Math.abs(n[C]||0),S=Math.abs(h[C]||0);F>G&&(G=F),S>A&&(A=S)}t.fill(),t.closePath()}renderLineWaveform(o,r,t,i){const n=(h)=>{const d=o[h]||o[0],s=d.length,{height:c}=t.canvas,e=c/2,l=t.canvas.width/s;t.moveTo(0,e);let g=0,w=0;for(let E=0;E<=s;E++){const N=Math.round(E*l);if(N>g){const U=e+(Math.round(w*e*i)||1)*(h===0?-1:1);t.lineTo(g,U),g=N,w=0}const u=Math.abs(d[E]||0);u>w&&(w=u)}t.lineTo(g,e)};t.beginPath(),n(0),n(1),t.fill(),t.closePath()}renderWaveform(o,r,t){if(t.fillStyle=this.convertColorValues(r.waveColor),r.renderFunction)return void r.renderFunction(o,t);let i=r.barHeight||1;if(r.normalize){const n=Array.from(o[0]).reduce((h,d)=>Math.max(h,Math.abs(d)),0);i=n?1/n:1}r.barWidth||r.barGap||r.barAlign?this.renderBarWaveform(o,r,t,i):this.renderLineWaveform(o,r,t,i)}renderSingleCanvas(o,r,t,i,n,h,d){const s=window.devicePixelRatio||1,c=document.createElement("canvas");c.width=Math.round(t*s),c.height=Math.round(i*s),c.style.width=`${t}px`,c.style.height=`${i}px`,c.style.left=`${Math.round(n)}px`,h.appendChild(c);const e=c.getContext("2d");if(this.renderWaveform(o,r,e),c.width>0&&c.height>0){const l=c.cloneNode(),g=l.getContext("2d");g.drawImage(c,0,0),g.globalCompositeOperation="source-in",g.fillStyle=this.convertColorValues(r.progressColor),g.fillRect(0,0,c.width,c.height),d.appendChild(l)}}renderMultiCanvas(o,r,t,i,n,h){return W(this,void 0,void 0,function*(){const d=window.devicePixelRatio||1,s=t/d;let c=Math.min(k.MAX_CANVAS_WIDTH,this.scrollContainer.clientWidth);if(r.barWidth||r.barGap){const E=r.barWidth||0.5,N=E+(r.barGap||E/2);c%N!=0&&(c=Math.floor(c/N)*N)}const e=(E)=>{const N=E*c,u=Math.min(s-N,c),U=o.map((G)=>{const A=Math.floor(N/s*G.length),C=Math.floor((N+u)/s*G.length);return G.slice(A,C)});this.renderSingleCanvas(U,r,u,i,N,n,h)},l=Math.ceil(s/c);if(l===1)return void e(0);const g=this.scrollContainer.scrollLeft/s,w=Math.floor(g*l);e(w),e(w+1),yield Promise.all([(()=>W(this,void 0,void 0,function*(){const E=this.createDelay();for(let N=w-1;N>=0;N--)yield E(),e(N)}))(),(()=>W(this,void 0,void 0,function*(){const E=this.createDelay();for(let N=w+2;N<l;N++)yield E(),e(N)}))()])})}renderChannel(o,r,t,i){return W(this,void 0,void 0,function*(){var{overlay:n}=r,h=function(e,l){var g={};for(var w in e)Object.prototype.hasOwnProperty.call(e,w)&&l.indexOf(w)<0&&(g[w]=e[w]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function"){var E=0;for(w=Object.getOwnPropertySymbols(e);E<w.length;E++)l.indexOf(w[E])<0&&Object.prototype.propertyIsEnumerable.call(e,w[E])&&(g[w[E]]=e[w[E]])}return g}(r,["overlay"]);const d=document.createElement("div"),s=this.getHeight(h.height,h.splitChannels);d.style.height=`${s}px`,n&&i>0&&(d.style.marginTop=`-${s}px`),this.canvasWrapper.style.minHeight=`${s}px`,this.canvasWrapper.appendChild(d);const c=d.cloneNode();this.progressWrapper.appendChild(c),yield this.renderMultiCanvas(o,h,t,s,d,c)})}render(o){return W(this,void 0,void 0,function*(){this.timeouts.forEach((d)=>d()),this.timeouts=[],this.canvasWrapper.innerHTML="",this.progressWrapper.innerHTML="",this.options.width!=null&&(this.scrollContainer.style.width=typeof this.options.width=="number"?`${this.options.width}px`:this.options.width);const r=window.devicePixelRatio||1,t=this.scrollContainer.clientWidth,i=Math.ceil(o.duration*(this.options.minPxPerSec||0));this.isScrollable=i>t;const n=this.options.fillParent&&!this.isScrollable,h=(n?t:i)*r;this.wrapper.style.width=n?"100%":`${i}px`,this.scrollContainer.style.overflowX=this.isScrollable?"auto":"hidden",this.scrollContainer.classList.toggle("noScrollbar",!!this.options.hideScrollbar),this.cursor.style.backgroundColor=`${this.options.cursorColor||this.options.progressColor}`,this.cursor.style.width=`${this.options.cursorWidth}px`,this.audioData=o,this.emit("render");try{if(this.options.splitChannels)yield Promise.all(Array.from({length:o.numberOfChannels}).map((d,s)=>{var c;const e=Object.assign(Object.assign({},this.options),(c=this.options.splitChannels)===null||c===void 0?void 0:c[s]);return this.renderChannel([o.getChannelData(s)],e,h,s)}));else{const d=[o.getChannelData(0)];o.numberOfChannels>1&&d.push(o.getChannelData(1)),yield this.renderChannel(d,this.options,h,0)}}catch(d){return}this.emit("rendered")})}reRender(){if(!this.audioData)return;const{scrollWidth:o}=this.scrollContainer,{right:r}=this.progressWrapper.getBoundingClientRect();if(this.render(this.audioData),this.isScrollable&&o!==this.scrollContainer.scrollWidth){const{right:t}=this.progressWrapper.getBoundingClientRect();let i=t-r;i*=2,i=i<0?Math.floor(i):Math.ceil(i),i/=2,this.scrollContainer.scrollLeft+=i}}zoom(o){this.options.minPxPerSec=o,this.reRender()}scrollIntoView(o,r=!1){const{scrollLeft:t,scrollWidth:i,clientWidth:n}=this.scrollContainer,h=o*i,d=t,s=t+n,c=n/2;if(this.isDragging)h+30>s?this.scrollContainer.scrollLeft+=30:h-30<d&&(this.scrollContainer.scrollLeft-=30);else{(h<d||h>s)&&(this.scrollContainer.scrollLeft=h-(this.options.autoCenter?c:0));const e=h-t-c;r&&this.options.autoCenter&&e>0&&(this.scrollContainer.scrollLeft+=Math.min(e,10))}{const e=this.scrollContainer.scrollLeft,l=e/i,g=(e+n)/i;this.emit("scroll",l,g)}}renderProgress(o,r){if(isNaN(o))return;const t=100*o;this.canvasWrapper.style.clipPath=`polygon(${t}% 0, 100% 0, 100% 100%, ${t}% 100%)`,this.progressWrapper.style.width=`${t}%`,this.cursor.style.left=`${t}%`,this.cursor.style.transform=`translateX(-${Math.round(t)===100?this.options.cursorWidth:0}px)`,this.isScrollable&&this.options.autoScroll&&this.scrollIntoView(o,r)}exportImage(o,r,t){return W(this,void 0,void 0,function*(){const i=this.canvasWrapper.querySelectorAll("canvas");if(!i.length)throw new Error("No waveform data");if(t==="dataURL"){const n=Array.from(i).map((h)=>h.toDataURL(o,r));return Promise.resolve(n)}return Promise.all(Array.from(i).map((n)=>new Promise((h,d)=>{n.toBlob((s)=>{s?h(s):d(new Error("Could not export image"))},o,r)})))})}}k.MAX_CANVAS_WIDTH=4000;class lr extends K{constructor(){super(...arguments),this.unsubscribe=()=>{}}start(){this.unsubscribe=this.on("tick",()=>{requestAnimationFrame(()=>{this.emit("tick")})}),this.emit("tick")}stop(){this.unsubscribe()}destroy(){this.unsubscribe()}}class Ho extends K{constructor(o=new AudioContext){super(),this.bufferNode=null,this.playStartTime=0,this.playedDuration=0,this._muted=!1,this._playbackRate=1,this._duration=void 0,this.buffer=null,this.currentSrc="",this.paused=!0,this.crossOrigin=null,this.seeking=!1,this.autoplay=!1,this.addEventListener=this.on,this.removeEventListener=this.un,this.audioContext=o,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination)}load(){return W(this,void 0,void 0,function*(){})}get src(){return this.currentSrc}set src(o){if(this.currentSrc=o,this._duration=void 0,!o)return this.buffer=null,void this.emit("emptied");fetch(o).then((r)=>{if(r.status>=400)throw new Error(`Failed to fetch ${o}: ${r.status} (${r.statusText})`);return r.arrayBuffer()}).then((r)=>this.currentSrc!==o?null:this.audioContext.decodeAudioData(r)).then((r)=>{this.currentSrc===o&&(this.buffer=r,this.emit("loadedmetadata"),this.emit("canplay"),this.autoplay&&this.play())})}_play(){var o;if(!this.paused)return;this.paused=!1,(o=this.bufferNode)===null||o===void 0||o.disconnect(),this.bufferNode=this.audioContext.createBufferSource(),this.buffer&&(this.bufferNode.buffer=this.buffer),this.bufferNode.playbackRate.value=this._playbackRate,this.bufferNode.connect(this.gainNode);let r=this.playedDuration*this._playbackRate;r>=this.duration&&(r=0,this.playedDuration=0),this.bufferNode.start(this.audioContext.currentTime,r),this.playStartTime=this.audioContext.currentTime,this.bufferNode.onended=()=>{this.currentTime>=this.duration&&(this.pause(),this.emit("ended"))}}_pause(){var o;this.paused=!0,(o=this.bufferNode)===null||o===void 0||o.stop(),this.playedDuration+=this.audioContext.currentTime-this.playStartTime}play(){return W(this,void 0,void 0,function*(){this.paused&&(this._play(),this.emit("play"))})}pause(){this.paused||(this._pause(),this.emit("pause"))}stopAt(o){var r,t;const i=o-this.currentTime;(r=this.bufferNode)===null||r===void 0||r.stop(this.audioContext.currentTime+i),(t=this.bufferNode)===null||t===void 0||t.addEventListener("ended",()=>{this.bufferNode=null,this.pause()},{once:!0})}setSinkId(o){return W(this,void 0,void 0,function*(){return this.audioContext.setSinkId(o)})}get playbackRate(){return this._playbackRate}set playbackRate(o){this._playbackRate=o,this.bufferNode&&(this.bufferNode.playbackRate.value=o)}get currentTime(){return(this.paused?this.playedDuration:this.playedDuration+(this.audioContext.currentTime-this.playStartTime))*this._playbackRate}set currentTime(o){const r=!this.paused;r&&this._pause(),this.playedDuration=o/this._playbackRate,r&&this._play(),this.emit("seeking"),this.emit("timeupdate")}get duration(){var o,r;return(o=this._duration)!==null&&o!==void 0?o:((r=this.buffer)===null||r===void 0?void 0:r.duration)||0}set duration(o){this._duration=o}get volume(){return this.gainNode.gain.value}set volume(o){this.gainNode.gain.value=o,this.emit("volumechange")}get muted(){return this._muted}set muted(o){this._muted!==o&&(this._muted=o,this._muted?this.gainNode.disconnect():this.gainNode.connect(this.audioContext.destination))}canPlayType(o){return/^(audio|video)\//.test(o)}getGainNode(){return this.gainNode}getChannelData(){const o=[];if(!this.buffer)return o;const r=this.buffer.numberOfChannels;for(let t=0;t<r;t++)o.push(this.buffer.getChannelData(t));return o}}var ut={waveColor:"#999",progressColor:"#555",cursorWidth:1,minPxPerSec:0,fillParent:!0,interact:!0,dragToSeek:!1,autoScroll:!0,autoCenter:!0,sampleRate:8000};class Q extends vr{static create(o){return new Q(o)}constructor(o){const r=o.media||(o.backend==="WebAudio"?new Ho:void 0);super({media:r,mediaControls:o.mediaControls,autoplay:o.autoplay,playbackRate:o.audioRate}),this.plugins=[],this.decodedData=null,this.subscriptions=[],this.mediaSubscriptions=[],this.abortController=null,this.options=Object.assign({},ut,o),this.timer=new lr;const t=r?void 0:this.getMediaElement();this.renderer=new k(this.options,t),this.initPlayerEvents(),this.initRendererEvents(),this.initTimerEvents(),this.initPlugins();const i=this.options.url||this.getSrc()||"";Promise.resolve().then(()=>{this.emit("init");const{peaks:n,duration:h}=this.options;(i||n&&h)&&this.load(i,n,h).catch(()=>null)})}updateProgress(o=this.getCurrentTime()){return this.renderer.renderProgress(o/this.getDuration(),this.isPlaying()),o}initTimerEvents(){this.subscriptions.push(this.timer.on("tick",()=>{if(!this.isSeeking()){const o=this.updateProgress();this.emit("timeupdate",o),this.emit("audioprocess",o)}}))}initPlayerEvents(){this.isPlaying()&&(this.emit("play"),this.timer.start()),this.mediaSubscriptions.push(this.onMediaEvent("timeupdate",()=>{const o=this.updateProgress();this.emit("timeupdate",o)}),this.onMediaEvent("play",()=>{this.emit("play"),this.timer.start()}),this.onMediaEvent("pause",()=>{this.emit("pause"),this.timer.stop()}),this.onMediaEvent("emptied",()=>{this.timer.stop()}),this.onMediaEvent("ended",()=>{this.emit("finish")}),this.onMediaEvent("seeking",()=>{this.emit("seeking",this.getCurrentTime())}),this.onMediaEvent("error",(o)=>{this.emit("error",o.error)}))}initRendererEvents(){this.subscriptions.push(this.renderer.on("click",(o,r)=>{this.options.interact&&(this.seekTo(o),this.emit("interaction",o*this.getDuration()),this.emit("click",o,r))}),this.renderer.on("dblclick",(o,r)=>{this.emit("dblclick",o,r)}),this.renderer.on("scroll",(o,r)=>{const t=this.getDuration();this.emit("scroll",o*t,r*t)}),this.renderer.on("render",()=>{this.emit("redraw")}),this.renderer.on("rendered",()=>{this.emit("redrawcomplete")}),this.renderer.on("dragstart",(o)=>{this.emit("dragstart",o)}),this.renderer.on("dragend",(o)=>{this.emit("dragend",o)}));{let o;this.subscriptions.push(this.renderer.on("drag",(r)=>{if(!this.options.interact)return;let t;this.renderer.renderProgress(r),clearTimeout(o),this.isPlaying()?t=0:this.options.dragToSeek===!0?t=200:typeof this.options.dragToSeek=="object"&&this.options.dragToSeek!==void 0&&(t=this.options.dragToSeek.debounceTime),o=setTimeout(()=>{this.seekTo(r)},t),this.emit("interaction",r*this.getDuration()),this.emit("drag",r)}))}}initPlugins(){var o;((o=this.options.plugins)===null||o===void 0?void 0:o.length)&&this.options.plugins.forEach((r)=>{this.registerPlugin(r)})}unsubscribePlayerEvents(){this.mediaSubscriptions.forEach((o)=>o()),this.mediaSubscriptions=[]}setOptions(o){this.options=Object.assign({},this.options,o),this.renderer.setOptions(this.options),o.audioRate&&this.setPlaybackRate(o.audioRate),o.mediaControls!=null&&(this.getMediaElement().controls=o.mediaControls)}registerPlugin(o){return o._init(this),this.plugins.push(o),this.subscriptions.push(o.once("destroy",()=>{this.plugins=this.plugins.filter((r)=>r!==o)})),o}getWrapper(){return this.renderer.getWrapper()}getScroll(){return this.renderer.getScroll()}setScroll(o){return this.renderer.setScroll(o)}setScrollTime(o){const r=o/this.getDuration();this.renderer.setScrollPercentage(r)}getActivePlugins(){return this.plugins}loadAudio(o,r,t,i){return W(this,void 0,void 0,function*(){var n;if(this.emit("load",o),!this.options.media&&this.isPlaying()&&this.pause(),this.decodedData=null,!r&&!t){const d=this.options.fetchParams||{};window.AbortController&&!d.signal&&(this.abortController=new AbortController,d.signal=(n=this.abortController)===null||n===void 0?void 0:n.signal);const s=(c)=>this.emit("loading",c);r=yield Ut.fetchBlob(o,s,d)}this.setSrc(o,r);const h=i||this.getDuration()||(yield new Promise((d)=>{this.onMediaEvent("loadedmetadata",()=>d(this.getDuration()),{once:!0})}));if(!o&&!r){const d=this.getMediaElement();d instanceof Ho&&(d.duration=h)}if(t)this.decodedData=cr.createBuffer(t,h||0);else if(r){const d=yield r.arrayBuffer();this.decodedData=yield cr.decode(d,this.options.sampleRate)}this.decodedData&&(this.emit("decode",this.getDuration()),this.renderer.render(this.decodedData)),this.emit("ready",this.getDuration())})}load(o,r,t){return W(this,void 0,void 0,function*(){try{return yield this.loadAudio(o,void 0,r,t)}catch(i){throw this.emit("error",i),i}})}loadBlob(o,r,t){return W(this,void 0,void 0,function*(){try{return yield this.loadAudio("blob",o,r,t)}catch(i){throw this.emit("error",i),i}})}zoom(o){if(!this.decodedData)throw new Error("No audio loaded");this.renderer.zoom(o),this.emit("zoom",o)}getDecodedData(){return this.decodedData}exportPeaks({channels:o=2,maxLength:r=8000,precision:t=1e4}={}){if(!this.decodedData)throw new Error("The audio has not been decoded yet");const i=Math.min(o,this.decodedData.numberOfChannels),n=[];for(let h=0;h<i;h++){const d=this.decodedData.getChannelData(h),s=[],c=d.length/r;for(let e=0;e<r;e++){const l=d.slice(Math.floor(e*c),Math.ceil((e+1)*c));let g=0;for(let w=0;w<l.length;w++){const E=l[w];Math.abs(E)>Math.abs(g)&&(g=E)}s.push(Math.round(g*t)/t)}n.push(s)}return n}getDuration(){let o=super.getDuration()||0;return o!==0&&o!==1/0||!this.decodedData||(o=this.decodedData.duration),o}toggleInteraction(o){this.options.interact=o}setTime(o){super.setTime(o),this.updateProgress(o),this.emit("timeupdate",o)}seekTo(o){const r=this.getDuration()*o;this.setTime(r)}playPause(){return W(this,void 0,void 0,function*(){return this.isPlaying()?this.pause():this.play()})}stop(){this.pause(),this.setTime(0)}skip(o){this.setTime(this.getCurrentTime()+o)}empty(){this.load("",[[0]],0.001)}setMediaElement(o){this.unsubscribePlayerEvents(),super.setMediaElement(o),this.initPlayerEvents()}exportImage(){return W(this,arguments,void 0,function*(o="image/png",r=1,t="dataURL"){return this.renderer.exportImage(o,r,t)})}destroy(){var o;this.emit("destroy"),(o=this.abortController)===null||o===void 0||o.abort(),this.plugins.forEach((r)=>r.destroy()),this.subscriptions.forEach((r)=>r()),this.unsubscribePlayerEvents(),this.timer.destroy(),this.renderer.destroy(),super.destroy()}}Q.BasePlugin=class extends K{constructor(o){super(),this.subscriptions=[],this.options=o}onInit(){}_init(o){this.wavesurfer=o,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((o)=>o())}},Q.dom=Gt;var Oo=function(o,r,t,i){return new(t||(t=Promise))(function(n,h){function d(e){try{c(i.next(e))}catch(l){h(l)}}function s(e){try{c(i.throw(e))}catch(l){h(l)}}function c(e){var l;e.done?n(e.value):(l=e.value,l instanceof t?l:new t(function(g){g(l)})).then(d,s)}c((i=i.apply(o,r||[])).next())})};class Wo{constructor(){this.listeners={}}on(o,r,t){if(this.listeners[o]||(this.listeners[o]=new Set),this.listeners[o].add(r),t==null?void 0:t.once){const i=()=>{this.un(o,i),this.un(o,r)};return this.on(o,i),i}return()=>this.un(o,r)}un(o,r){var t;(t=this.listeners[o])===null||t===void 0||t.delete(r)}once(o,r){return this.on(o,r,{once:!0})}unAll(){this.listeners={}}emit(o,...r){this.listeners[o]&&this.listeners[o].forEach((t)=>t(...r))}}class gr extends Wo{constructor(o){super(),this.subscriptions=[],this.options=o}onInit(){}_init(o){this.wavesurfer=o,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((o)=>o())}}class wr extends Wo{constructor(){super(...arguments),this.unsubscribe=()=>{}}start(){this.unsubscribe=this.on("tick",()=>{requestAnimationFrame(()=>{this.emit("tick")})}),this.emit("tick")}stop(){this.unsubscribe()}destroy(){this.unsubscribe()}}var Ft=["audio/webm","audio/wav","audio/mpeg","audio/mp4","audio/mp3"];class b extends gr{constructor(o){var r,t,i,n;super(Object.assign(Object.assign({},o),{audioBitsPerSecond:(r=o.audioBitsPerSecond)!==null&&r!==void 0?r:128000,scrollingWaveform:(t=o.scrollingWaveform)!==null&&t!==void 0&&t,scrollingWaveformWindow:(i=o.scrollingWaveformWindow)!==null&&i!==void 0?i:5,renderRecordedAudio:(n=o.renderRecordedAudio)===null||n===void 0||n})),this.stream=null,this.mediaRecorder=null,this.dataWindow=null,this.isWaveformPaused=!1,this.lastStartTime=0,this.lastDuration=0,this.duration=0,this.timer=new wr,this.subscriptions.push(this.timer.on("tick",()=>{const h=performance.now()-this.lastStartTime;this.duration=this.isPaused()?this.duration:this.lastDuration+h,this.emit("record-progress",this.duration)}))}static create(o){return new b(o||{})}renderMicStream(o){const r=new AudioContext,t=r.createMediaStreamSource(o),i=r.createAnalyser();t.connect(i);const n=i.frequencyBinCount,h=new Float32Array(n);let d;const s=Math.floor((this.options.scrollingWaveformWindow||0)*r.sampleRate),c=()=>{var e;if(this.isWaveformPaused)return void(d=requestAnimationFrame(c));if(i.getFloatTimeDomainData(h),this.options.scrollingWaveform){const g=Math.min(s,this.dataWindow?this.dataWindow.length+n:n),w=new Float32Array(s);if(this.dataWindow){const E=Math.max(0,s-this.dataWindow.length);w.set(this.dataWindow.slice(-g+n),E)}w.set(h,s-n),this.dataWindow=w}else this.dataWindow=h;const l=this.options.scrollingWaveformWindow;this.wavesurfer&&((e=this.originalOptions)!==null&&e!==void 0||(this.originalOptions={cursorWidth:this.wavesurfer.options.cursorWidth,interact:this.wavesurfer.options.interact}),this.wavesurfer.options.cursorWidth=0,this.wavesurfer.options.interact=!1,this.wavesurfer.load("",[this.dataWindow],l)),d=requestAnimationFrame(c)};return c(),{onDestroy:()=>{cancelAnimationFrame(d),t==null||t.disconnect(),r==null||r.close()},onEnd:()=>{this.isWaveformPaused=!0,cancelAnimationFrame(d),this.stopMic()}}}startMic(o){return Oo(this,void 0,void 0,function*(){let r;try{r=yield navigator.mediaDevices.getUserMedia({audio:!(o==null?void 0:o.deviceId)||{deviceId:o.deviceId}})}catch(n){throw new Error("Error accessing the microphone: "+n.message)}const{onDestroy:t,onEnd:i}=this.renderMicStream(r);return this.subscriptions.push(this.once("destroy",t)),this.subscriptions.push(this.once("record-end",i)),this.stream=r,r})}stopMic(){this.stream&&(this.stream.getTracks().forEach((o)=>o.stop()),this.stream=null,this.mediaRecorder=null)}startRecording(o){return Oo(this,void 0,void 0,function*(){const r=this.stream||(yield this.startMic(o));this.dataWindow=null;const t=this.mediaRecorder||new MediaRecorder(r,{mimeType:this.options.mimeType||Ft.find((h)=>MediaRecorder.isTypeSupported(h)),audioBitsPerSecond:this.options.audioBitsPerSecond});this.mediaRecorder=t,this.stopRecording();const i=[];t.ondataavailable=(h)=>{h.data.size>0&&i.push(h.data)};const n=(h)=>{var d;const s=new Blob(i,{type:t.mimeType});this.emit(h,s),this.options.renderRecordedAudio&&(this.applyOriginalOptionsIfNeeded(),(d=this.wavesurfer)===null||d===void 0||d.load(URL.createObjectURL(s)))};t.onpause=()=>n("record-pause"),t.onstop=()=>n("record-end"),t.start(),this.lastStartTime=performance.now(),this.lastDuration=0,this.duration=0,this.isWaveformPaused=!1,this.timer.start(),this.emit("record-start")})}getDuration(){return this.duration}isRecording(){var o;return((o=this.mediaRecorder)===null||o===void 0?void 0:o.state)==="recording"}isPaused(){var o;return((o=this.mediaRecorder)===null||o===void 0?void 0:o.state)==="paused"}isActive(){var o;return((o=this.mediaRecorder)===null||o===void 0?void 0:o.state)!=="inactive"}stopRecording(){var o;this.isActive()&&((o=this.mediaRecorder)===null||o===void 0||o.stop(),this.timer.stop())}pauseRecording(){var o,r;this.isRecording()&&(this.isWaveformPaused=!0,(o=this.mediaRecorder)===null||o===void 0||o.requestData(),(r=this.mediaRecorder)===null||r===void 0||r.pause(),this.timer.stop(),this.lastDuration=this.duration)}resumeRecording(){var o;this.isPaused()&&(this.isWaveformPaused=!1,(o=this.mediaRecorder)===null||o===void 0||o.resume(),this.timer.start(),this.lastStartTime=performance.now(),this.emit("record-resume"))}static getAvailableAudioDevices(){return Oo(this,void 0,void 0,function*(){return navigator.mediaDevices.enumerateDevices().then((o)=>o.filter((r)=>r.kind==="audioinput"))})}destroy(){this.applyOriginalOptionsIfNeeded(),super.destroy(),this.stopRecording(),this.stopMic()}applyOriginalOptionsIfNeeded(){this.wavesurfer&&this.originalOptions&&(this.wavesurfer.options.cursorWidth=this.originalOptions.cursorWidth,this.wavesurfer.options.interact=this.originalOptions.interact,delete this.originalOptions)}}import{useRef as Uo,useEffect as It} from"preact/hooks";import{useLocale as _t,useEditor as Tt} from"@blockcode/core";import{classNames as uo,Label as Rt,BufferedInput as at,Button as Er} from"@blockcode/ui";Z(".AHUB0G_surfer-wrapper{padding:calc(var(--space)*1.5);border-left:1px solid var(--ui-black-transparent);color:var(--text-primary);flex-direction:column;flex:1;display:flex}.AHUB0G_surfer-wrapper.AHUB0G_disabled{opacity:.5;pointer-events:none}.AHUB0G_row{min-height:3rem;margin-bottom:.5rem;display:flex}.AHUB0G_row-fill{padding-top:calc(var(--space)*2.5);border-top:1px dashed var(--ui-black-transparent);flex-direction:row;flex:1}.AHUB0G_row-right{margin-right:var(--space);justify-content:right}.AHUB0G_row:last-child{min-height:unset;margin-bottom:0}.AHUB0G_group{margin-right:calc(var(--space)*1.5);flex-direction:row;align-items:center;display:inline-flex}.AHUB0G_dashed-border{border-right:1px dashed var(--ui-black-transparent);padding-right:var(--space)}.AHUB0G_name-input{width:8rem}.AHUB0G_large-input{width:4rem}.AHUB0G_tool-icon{margin-right:var(--space);width:2rem;height:2rem}.AHUB0G_label-image{vertical-align:middle;margin-right:calc(var(--space)/2)}.AHUB0G_button{width:calc(2rem + 2px);height:calc(2rem + 2px);padding:.375rem}.AHUB0G_button-icon{width:100%;height:100%;margin:auto}.AHUB0G_group-button{border-left:none;border-radius:0}.AHUB0G_group-button-first{border-top-right-radius:0;border-bottom-right-radius:0}.AHUB0G_group-button-last{border-left:none;border-top-left-radius:0;border-bottom-left-radius:0}.AHUB0G_group-button-toggled-off{filter:saturate(0)}.AHUB0G_label-button{border:0;font-weight:400}.AHUB0G_label-button.AHUB0G_selected{background:var(--motion-primary);color:var(--ui-white)}.AHUB0G_label-button.AHUB0G_selected .AHUB0G_button-icon{filter:brightness(0)invert()}.AHUB0G_play-button,.AHUB0G_record-button{cursor:pointer;margin:0 var(--space);border:0;border-radius:100%;width:3rem;height:3rem;padding:.75rem}.AHUB0G_play-button{background:var(--motion-primary)}.AHUB0G_record-button{background:var(--red-primary)}.AHUB0G_wave-box-wrapper{margin:20px var(--space);border:1px solid var(--ui-black-transparent);border-radius:calc(var(--space)*.8);background:hsl(from var(--sound-primary)h s l/.15);flex:1;min-height:160px;position:relative;overflow:hidden}");var H={groupButtonToggledOff:"AHUB0G_group-button-toggled-off",toolIcon:"AHUB0G_tool-icon",waveBoxWrapper:"AHUB0G_wave-box-wrapper",groupButtonFirst:"AHUB0G_group-button-first",rowFill:"AHUB0G_row-fill",group:"AHUB0G_group",labelImage:"AHUB0G_label-image",dashedBorder:"AHUB0G_dashed-border",nameInput:"AHUB0G_name-input",largeInput:"AHUB0G_large-input",groupButtonLast:"AHUB0G_group-button-last",selected:"AHUB0G_selected",groupButton:"AHUB0G_group-button",recordButton:"AHUB0G_record-button",rowRight:"AHUB0G_row-right",surferWrapper:"AHUB0G_surfer-wrapper",row:"AHUB0G_row",disabled:"AHUB0G_disabled",buttonIcon:"AHUB0G_button-icon",playButton:"AHUB0G_play-button",button:"AHUB0G_button",labelButton:"AHUB0G_label-button"};var f="./assets/icon-play-af382a3aaf569574.svg";var Go="./assets/icon-stop-cac05cfb77c72465.svg";import{jsx as _,jsxs as Ar} from"preact/jsx-runtime";function Fo({soundList:o,soundIndex:r}){const t=Uo(),i=Uo(),n=Uo(),{getText:h}=_t(),{modifyAsset:d}=Tt(),s=o[r],c=!s;if(t.ws)t.ws.stop(),t.ws.setTime(0),setTimeout(()=>{t.ws.setOptions({cursorColor:"hsla(215, 100%, 65%, 0)",cursorWidth:0})});if(t.record)t.record.soundAsset=s;if(i.current)i.current.src=f,i.current.title=h("waveSurfer.surfer.play","Play");if(n.current)n.current.src=z,n.current.title=h("waveSurfer.surfer.record","Record");const e=(A,C)=>{d({...s,[A]:C})},l=()=>{if(t.ws){if(t.ws.isPlaying())t.ws.stop();else if(s.sampleCount>0)t.ws.play()}if(n.current)setTimeout(()=>{const A=n.current.parentElement.parentElement;if(A.disabled=t.ws.isPlaying(),t.ws.isPlaying())A.classList.add(H.groupButtonToggledOff);else A.classList.remove(H.groupButtonToggledOff)})},g=()=>{if(i.current)i.current.src=Go,i.current.title=h("waveSurfer.surfer.stop","Stop");if(t.ws)t.ws.setOptions({cursorColor:"hsla(215, 100%, 65%, 1)",cursorWidth:1});if(n.current){const A=n.current.parentElement.parentElement;A.disabled=!1,A.classList.remove(H.groupButtonToggledOff)}},w=()=>{if(i.current){if(i.current.src=f,i.current.title=h("waveSurfer.surfer.play","Play"),t.ws)t.ws.setTime(0),setTimeout(()=>{t.ws.setOptions({cursorColor:"hsla(215, 100%, 65%, 0)",cursorWidth:0})})}if(n.current){n.current.src=z,n.current.title=h("waveSurfer.surfer.record","Record");const A=n.current.parentElement.parentElement;A.disabled=!1,A.classList.remove(H.groupButtonToggledOff)}},E=()=>{if(t.ws&&!t.record.isRecording())t.ws.setOptions({cursorColor:"hsla(215, 100%, 65%, 1)",cursorWidth:1})},N=()=>{if(n.current)n.current.src=Go,n.current.title=h("waveSurfer.surfer.stop","Stop");if(i.current){const A=i.current.parentElement.parentElement;A.disabled=!0,A.classList.add(H.groupButtonToggledOff)}};let u;const U=()=>{if(t.record)if(t.record.isRecording())t.record.stopRecording(),t.record.stopMic(),clearTimeout(u);else t.record.startRecording(),u=setTimeout(U,1e4)},G=async(A)=>{const C=await or(A);if(d({...t.record.soundAsset,data:C.toBase64(),sampleCount:C.data.chunkSize}),i.current){const M=i.current.parentElement.parentElement;M.disabled=!1,M.classList.remove(H.groupButtonToggledOff)}};if(s&&t.ws){if(t.ws.isPlaying())t.ws.stop();if(t.ws.empty(),s.sampleCount>0)t.ws.load(`data:${s.type};base64,${s.data}`)}return It(()=>{if(t.current){if(t.ws=Q.create({container:t.current,dragToSeek:!0,height:"auto",waveColor:"hsla(300, 48%, 50%, 1)",progressColor:"hsla(300, 48%, 50%, 0.8)",cursorColor:"hsla(215, 100%, 65%, 0)",cursorWidth:0}),t.record=t.ws.registerPlugin(b.create()),t.ws.on("play",g),t.ws.on("pause",w),t.ws.on("finish",w),t.ws.on("seeking",E),t.record.on("record-start",N),t.record.on("record-end",G),s){if(t.ws.empty(),s.sampleCount>0)t.ws.load(`data:${s.type};base64,${s.data}`);t.record.soundAsset=s}}return()=>{if(t.ws)t.ws.destroy()}},[t]),Ar("div",{className:uo(H.surferWrapper,{[H.disabled]:c}),children:[_("div",{className:H.row,children:_("div",{className:H.group,children:_(Rt,{text:h("waveSurfer.surfer.sound","Sound"),children:_(at,{disabled:c,className:H.nameInput,placeholder:h("waveSurfer.surfer.name","name"),onSubmit:(A)=>e("name",A),value:s?s.name:h("waveSurfer.surfer.sound","Sound")})})})}),_("div",{className:H.row,children:_("div",{ref:t,className:H.waveBoxWrapper})}),Ar("div",{className:H.row,children:[_(Er,{className:uo(H.button,H.playButton,{[H.groupButtonToggledOff]:c}),onClick:l,children:_("img",{ref:i,src:f,className:H.buttonIcon,title:h("waveSurfer.surfer.play","Play")})}),s&&s.record&&_(Er,{className:uo(H.button,H.recordButton,{[H.groupButtonToggledOff]:c}),onClick:U,children:_("img",{ref:n,src:z,className:H.buttonIcon,title:h("waveSurfer.surfer.record","Record")})})]})]})}Z(".adcUka_wave-surfer-wrapper{background:var(--ui-white);border-radius:inherit;flex-grow:1;display:flex}");var Mr={waveSurferWrapper:"adcUka_wave-surfer-wrapper"};function Zt({onSetupLibrary:o}){const[r,t]=Lt(0),{assetList:i}=$t(),n=i.filter((d)=>/^audio\//.test(d.type)),h=n.findLastIndex((d)=>d.record&&d.sampleCount===0);if(h!==-1)t(h);return Yt("div",{className:Mr.waveSurferWrapper,children:[Cr(No,{soundList:n,soundIndex:r,onSelect:t,onSetupLibrary:o}),Cr(Fo,{soundList:n,soundIndex:r})]})}import{jsx as Cr,jsxs as Yt} from"preact/jsx-runtime";var Nr={"waveSurfer.contextMenu.export":"export","waveSurfer.contextMenu.delete":"delete","waveSurfer.actionButton.upload":"Upload Sound","waveSurfer.actionButton.surprise":"Surprise","waveSurfer.actionButton.record":"Record","waveSurfer.actionButton.sound":"Choose a Sound","waveSurfer.surfer.sound":"Sound","waveSurfer.surfer.play":"Play","waveSurfer.surfer.record":"Record","waveSurfer.surfer.stop":"Stop","waveSurfer.surfer.name":"name","waveSurfer.error.formatNotSupperted":"This wav format is not supported."};var Hr={"waveSurfer.contextMenu.export":"\u5BFC\u51FA","waveSurfer.contextMenu.delete":"\u5220\u9664","waveSurfer.actionButton.upload":"\u4E0A\u4F20\u58F0\u97F3","waveSurfer.actionButton.surprise":"\u968F\u673A","waveSurfer.actionButton.record":"\u5F55\u5236","waveSurfer.actionButton.sound":"\u9009\u62E9\u4E00\u4E2A\u58F0\u97F3","waveSurfer.surfer.sound":"\u58F0\u97F3","waveSurfer.surfer.play":"\u64AD\u653E","waveSurfer.surfer.record":"\u5F55\u97F3","waveSurfer.surfer.stop":"\u505C\u6B62","waveSurfer.surfer.name":"\u540D\u79F0","waveSurfer.error.formatNotSupperted":"\u58F0\u97F3\u6587\u4EF6\u683C\u5F0F\u4E0D\u652F\u6301\u3002"};var Ji={en:Nr,"zh-Hans":Hr};export{Ji as locales,Zt as WaveSurfer,q as WaveFile};
