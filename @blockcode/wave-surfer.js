var A1=Object.create;var{defineProperty:v0,getPrototypeOf:W1,getOwnPropertyNames:P1}=Object;var j1=Object.prototype.hasOwnProperty;var I1=(H,O,M)=>{M=H!=null?A1(W1(H)):{};const G=O||!H||!H.__esModule?v0(M,"default",{value:H,enumerable:!0}):M;for(let q of P1(H))if(!j1.call(G,q))v0(G,q,{get:()=>H[q],enumerable:!0});return G};var _1=(H,O)=>()=>(O||H((O={exports:{}}).exports,O),O.exports);var s0=_1((g4,a0)=>{var M3=function(H,O){O=O||{};var{numberOfChannels:M,sampleRate:G}=H,q=O.float32?3:1,J=q===3?32:16,Q;if(M===2)Q=q3(H.getChannelData(0),H.getChannelData(1));else Q=H.getChannelData(0);return G3(Q,q,G,M,J)},G3=function(H,O,M,G,q){var J=q/8,Q=G*J,Y=new ArrayBuffer(44+H.length*J),U=new DataView(Y);if(n(U,0,"RIFF"),U.setUint32(4,36+H.length*J,!0),n(U,8,"WAVE"),n(U,12,"fmt "),U.setUint32(16,16,!0),U.setUint16(20,O,!0),U.setUint16(22,G,!0),U.setUint32(24,M,!0),U.setUint32(28,M*Q,!0),U.setUint16(32,Q,!0),U.setUint16(34,q,!0),n(U,36,"data"),U.setUint32(40,H.length*J,!0),O===1)Q3(U,44,H);else J3(U,44,H);return Y},q3=function(H,O){var M=H.length+O.length,G=new Float32Array(M),q=0,J=0;while(q<M)G[q++]=H[J],G[q++]=O[J],J++;return G},J3=function(H,O,M){for(var G=0;G<M.length;G++,O+=4)H.setFloat32(O,M[G],!0)},Q3=function(H,O,M){for(var G=0;G<M.length;G++,O+=2){var q=Math.max(-1,Math.min(1,M[G]));H.setInt16(O,q<0?q*32768:q*32767,!0)}},n=function(H,O,M){for(var G=0;G<M.length;G++)H.setUint8(O+G,M.charCodeAt(G))};a0.exports=M3});function w0(H){let O="";for(let M=0;M<H.length;M+=3)O+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[H[M]>>2],O+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(H[M]&3)<<4|H[M+1]>>4],O+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(H[M+1]&15)<<2|H[M+2]>>6],O+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[H[M+2]&63];if(H.length%3===2)O=O.substring(0,O.length-1)+"=";else if(H.length%3===1)O=O.substring(0,O.length-2)+"==";return O}function C0(H){let O=new Uint8Array(256);for(let q=0;q<"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".length;q++)O["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charCodeAt(q)]=q;let M=H.length*0.75;if(H[H.length-1]==="="){if(M--,H[H.length-2]==="=")M--}let G=new Uint8Array(M);for(let q=0,J=0;q<H.length;q+=4){let Q=O[H.charCodeAt(q)],Y=O[H.charCodeAt(q+1)],U=O[H.charCodeAt(q+2)],Z=O[H.charCodeAt(q+3)];G[J++]=Q<<2|Y>>4,G[J++]=(Y&15)<<4|U>>2,G[J++]=(U&3)<<6|Z&63}return G}function D0(H,O,M,G){if(["32f","64"].indexOf(O)>-1&&["32f","64"].indexOf(G)>-1){M.set(H);return}g0(O),g0(G);let q=B1(O,G),J={oldMin:Math.pow(2,parseInt(O,10))/2,newMin:Math.pow(2,parseInt(G,10))/2,oldMax:Math.pow(2,parseInt(O,10))/2-1,newMax:Math.pow(2,parseInt(G,10))/2-1};S0(O,H,!0);for(let Q=0,Y=H.length;Q<Y;Q++)M[Q]=q(H[Q],J);S0(G,M,!1)}var T1=function(H,O){if(H>0)H=parseInt(H/O.oldMax*O.newMax,10);else H=parseInt(H/O.oldMin*O.newMin,10);return H},R1=function(H,O){return parseInt(H>0?H*O.newMax:H*O.newMin,10)},L1=function(H,O){return H>0?H/O.oldMax:H/O.oldMin},B1=function(H,O){let M=function(G){return G};if(H!=O)if(["32f","64"].includes(H))M=R1;else if(["32f","64"].includes(O))M=L1;else M=T1;return M},g0=function(H){if(H!="32f"&&H!="64"&&(parseInt(H,10)<"8"||parseInt(H,10)>"53"))throw new Error("Invalid bit depth.")},S0=function(H,O,M){if(H=="8"){let G=M?-128:128;for(let q=0,J=O.length;q<J;q++)O[q]=O[q]+=G}};function k0(H){let O={index:0,predicted:0,step:7},M=new Uint8Array(H.length),G=[],q=0,J=0;for(let Y=0,U=H.length;Y<U;Y++){if(Y%505==0&&Y!=0)M.set(v1(G,O),q),q+=256,G=[],J++;G.push(H[Y])}let Q=H.length/2;if(Q%2)Q++;return M.slice(0,Q+512+J*4)}function h0(H,O=256){let M={index:0,predicted:0,step:7},G=new Int16Array(H.length*2),q=[],J=0;for(let Q=0,Y=H.length;Q<Y;Q++){if(Q%O==0&&Q!=0){let U=w1(q,M);G.set(U,J),J+=U.length,q=[]}q.push(H[Q])}return G}var v1=function(H,O){let M=D1(H[0],O);for(let G=3,q=H.length;G<q;G+=2){let J=e(H[G],O),Q=e(H[G+1],O);M.push(Q<<4|J)}return M},w1=function(H,O){O.predicted=C1(H[1]<<8|H[0]),O.index=H[2],O.step=H0[O.index];let M=[O.predicted,O.predicted];for(let G=4,q=H.length;G<q;G++){let J=H[G],Q=J>>4,Y=Q<<4^J;M.push(y0(Y,O)),M.push(y0(Q,O))}return M},C1=function(H){return H>32768?H-65536:H},e=function(H,O){let M=H-O.predicted,G=0;if(M>=0)G=0;else G=8,M=-M;let q=H0[O.index],J=q>>3;if(M>q)G|=4,M-=q,J+=q;if(q>>=1,M>q)G|=2,M-=q,J+=q;if(q>>=1,M>q)G|=1,J+=q;return g1(G,J,O),G},g1=function(H,O,M){if(H&8)M.predicted-=O;else M.predicted+=O;if(M.predicted<-32768)M.predicted=-32768;else if(M.predicted>32767)M.predicted=32767;if(M.index+=x0[H&7],M.index<0)M.index=0;else if(M.index>88)M.index=88},y0=function(H,O){let M=0;if(H&4)M+=O.step;if(H&2)M+=O.step>>1;if(H&1)M+=O.step>>2;if(M+=O.step>>3,H&8)M=-M;if(O.predicted+=M,O.predicted>32767)O.predicted=32767;else if(O.predicted<-32767)O.predicted=-32767;return S1(H,O),O.predicted},S1=function(H,O){if(O.index+=x0[H],O.index<0)O.index=0;else if(O.index>88)O.index=88;O.step=H0[O.index]},D1=function(H,O){e(H,O);let M=[];return M.push(H&255),M.push(H>>8&255),M.push(O.index),M.push(0),M},x0=[-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8],H0=[7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767];function k1(H){let O;H=H==-32768?-32767:H;let M=~H>>8&128;if(!M)H=H*-1;if(H>32635)H=32635;if(H>=256){let G=x1[H>>8&127],q=H>>G+3&15;O=G<<4|q}else O=H>>4;return O^(M^85)}function h1(H){let O=0;if(H^=85,(H&128)!==0)H&=~(1<<7),O=-1;let M=((H&240)>>4)+4,G=0;if(M!=4)G=1<<M|(H&15)<<M-4|1<<M-5;else G=H<<1|1;return G=O===0?G:-G,G*8*-1}function c0(H){let O=new Uint8Array(H.length);for(let M=0,G=H.length;M<G;M++)O[M]=k1(H[M]);return O}function b0(H){let O=new Int16Array(H.length);for(let M=0,G=H.length;M<G;M++)O[M]=h1(H[M]);return O}var x1=[1,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7];function m1(H){let O,M,G,q;if(O=H>>8&128,O!=0)H=-H;if(H=H+132,H>32635)H=32635;return M=b1[H>>7&255],G=H>>M+3&15,q=~(O|M<<4|G),q}function r1(H){let O,M,G,q;if(H=~H,O=H&128,M=H>>4&7,G=H&15,q=d1[M]+(G<<M+3),O!=0)q=-q;return q}function d0(H){let O=new Uint8Array(H.length);for(let M=0,G=H.length;M<G;M++)O[M]=m1(H[M]);return O}function m0(H){let O=new Int16Array(H.length);for(let M=0,G=H.length;M<G;M++)O[M]=r1(H[M]);return O}var b1=[0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],d1=[0,132,396,924,1980,4092,8316,16764];function O0(H,O,M=0,G=H.length){for(let q=M;q<G;q+=O)o1(H,O,q)}var o1=function(H,O,M){O--;for(let G=0;G<O;G++){let q=H[M+G];H[M+G]=H[M+O],H[M+O]=q,O--}};function r0(H,O=0,M=H.length){let G="";for(let q=O;q<M;){let J=128,Q=191,Y=!1,U=H[q++];if(U>=0&&U<=127)G+=String.fromCharCode(U);else{let Z=0;if(U>=194&&U<=223)Z=1;else if(U>=224&&U<=239){if(Z=2,H[q]===224)J=160;if(H[q]===237)Q=159}else if(U>=240&&U<=244){if(Z=3,H[q]===240)J=144;if(H[q]===244)Q=143}else Y=!0;U=U&(1<<8-Z-1)-1;for(let K=0;K<Z;K++){if(H[q]<J||H[q]>Q)Y=!0;U=U<<6|H[q]&63,q++}if(Y)G+=String.fromCharCode(65533);else if(U<=65535)G+=String.fromCharCode(U);else U-=65536,G+=String.fromCharCode((U>>10&1023)+55296,(U&1023)+56320)}}return G}function M0(H,O,M=0){let G=0,q=H.length;while(G<q){let J=H.codePointAt(G);if(J<128)O[M]=J,M++;else{let Q=0,Y=0;if(J<=2047)Q=1,Y=192;else if(J<=65535)Q=2,Y=224;else if(J<=1114111)Q=3,Y=240,G++;O[M]=(J>>6*Q)+Y,M++;while(Q>0)O[M]=128|J>>6*(Q-1)&63,M++,Q--}G++}return M}class G0{constructor(H,O=!1){if(this.bits=H,this.offset=Math.ceil(H/8),this.max=Math.pow(2,H)-1,this.min=0,this.unpack=this.unpack_,O)this.max=Math.pow(2,H)/2-1,this.min=-this.max-1,this.unpack=this.unpackSigned_}pack(H,O,M=0){O=this.clamp_(Math.round(O));for(let G=0,q=this.offset;G<q;G++)H[M]=Math.floor(O/Math.pow(2,G*8))&255,M++;return M}unpack_(H,O=0){let M=0;for(let G=0;G<this.offset;G++)M+=H[O+G]*Math.pow(256,G);return M}unpackSigned_(H,O=0){return this.sign_(this.unpack_(H,O))}clamp_(H){if(H>this.max)return this.max;else if(H<this.min)return this.min;return H}sign_(H){if(H>this.max)H-=this.max*2+2;return H}}var q0=function(H){let O=Math.floor(H),M=H-O;if(M<0.5)return O;if(M>0.5)return O+1;return O%2?O+1:O};class u{constructor(H,O){this.offset=Math.ceil((H+O)/8),this.ebits=H,this.fbits=O,this.bias=(1<<H-1)-1,this.biasP2=Math.pow(2,this.bias+1),this.ebitsFbits=H+O,this.fbias=Math.pow(2,-(8*this.offset-1-H))}pack(H,O,M){if(Math.abs(O)>this.biasP2-this.ebitsFbits*2)O=O<0?(-Infinity):Infinity;let G=((O=+O)||1/O)<0?1:O<0?1:0;O=Math.abs(O);let q=Math.min(Math.floor(Math.log(O)/Math.LN2),1023),J=q0(O/Math.pow(2,q)*Math.pow(2,this.fbits));if(O!==O)J=Math.pow(2,this.fbits-1),q=(1<<this.ebits)-1;else if(O!==0)if(O>=Math.pow(2,1-this.bias)){if(J/Math.pow(2,this.fbits)>=2)q=q+1,J=1;if(q>this.bias)q=(1<<this.ebits)-1,J=0;else q=q+this.bias,J=q0(J)-Math.pow(2,this.fbits)}else J=q0(O/Math.pow(2,1-this.bias-this.fbits)),q=0;return this.packFloatBits_(H,M,G,q,J)}unpack(H,O){let M=(1<<this.ebits)-1,G,q="";for(let Y=this.offset-1;Y>=0;Y--){let U=H[Y+O].toString(2);q+="00000000".substring(U.length)+U}let J=q.charAt(0)=="1"?-1:1;q=q.substring(1);let Q=parseInt(q.substring(0,this.ebits),2);if(q=q.substring(this.ebits),Q==M){if(parseInt(q,2)!==0)return NaN;return J*Infinity}else if(Q===0)Q+=1,G=parseInt(q,2);else G=parseInt("1"+q,2);return J*G*this.fbias*Math.pow(2,Q-this.bias)}packFloatBits_(H,O,M,G,q){let J=[];J.push(M);for(let K=this.ebits;K>0;K-=1)J[K]=G%2?1:0,G=Math.floor(G/2);let Q=J.length;for(let K=this.fbits;K>0;K-=1)J[Q+K]=q%2?1:0,q=Math.floor(q/2);let Y=J.join(""),U=this.offset+O-1,Z=O;while(U>=O)H[U]=parseInt(Y.substring(0,8),2),Y=Y.substring(8),U--,Z++;return Z}}function D(H,O=0,M=H.length){return r0(H,O,M)}function P(H){let O=[];return M0(H,O),O}function J0(H,O,M=0){return M0(H,O,M)}function Q0(H,O,M,G=0){O=O||{};let q=o0(O.bits,O.fp,O.signed),J=Math.ceil(O.bits/8),Q=0,Y=G;for(let U=H.length;Q<U;Q++)G=q.pack(M,H[Q],G);if(O.be)O0(M,J,Y,G);return G}function S(H,O,M,G=0,q=H.length){O=O||{};let J=o0(O.bits,O.fp,O.signed);if(q=l1(H,G,q,J.offset),O.be){let Q=u1(H);if(O.be)O0(Q,J.offset,G,q);f0(Q,M,G,q,J)}else f0(H,M,G,q,J)}function r(H,O,M,G=0){return Q0([H],O,M,G)}function $(H,O){let M=[];return r(H,O,M,0),M}function y(H,O,M=0){let G=[];return S(H,O,G,M,M+Math.ceil(O.bits/8)),G[0]}var f0=function(H,O,M,G,q){let J=q.offset;for(let Q=0,Y=M;Y<G;Y+=J,Q++)O[Q]=q.unpack(H,Y)},u1=function(H){return new Uint8Array(H)},l1=function(H,O,M,G){let q=(M-O)%G;return M-q},o0=function(H,O,M){if(O&&H==32)return new u(8,23);else if(O&&H==64)return new u(11,52);return new G0(H,M)};class U0{constructor(){this.container="",this.chunkSize=0,this.format="",this.signature=null,this.head=0,this.uInt32={bits:32,be:!1},this.supported_containers=["RIFF","RIFX"]}setSignature(H){if(this.head=0,this.container=this.readString(H,4),this.supported_containers.indexOf(this.container)===-1)throw Error("Not a supported format.");this.uInt32.be=this.container==="RIFX",this.chunkSize=this.readUInt32(H),this.format=this.readString(H,4),this.signature={chunkId:this.container,chunkSize:this.chunkSize,format:this.format,subChunks:this.getSubChunksIndex_(H)}}findChunk(H,O=!1){let M=this.signature.subChunks,G=[];for(let q=0;q<M.length;q++)if(M[q].chunkId==H)if(O)G.push(M[q]);else return M[q];if(H=="LIST")return G.length?G:null;return null}readString(H,O){let M="";return M=D(H,this.head,this.head+O),this.head+=O,M}readUInt32(H){let O=y(H,this.uInt32,this.head);return this.head+=4,O}getSubChunksIndex_(H){let O=[],M=this.head;while(M<=H.length-8)O.push(this.getSubChunkIndex_(H,M)),M+=8+O[O.length-1].chunkSize,M=M%2?M+1:M;return O}getSubChunkIndex_(H,O){let M={chunkId:this.getChunkId_(H,O),chunkSize:this.getChunkSize_(H,O)};if(M.chunkId=="LIST")M.format=D(H,O+8,O+12),this.head+=4,M.subChunks=this.getSubChunksIndex_(H);else{let G=M.chunkSize%2?M.chunkSize+1:M.chunkSize;this.head=O+8+G,M.chunkData={start:O+8,end:this.head}}return M}getChunkId_(H,O){return this.head+=4,D(H,O,O+4)}getChunkSize_(H,O){return this.head+=4,y(H,this.uInt32,O+4)}}class l extends U0{constructor(){super();this.supported_containers.push("RF64"),this.fmt={chunkId:"",chunkSize:0,audioFormat:0,numChannels:0,sampleRate:0,byteRate:0,blockAlign:0,bitsPerSample:0,cbSize:0,validBitsPerSample:0,dwChannelMask:0,subformat:[]},this.fact={chunkId:"",chunkSize:0,dwSampleLength:0},this.cue={chunkId:"",chunkSize:0,dwCuePoints:0,points:[]},this.smpl={chunkId:"",chunkSize:0,dwManufacturer:0,dwProduct:0,dwSamplePeriod:0,dwMIDIUnityNote:0,dwMIDIPitchFraction:0,dwSMPTEFormat:0,dwSMPTEOffset:0,dwNumSampleLoops:0,dwSamplerData:0,loops:[]},this.bext={chunkId:"",chunkSize:0,description:"",originator:"",originatorReference:"",originationDate:"",originationTime:"",timeReference:[0,0],version:0,UMID:"",loudnessValue:0,loudnessRange:0,maxTruePeakLevel:0,maxMomentaryLoudness:0,maxShortTermLoudness:0,reserved:"",codingHistory:""},this.iXML={chunkId:"",chunkSize:0,value:""},this.ds64={chunkId:"",chunkSize:0,riffSizeHigh:0,riffSizeLow:0,dataSizeHigh:0,dataSizeLow:0,originationTime:0,sampleCountHigh:0,sampleCountLow:0},this.data={chunkId:"",chunkSize:0,samples:new Uint8Array(0)},this.LIST=[],this.junk={chunkId:"",chunkSize:0,chunkData:[]},this._PMX={chunkId:"",chunkSize:0,value:""},this.uInt16={bits:16,be:!1,signed:!1,fp:!1}}fromBuffer(H,O=!0){if(this.clearHeaders(),this.setSignature(H),this.uInt16.be=this.uInt32.be,this.format!="WAVE")throw Error('Could not find the "WAVE" format identifier');this.readDs64Chunk_(H),this.readFmtChunk_(H),this.readFactChunk_(H),this.readBextChunk_(H),this.readiXMLChunk_(H),this.readCueChunk_(H),this.readSmplChunk_(H),this.readDataChunk_(H,O),this.readJunkChunk_(H),this.readLISTChunk_(H),this.read_PMXChunk_(H)}clearHeaders(){let H=new l;Object.assign(this.fmt,H.fmt),Object.assign(this.fact,H.fact),Object.assign(this.cue,H.cue),Object.assign(this.smpl,H.smpl),Object.assign(this.bext,H.bext),Object.assign(this.iXML,H.iXML),Object.assign(this.ds64,H.ds64),Object.assign(this.data,H.data),this.LIST=[],Object.assign(this.junk,H.junk),Object.assign(this._PMX,H._PMX)}readFmtChunk_(H){let O=this.findChunk("fmt ");if(O)this.head=O.chunkData.start,this.fmt.chunkId=O.chunkId,this.fmt.chunkSize=O.chunkSize,this.fmt.audioFormat=this.readUInt16_(H),this.fmt.numChannels=this.readUInt16_(H),this.fmt.sampleRate=this.readUInt32(H),this.fmt.byteRate=this.readUInt32(H),this.fmt.blockAlign=this.readUInt16_(H),this.fmt.bitsPerSample=this.readUInt16_(H),this.readFmtExtension_(H);else throw Error('Could not find the "fmt " chunk')}readFmtExtension_(H){if(this.fmt.chunkSize>16){if(this.fmt.cbSize=this.readUInt16_(H),this.fmt.chunkSize>18){if(this.fmt.validBitsPerSample=this.readUInt16_(H),this.fmt.chunkSize>20)this.fmt.dwChannelMask=this.readUInt32(H),this.fmt.subformat=[this.readUInt32(H),this.readUInt32(H),this.readUInt32(H),this.readUInt32(H)]}}}readFactChunk_(H){let O=this.findChunk("fact");if(O)this.head=O.chunkData.start,this.fact.chunkId=O.chunkId,this.fact.chunkSize=O.chunkSize,this.fact.dwSampleLength=this.readUInt32(H)}readCueChunk_(H){let O=this.findChunk("cue ");if(O){this.head=O.chunkData.start,this.cue.chunkId=O.chunkId,this.cue.chunkSize=O.chunkSize,this.cue.dwCuePoints=this.readUInt32(H);for(let M=0;M<this.cue.dwCuePoints;M++)this.cue.points.push({dwName:this.readUInt32(H),dwPosition:this.readUInt32(H),fccChunk:this.readString(H,4),dwChunkStart:this.readUInt32(H),dwBlockStart:this.readUInt32(H),dwSampleOffset:this.readUInt32(H)})}}readSmplChunk_(H){let O=this.findChunk("smpl");if(O){this.head=O.chunkData.start,this.smpl.chunkId=O.chunkId,this.smpl.chunkSize=O.chunkSize,this.smpl.dwManufacturer=this.readUInt32(H),this.smpl.dwProduct=this.readUInt32(H),this.smpl.dwSamplePeriod=this.readUInt32(H),this.smpl.dwMIDIUnityNote=this.readUInt32(H),this.smpl.dwMIDIPitchFraction=this.readUInt32(H),this.smpl.dwSMPTEFormat=this.readUInt32(H),this.smpl.dwSMPTEOffset=this.readUInt32(H),this.smpl.dwNumSampleLoops=this.readUInt32(H),this.smpl.dwSamplerData=this.readUInt32(H);for(let M=0;M<this.smpl.dwNumSampleLoops;M++)this.smpl.loops.push({dwName:this.readUInt32(H),dwType:this.readUInt32(H),dwStart:this.readUInt32(H),dwEnd:this.readUInt32(H),dwFraction:this.readUInt32(H),dwPlayCount:this.readUInt32(H)})}}readDataChunk_(H,O){let M=this.findChunk("data");if(M){if(this.data.chunkId="data",this.data.chunkSize=M.chunkSize,O)this.data.samples=H.slice(M.chunkData.start,M.chunkData.end)}else throw Error('Could not find the "data" chunk')}readBextChunk_(H){let O=this.findChunk("bext");if(O)this.head=O.chunkData.start,this.bext.chunkId=O.chunkId,this.bext.chunkSize=O.chunkSize,this.bext.description=this.readString(H,256),this.bext.originator=this.readString(H,32),this.bext.originatorReference=this.readString(H,32),this.bext.originationDate=this.readString(H,10),this.bext.originationTime=this.readString(H,8),this.bext.timeReference=[this.readUInt32(H),this.readUInt32(H)],this.bext.version=this.readUInt16_(H),this.bext.UMID=this.readString(H,64),this.bext.loudnessValue=this.readUInt16_(H),this.bext.loudnessRange=this.readUInt16_(H),this.bext.maxTruePeakLevel=this.readUInt16_(H),this.bext.maxMomentaryLoudness=this.readUInt16_(H),this.bext.maxShortTermLoudness=this.readUInt16_(H),this.bext.reserved=this.readString(H,180),this.bext.codingHistory=this.readString(H,this.bext.chunkSize-602)}readiXMLChunk_(H){let O=this.findChunk("iXML");if(O)this.head=O.chunkData.start,this.iXML.chunkId=O.chunkId,this.iXML.chunkSize=O.chunkSize,this.iXML.value=D(H,this.head,this.head+this.iXML.chunkSize)}readDs64Chunk_(H){let O=this.findChunk("ds64");if(O)this.head=O.chunkData.start,this.ds64.chunkId=O.chunkId,this.ds64.chunkSize=O.chunkSize,this.ds64.riffSizeHigh=this.readUInt32(H),this.ds64.riffSizeLow=this.readUInt32(H),this.ds64.dataSizeHigh=this.readUInt32(H),this.ds64.dataSizeLow=this.readUInt32(H),this.ds64.originationTime=this.readUInt32(H),this.ds64.sampleCountHigh=this.readUInt32(H),this.ds64.sampleCountLow=this.readUInt32(H);else if(this.container=="RF64")throw Error('Could not find the "ds64" chunk')}readLISTChunk_(H){let O=this.findChunk("LIST",!0);if(O!==null)for(let M=0;M<O.length;M++){let G=O[M];this.LIST.push({chunkId:G.chunkId,chunkSize:G.chunkSize,format:G.format,subChunks:[]});for(let q=0;q<G.subChunks.length;q++)this.readLISTSubChunks_(G.subChunks[q],G.format,H)}}readLISTSubChunks_(H,O,M){if(O=="adtl"){if(["labl","note","ltxt"].indexOf(H.chunkId)>-1)this.readLISTadtlSubChunks_(M,H)}else if(O=="INFO")this.readLISTINFOSubChunks_(M,H)}readLISTadtlSubChunks_(H,O){this.head=O.chunkData.start;let M={chunkId:O.chunkId,chunkSize:O.chunkSize,dwName:this.readUInt32(H)};if(O.chunkId=="ltxt")M.dwSampleLength=this.readUInt32(H),M.dwPurposeID=this.readUInt32(H),M.dwCountry=this.readUInt16_(H),M.dwLanguage=this.readUInt16_(H),M.dwDialect=this.readUInt16_(H),M.dwCodePage=this.readUInt16_(H),M.value="";else M.value=this.readZSTR_(H,this.head);this.LIST[this.LIST.length-1].subChunks.push(M)}readLISTINFOSubChunks_(H,O){this.head=O.chunkData.start,this.LIST[this.LIST.length-1].subChunks.push({chunkId:O.chunkId,chunkSize:O.chunkSize,value:this.readZSTR_(H,this.head)})}readJunkChunk_(H){let O=this.findChunk("junk");if(O)this.junk={chunkId:O.chunkId,chunkSize:O.chunkSize,chunkData:[].slice.call(H.slice(O.chunkData.start,O.chunkData.end))}}read_PMXChunk_(H){let O=this.findChunk("_PMX");if(O)this.head=O.chunkData.start,this._PMX.chunkId=O.chunkId,this._PMX.chunkSize=O.chunkSize,this._PMX.value=D(H,this.head,this.head+this._PMX.chunkSize)}readZSTR_(H,O=0){for(let M=O;M<H.length;M++)if(this.head++,H[M]===0)break;return D(H,O,this.head-1)}readUInt16_(H){let O=y(H,this.uInt16,this.head);return this.head+=2,O}}function v(H,O){let M=P(H);for(let G=M.length;G<O;G++)M.push(0);return M}class Y0 extends l{toBuffer(){this.uInt16.be=this.container==="RIFX",this.uInt32.be=this.uInt16.be;let H=[this.getJunkBytes_(),this.getDs64Bytes_(),this.getBextBytes_(),this.getiXMLBytes_(),this.getFmtBytes_(),this.getFactBytes_(),P(this.data.chunkId),$(this.data.samples.length,this.uInt32),this.data.samples,this.getCueBytes_(),this.getSmplBytes_(),this.getLISTBytes_(),this.get_PMXBytes_()],O=0;for(let q=0;q<H.length;q++)O+=H[q].length;let M=new Uint8Array(O+12),G=0;G=J0(this.container,M,G),G=r(O+4,this.uInt32,M,G),G=J0(this.format,M,G);for(let q=0;q<H.length;q++)M.set(H[q],G),G+=H[q].length;return M}getBextBytes_(){let H=[];if(this.enforceBext_(),this.bext.chunkId)this.bext.chunkSize=602+this.bext.codingHistory.length,H=H.concat(P(this.bext.chunkId),$(602+this.bext.codingHistory.length,this.uInt32),v(this.bext.description,256),v(this.bext.originator,32),v(this.bext.originatorReference,32),v(this.bext.originationDate,10),v(this.bext.originationTime,8),$(this.bext.timeReference[0],this.uInt32),$(this.bext.timeReference[1],this.uInt32),$(this.bext.version,this.uInt16),v(this.bext.UMID,64),$(this.bext.loudnessValue,this.uInt16),$(this.bext.loudnessRange,this.uInt16),$(this.bext.maxTruePeakLevel,this.uInt16),$(this.bext.maxMomentaryLoudness,this.uInt16),$(this.bext.maxShortTermLoudness,this.uInt16),v(this.bext.reserved,180),v(this.bext.codingHistory,this.bext.codingHistory.length));return this.enforceByteLen_(H),H}enforceBext_(){for(let H in this.bext)if(this.bext.hasOwnProperty(H)){if(this.bext[H]&&H!="timeReference"){this.bext.chunkId="bext";break}}if(this.bext.timeReference[0]||this.bext.timeReference[1])this.bext.chunkId="bext"}getiXMLBytes_(){let H=[];if(this.iXML.chunkId){let O=P(this.iXML.value);this.iXML.chunkSize=O.length,H=H.concat(P(this.iXML.chunkId),$(this.iXML.chunkSize,this.uInt32),O)}return this.enforceByteLen_(H),H}getDs64Bytes_(){let H=[];if(this.ds64.chunkId)H=H.concat(P(this.ds64.chunkId),$(this.ds64.chunkSize,this.uInt32),$(this.ds64.riffSizeHigh,this.uInt32),$(this.ds64.riffSizeLow,this.uInt32),$(this.ds64.dataSizeHigh,this.uInt32),$(this.ds64.dataSizeLow,this.uInt32),$(this.ds64.originationTime,this.uInt32),$(this.ds64.sampleCountHigh,this.uInt32),$(this.ds64.sampleCountLow,this.uInt32));return this.enforceByteLen_(H),H}getCueBytes_(){let H=[];if(this.cue.chunkId){let O=this.getCuePointsBytes_();H=H.concat(P(this.cue.chunkId),$(O.length+4,this.uInt32),$(this.cue.dwCuePoints,this.uInt32),O)}return this.enforceByteLen_(H),H}getCuePointsBytes_(){let H=[];for(let O=0;O<this.cue.dwCuePoints;O++)H=H.concat($(this.cue.points[O].dwName,this.uInt32),$(this.cue.points[O].dwPosition,this.uInt32),P(this.cue.points[O].fccChunk),$(this.cue.points[O].dwChunkStart,this.uInt32),$(this.cue.points[O].dwBlockStart,this.uInt32),$(this.cue.points[O].dwSampleOffset,this.uInt32));return H}getSmplBytes_(){let H=[];if(this.smpl.chunkId){let O=this.getSmplLoopsBytes_();H=H.concat(P(this.smpl.chunkId),$(O.length+36,this.uInt32),$(this.smpl.dwManufacturer,this.uInt32),$(this.smpl.dwProduct,this.uInt32),$(this.smpl.dwSamplePeriod,this.uInt32),$(this.smpl.dwMIDIUnityNote,this.uInt32),$(this.smpl.dwMIDIPitchFraction,this.uInt32),$(this.smpl.dwSMPTEFormat,this.uInt32),$(this.smpl.dwSMPTEOffset,this.uInt32),$(this.smpl.dwNumSampleLoops,this.uInt32),$(this.smpl.dwSamplerData,this.uInt32),O)}return this.enforceByteLen_(H),H}getSmplLoopsBytes_(){let H=[];for(let O=0;O<this.smpl.dwNumSampleLoops;O++)H=H.concat($(this.smpl.loops[O].dwName,this.uInt32),$(this.smpl.loops[O].dwType,this.uInt32),$(this.smpl.loops[O].dwStart,this.uInt32),$(this.smpl.loops[O].dwEnd,this.uInt32),$(this.smpl.loops[O].dwFraction,this.uInt32),$(this.smpl.loops[O].dwPlayCount,this.uInt32));return H}getFactBytes_(){let H=[];if(this.fact.chunkId)H=H.concat(P(this.fact.chunkId),$(this.fact.chunkSize,this.uInt32),$(this.fact.dwSampleLength,this.uInt32));return this.enforceByteLen_(H),H}getFmtBytes_(){let H=[];if(this.fmt.chunkId){let O=H.concat(P(this.fmt.chunkId),$(this.fmt.chunkSize,this.uInt32),$(this.fmt.audioFormat,this.uInt16),$(this.fmt.numChannels,this.uInt16),$(this.fmt.sampleRate,this.uInt32),$(this.fmt.byteRate,this.uInt32),$(this.fmt.blockAlign,this.uInt16),$(this.fmt.bitsPerSample,this.uInt16),this.getFmtExtensionBytes_());return this.enforceByteLen_(O),O}throw Error('Could not find the "fmt " chunk')}getFmtExtensionBytes_(){let H=[];if(this.fmt.chunkSize>16)H=H.concat($(this.fmt.cbSize,this.uInt16));if(this.fmt.chunkSize>18)H=H.concat($(this.fmt.validBitsPerSample,this.uInt16));if(this.fmt.chunkSize>20)H=H.concat($(this.fmt.dwChannelMask,this.uInt32));if(this.fmt.chunkSize>24)H=H.concat($(this.fmt.subformat[0],this.uInt32),$(this.fmt.subformat[1],this.uInt32),$(this.fmt.subformat[2],this.uInt32),$(this.fmt.subformat[3],this.uInt32));return H}getLISTBytes_(){let H=[];for(let O=0;O<this.LIST.length;O++){let M=this.getLISTSubChunksBytes_(this.LIST[O].subChunks,this.LIST[O].format);H=H.concat(P(this.LIST[O].chunkId),$(M.length+4,this.uInt32),P(this.LIST[O].format),M)}return this.enforceByteLen_(H),H}getLISTSubChunksBytes_(H,O){let M=[];for(let G=0,q=H.length;G<q;G++){if(O=="INFO")M=M.concat(this.getLISTINFOSubChunksBytes_(H[G]));else if(O=="adtl")M=M.concat(this.getLISTadtlSubChunksBytes_(H[G]));this.enforceByteLen_(M)}return M}getLISTINFOSubChunksBytes_(H){let O=[],M=v(H.value,H.value.length);return O=O.concat(P(H.chunkId),$(M.length+1,this.uInt32),M),O.push(0),O}getLISTadtlSubChunksBytes_(H){let O=[];if(["labl","note"].indexOf(H.chunkId)>-1){let M=v(H.value,H.value.length);O=O.concat(P(H.chunkId),$(M.length+4+1,this.uInt32),$(H.dwName,this.uInt32),M),O.push(0)}else if(H.chunkId=="ltxt")O=O.concat(this.getLtxtChunkBytes_(H));return O}getLtxtChunkBytes_(H){return[].concat(P(H.chunkId),$(H.value.length+20,this.uInt32),$(H.dwName,this.uInt32),$(H.dwSampleLength,this.uInt32),$(H.dwPurposeID,this.uInt32),$(H.dwCountry,this.uInt16),$(H.dwLanguage,this.uInt16),$(H.dwDialect,this.uInt16),$(H.dwCodePage,this.uInt16),v(H.value,H.value.length))}get_PMXBytes_(){let H=[];if(this._PMX.chunkId){let O=P(this._PMX.value);this._PMX.chunkSize=O.length,H=H.concat(P(this._PMX.chunkId),$(this._PMX.chunkSize,this.uInt32),O)}return this.enforceByteLen_(H),H}getJunkBytes_(){let H=[];if(this.junk.chunkId)return H.concat(P(this.junk.chunkId),$(this.junk.chunkData.length,this.uInt32),this.junk.chunkData);return this.enforceByteLen_(H),H}enforceByteLen_(H){if(H.length%2)H.push(0)}}function u0(H){let O=[];if(H.length>0)if(H[0].constructor!==Number){O=new Float64Array(H[0].length*H.length);for(let M=0,G=H[0].length,q=0;M<G;M++)for(let J=0,Q=H.length;J<Q;J++,q++)O[q]=H[J][M]}else O=H;return O}function l0(H,O,M=Float64Array){let G=[];for(let q=0;q<O;q++)G[q]=new M(H.length/O);for(let q=0;q<O;q++)for(let J=q,Q=0;J<H.length;J+=O,Q++)G[q][Q]=H[J];return G}function p0(H,O){let M=H*O/8;if(H<1||M>65535)return!1;return!0}function p(H,O,M){let G=H*(O/8)*M;if(M<1||G>4294967295)return!1;return!0}var p1=function(H){let O=0;if(H===1)O=4;else if(H===2)O=3;else if(H===4)O=51;else if(H===6)O=63;else if(H===8)O=1599;return O};class Z0 extends Y0{constructor(){super();this.bitDepth="0",this.dataType={bits:0,be:!1},this.WAV_AUDIO_FORMATS={"4":17,"8":1,"8a":6,"8m":7,"16":1,"24":1,"32":1,"32f":3,"64":3}}fromScratch(H,O,M,G,q){q=q||{},this.clearHeaders(),this.newWavFile_(H,O,M,G,q)}fromBuffer(H,O=!0){super.fromBuffer(H,O),this.bitDepthFromFmt_(),this.updateDataType_()}toBuffer(){return this.validateWavHeader_(),super.toBuffer()}getSamples(H=!1,O=Float64Array){let M=new O(this.data.samples.length/(this.dataType.bits/8));if(S(this.data.samples,this.dataType,M,0,this.data.samples.length),!H&&this.fmt.numChannels>1)return l0(M,this.fmt.numChannels,O);return M}getSample(H){if(H=H*(this.dataType.bits/8),H+this.dataType.bits/8>this.data.samples.length)throw new Error("Range error");return y(this.data.samples.slice(H,H+this.dataType.bits/8),this.dataType)}setSample(H,O){if(H=H*(this.dataType.bits/8),H+this.dataType.bits/8>this.data.samples.length)throw new Error("Range error");r(O,this.dataType,this.data.samples,H,!0)}getiXML(){return this.iXML.value}setiXML(H){if(typeof H!=="string")throw new TypeError("iXML value must be a string.");this.iXML.value=H,this.iXML.chunkId="iXML"}get_PMX(){return this._PMX.value}set_PMX(H){if(typeof H!=="string")throw new TypeError("_PMX value must be a string.");this._PMX.value=H,this._PMX.chunkId="_PMX"}newWavFile_(H,O,M,G,q){if(!q.container)q.container="RIFF";this.container=q.container,this.bitDepth=M,G=u0(G),this.updateDataType_();let J=this.dataType.bits/8;this.data.samples=new Uint8Array(G.length*J),Q0(G,this.dataType,this.data.samples,0,!0),this.makeWavHeader_(M,H,O,J,this.data.samples.length,q),this.data.chunkId="data",this.data.chunkSize=this.data.samples.length,this.validateWavHeader_()}makeWavHeader_(H,O,M,G,q,J){if(H=="4")this.createADPCMHeader_(H,O,M,G,q,J);else if(H=="8a"||H=="8m")this.createALawMulawHeader_(H,O,M,G,q,J);else if(Object.keys(this.WAV_AUDIO_FORMATS).indexOf(H)==-1||O>2)this.createExtensibleHeader_(H,O,M,G,q,J);else this.createPCMHeader_(H,O,M,G,q,J)}createPCMHeader_(H,O,M,G,q,J){this.container=J.container,this.chunkSize=36+q,this.format="WAVE",this.bitDepth=H,this.fmt={chunkId:"fmt ",chunkSize:16,audioFormat:this.WAV_AUDIO_FORMATS[H]||65534,numChannels:O,sampleRate:M,byteRate:O*G*M,blockAlign:O*G,bitsPerSample:parseInt(H,10),cbSize:0,validBitsPerSample:0,dwChannelMask:0,subformat:[]}}createADPCMHeader_(H,O,M,G,q,J){this.createPCMHeader_(H,O,M,G,q,J),this.chunkSize=40+q,this.fmt.chunkSize=20,this.fmt.byteRate=4055,this.fmt.blockAlign=256,this.fmt.bitsPerSample=4,this.fmt.cbSize=2,this.fmt.validBitsPerSample=505,this.fact={chunkId:"fact",chunkSize:4,dwSampleLength:q*2}}createExtensibleHeader_(H,O,M,G,q,J){this.createPCMHeader_(H,O,M,G,q,J),this.chunkSize=60+q,this.fmt.chunkSize=40,this.fmt.bitsPerSample=(parseInt(H,10)-1|7)+1,this.fmt.cbSize=22,this.fmt.validBitsPerSample=parseInt(H,10),this.fmt.dwChannelMask=p1(O),this.fmt.subformat=[1,1048576,2852126848,1905997824]}createALawMulawHeader_(H,O,M,G,q,J){this.createPCMHeader_(H,O,M,G,q,J),this.chunkSize=40+q,this.fmt.chunkSize=20,this.fmt.cbSize=2,this.fmt.validBitsPerSample=8,this.fact={chunkId:"fact",chunkSize:4,dwSampleLength:q}}bitDepthFromFmt_(){if(this.fmt.audioFormat===3&&this.fmt.bitsPerSample===32)this.bitDepth="32f";else if(this.fmt.audioFormat===6)this.bitDepth="8a";else if(this.fmt.audioFormat===7)this.bitDepth="8m";else this.bitDepth=this.fmt.bitsPerSample.toString()}validateBitDepth_(){if(!this.WAV_AUDIO_FORMATS[this.bitDepth]){if(parseInt(this.bitDepth,10)>8&&parseInt(this.bitDepth,10)<54)return!0;throw new Error("Invalid bit depth.")}return!0}updateDataType_(){if(this.dataType={bits:(parseInt(this.bitDepth,10)-1|7)+1,fp:this.bitDepth=="32f"||this.bitDepth=="64",signed:this.bitDepth!="8",be:this.container=="RIFX"},["4","8a","8m"].indexOf(this.bitDepth)>-1)this.dataType.bits=8,this.dataType.signed=!1}validateWavHeader_(){if(this.validateBitDepth_(),!p0(this.fmt.numChannels,this.fmt.bitsPerSample))throw new Error("Invalid number of channels.");if(!p(this.fmt.numChannels,this.fmt.bitsPerSample,this.fmt.sampleRate))throw new Error("Invalid sample rate.")}}var i1=function(H){if(H.constructor!==String)throw new Error("Invalid tag name.");else if(H.length<4)for(let O=0,M=4-H.length;O<M;O++)H+=" ";return H};class $0 extends Z0{getTag(H){let O=this.getTagIndex_(H);if(O.TAG!==null)return this.LIST[O.LIST].subChunks[O.TAG].value;return null}setTag(H,O){H=i1(H);let M=this.getTagIndex_(H);if(M.TAG!==null)this.LIST[M.LIST].subChunks[M.TAG].chunkSize=O.length+1,this.LIST[M.LIST].subChunks[M.TAG].value=O;else if(M.LIST!==null)this.LIST[M.LIST].subChunks.push({chunkId:H,chunkSize:O.length+1,value:O});else this.LIST.push({chunkId:"LIST",chunkSize:8+O.length+1,format:"INFO",subChunks:[]}),this.LIST[this.LIST.length-1].subChunks.push({chunkId:H,chunkSize:O.length+1,value:O})}deleteTag(H){let O=this.getTagIndex_(H);if(O.TAG!==null)return this.LIST[O.LIST].subChunks.splice(O.TAG,1),!0;return!1}listTags(){let H=this.getLISTIndex("INFO"),O={};if(H!==null)for(let M=0,G=this.LIST[H].subChunks.length;M<G;M++)O[this.LIST[H].subChunks[M].chunkId]=this.LIST[H].subChunks[M].value;return O}getLISTIndex(H){for(let O=0,M=this.LIST.length;O<M;O++)if(this.LIST[O].format==H)return O;return null}getTagIndex_(H){let O={LIST:null,TAG:null};for(let M=0,G=this.LIST.length;M<G;M++)if(this.LIST[M].format=="INFO"){O.LIST=M;for(let q=0,J=this.LIST[M].subChunks.length;q<J;q++)if(this.LIST[M].subChunks[q].chunkId==H){O.TAG=q;break}break}return O}}class i extends $0{listCuePoints(){let H=this.getCuePoints_();for(let O=0,M=H.length;O<M;O++){if(H[O].position=H[O].dwSampleOffset/this.fmt.sampleRate*1000,H[O].dwSampleLength)H[O].end=H[O].dwSampleLength/this.fmt.sampleRate*1000,H[O].end+=H[O].position;else H[O].end=null;delete H[O].value}return H}setCuePoint(H){if(this.cue.chunkId="cue ",!H.label)H.label="";let O=this.getCuePoints_();if(this.clearLISTadtl_(),this.cue.points=[],H.dwSampleOffset=H.position*this.fmt.sampleRate/1000,H.dwSampleLength=0,H.end)H.dwSampleLength=H.end*this.fmt.sampleRate/1000-H.dwSampleOffset;if(O.length===0)this.setCuePoint_(H,1);else this.setCuePointInOrder_(O,H);this.cue.dwCuePoints=this.cue.points.length}deleteCuePoint(H){this.cue.chunkId="cue ";let O=this.getCuePoints_();this.clearLISTadtl_();let M=this.cue.points.length;this.cue.points=[];for(let G=0;G<M;G++)if(G+1!==H)this.setCuePoint_(O[G],G+1);if(this.cue.dwCuePoints=this.cue.points.length,this.cue.dwCuePoints)this.cue.chunkId="cue ";else this.cue.chunkId="",this.clearLISTadtl_()}updateLabel(H,O){let M=this.getLISTIndex("adtl");if(M!==null){for(let G=0,q=this.LIST[M].subChunks.length;G<q;G++)if(this.LIST[M].subChunks[G].dwName==H)this.LIST[M].subChunks[G].value=O}}getCuePoints_(){let H=[];for(let O=0;O<this.cue.points.length;O++){let M=this.cue.points[O],G=this.getDataForCuePoint_(M.dwName);G.label=G.value?G.value:"",G.dwPosition=M.dwPosition,G.fccChunk=M.fccChunk,G.dwChunkStart=M.dwChunkStart,G.dwBlockStart=M.dwBlockStart,G.dwSampleOffset=M.dwSampleOffset,H.push(G)}return H}getDataForCuePoint_(H){let O=this.getLISTIndex("adtl"),M={};if(O!==null)this.getCueDataFromLIST_(M,O,H);return M}getCueDataFromLIST_(H,O,M){for(let G=0,q=this.LIST[O].subChunks.length;G<q;G++)if(this.LIST[O].subChunks[G].dwName==M){let J=this.LIST[O].subChunks[G];H.value=J.value||H.value,H.dwName=J.dwName||0,H.dwSampleLength=J.dwSampleLength||0,H.dwPurposeID=J.dwPurposeID||0,H.dwCountry=J.dwCountry||0,H.dwLanguage=J.dwLanguage||0,H.dwDialect=J.dwDialect||0,H.dwCodePage=J.dwCodePage||0}}setCuePoint_(H,O){this.cue.points.push({dwName:O,dwPosition:H.dwPosition?H.dwPosition:0,fccChunk:H.fccChunk?H.fccChunk:"data",dwChunkStart:H.dwChunkStart?H.dwChunkStart:0,dwBlockStart:H.dwBlockStart?H.dwBlockStart:0,dwSampleOffset:H.dwSampleOffset}),this.setLabl_(H,O)}setCuePointInOrder_(H,O){let M=!1;for(let G=0;G<H.length;G++)if(H[G].dwSampleOffset>O.dwSampleOffset&&!M)this.setCuePoint_(O,G+1),this.setCuePoint_(H[G],G+2),M=!0;else this.setCuePoint_(H[G],M?G+2:G+1);if(!M)this.setCuePoint_(O,this.cue.points.length+1)}clearLISTadtl_(){for(let H=0,O=this.LIST.length;H<O;H++)if(this.LIST[H].format=="adtl")this.LIST.splice(H)}setLabl_(H,O){let M=this.getLISTIndex("adtl");if(M===null)this.LIST.push({chunkId:"LIST",chunkSize:4,format:"adtl",subChunks:[]}),M=this.LIST.length-1;if(this.setLabelText_(M,H,O),H.dwSampleLength)this.setLtxtChunk_(M,H,O)}setLabelText_(H,O,M){this.LIST[H].subChunks.push({chunkId:"labl",chunkSize:4,dwName:M,value:O.label}),this.LIST[H].chunkSize+=12}setLtxtChunk_(H,O,M){this.LIST[H].subChunks.push({chunkId:"ltxt",chunkSize:20,dwName:M,dwSampleLength:O.dwSampleLength,dwPurposeID:O.dwPurposeID||0,dwCountry:O.dwCountry||0,dwLanguage:O.dwLanguage||0,dwDialect:O.dwDialect||0,dwCodePage:O.dwCodePage||0,value:O.label}),this.LIST[H].chunkSize+=28}}var n1=function(H){return Math.exp(-H/2*H/2)},a1=function(H){return function(O){return s1(O)*H(O)}},s1=function(H){if(H===0)return 1;return Math.sin(Math.PI*H)/(Math.PI*H)};class K0{constructor(H,O,M){if(this.length_=H,this.scaleFactor_=(H-1)/O,this.interpolate=this.sinc,M.method==="point")this.interpolate=this.point;else if(M.method==="linear")this.interpolate=this.linear;else if(M.method==="cubic")this.interpolate=this.cubic;this.tangentFactor_=1-Math.max(0,Math.min(1,M.tension||0)),this.sincFilterSize_=M.sincFilterSize||1,this.kernel_=a1(M.sincWindow||n1)}point(H,O){return this.getClippedInput_(Math.round(this.scaleFactor_*H),O)}linear(H,O){H=this.scaleFactor_*H;let M=Math.floor(H);return H-=M,(1-H)*this.getClippedInput_(M,O)+H*this.getClippedInput_(M+1,O)}cubic(H,O){H=this.scaleFactor_*H;let M=Math.floor(H),G=[this.getTangent_(M,O),this.getTangent_(M+1,O)],q=[this.getClippedInput_(M,O),this.getClippedInput_(M+1,O)];H-=M;let J=H*H,Q=H*J;return(2*Q-3*J+1)*q[0]+(Q-2*J+H)*G[0]+(-2*Q+3*J)*q[1]+(Q-J)*G[1]}sinc(H,O){H=this.scaleFactor_*H;let M=Math.floor(H),G=M-this.sincFilterSize_+1,q=M+this.sincFilterSize_,J=0;for(let Q=G;Q<=q;Q++)J+=this.kernel_(H-Q)*this.getClippedInput_(Q,O);return J}getTangent_(H,O){return this.tangentFactor_*(this.getClippedInput_(H+1,O)-this.getClippedInput_(H-1,O))/2}getClippedInput_(H,O){if(0<=H&&H<this.length_)return O[H];return 0}}class z0{constructor(H,O,M){let G=2*Math.PI*M/O,q=0;this.filters=[];for(let J=0;J<=H;J++){if(J-H/2===0)this.filters[J]=G;else this.filters[J]=Math.sin(G*(J-H/2))/(J-H/2),this.filters[J]*=0.54-0.46*Math.cos(2*Math.PI*J/H);q=q+this.filters[J]}for(let J=0;J<=H;J++)this.filters[J]/=q;this.z=this.initZ_()}filter(H){this.z.buf[this.z.pointer]=H;let O=0;for(let M=0,G=this.z.buf.length;M<G;M++)O+=this.filters[M]*this.z.buf[(this.z.pointer+M)%this.z.buf.length];return this.z.pointer=(this.z.pointer+1)%this.z.buf.length,O}reset(){this.z=this.initZ_()}initZ_(){let H=[];for(let O=0;O<this.filters.length-1;O++)H.push(0);return{buf:H,pointer:0}}}class N0{constructor(H,O,M){let G=[];for(let q=0;q<H;q++)G.push(this.getCoeffs_({Fs:O,Fc:M,Q:0.5/Math.sin(Math.PI/(H*2)*(q+0.5))}));this.stages=[];for(let q=0;q<G.length;q++)this.stages[q]={b0:G[q].b[0],b1:G[q].b[1],b2:G[q].b[2],a1:G[q].a[0],a2:G[q].a[1],k:G[q].k,z:[0,0]}}filter(H){let O=H;for(let M=0,G=this.stages.length;M<G;M++)O=this.runStage_(M,O);return O}getCoeffs_(H){let O={};O.a=[],O.b=[];let M=this.preCalc_(H,O);return O.k=1,O.b.push((1-M.cw)/(2*M.a0)),O.b.push(2*O.b[0]),O.b.push(O.b[0]),O}preCalc_(H,O){let M={},G=2*Math.PI*H.Fc/H.Fs;return M.alpha=Math.sin(G)/(2*H.Q),M.cw=Math.cos(G),M.a0=1+M.alpha,O.a0=M.a0,O.a.push(-2*M.cw/M.a0),O.k=1,O.a.push((1-M.alpha)/M.a0),M}runStage_(H,O){let M=O*this.stages[H].k-this.stages[H].a1*this.stages[H].z[0]-this.stages[H].a2*this.stages[H].z[1],G=this.stages[H].b0*M+this.stages[H].b1*this.stages[H].z[0]+this.stages[H].b2*this.stages[H].z[1];return this.stages[H].z[1]=this.stages[H].z[0],this.stages[H].z[0]=M,G}reset(){for(let H=0;H<this.stages.length;H++)this.stages[H].z=[0,0]}}function E0(H,O,M,G=null){G=G||{};let q=(M-O)/O+1,J=new Float64Array(H.length*q);G.method=G.method||"cubic";let Q=new K0(H.length,J.length,{method:G.method,tension:G.tension||0,sincFilterSize:G.sincFilterSize||6,sincWindow:G.sincWindow||void 0,clip:G.clip||"mirror"});if(G.LPF===void 0)G.LPF=t1[G.method];if(G.LPF){G.LPFType=G.LPFType||"IIR";const Y=e1[G.LPFType];if(M>O){let U=new Y(G.LPForder||i0[G.LPFType],M,O/2);H3(H,J,Q,U)}else{let U=new Y(G.LPForder||i0[G.LPFType],O,M/2);O3(H,J,Q,U)}}else n0(H,J,Q);return J}var n0=function(H,O,M){for(let G=0,q=O.length;G<q;G++)O[G]=M.interpolate(G,H)},H3=function(H,O,M,G){for(let q=0,J=O.length;q<J;q++)O[q]=G.filter(M.interpolate(q,H));G.reset();for(let q=O.length-1;q>=0;q--)O[q]=G.filter(O[q])},O3=function(H,O,M,G){for(let q=0,J=H.length;q<J;q++)H[q]=G.filter(H[q]);G.reset();for(let q=H.length-1;q>=0;q--)H[q]=G.filter(H[q]);n0(H,O,M)},t1={point:!1,linear:!1,cubic:!0,sinc:!0},i0={IIR:16,FIR:71},e1={IIR:N0,FIR:z0};var f=function(H,O){let M=H/O;if(M%2)M++;return M};class F0 extends i{toRIFF(){let H=new Float64Array(f(this.data.samples.length,this.dataType.bits/8));S(this.data.samples,this.dataType,H,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,this.bitDepth,H,{container:"RIFF"})}toRIFX(){let H=new Float64Array(f(this.data.samples.length,this.dataType.bits/8));S(this.data.samples,this.dataType,H,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,this.bitDepth,H,{container:"RIFX"})}toIMAADPCM(){if(this.fmt.sampleRate!==8000)throw new Error("Only 8000 Hz files can be compressed as IMA-ADPCM.");else if(this.fmt.numChannels!==1)throw new Error("Only mono files can be compressed as IMA-ADPCM.");else{this.assure16Bit_();let H=new Int16Array(f(this.data.samples.length,2));S(this.data.samples,this.dataType,H,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"4",k0(H),{container:this.correctContainer_()})}}fromIMAADPCM(H="16"){if(this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"16",h0(this.data.samples,this.fmt.blockAlign),{container:this.correctContainer_()}),H!="16")this.toBitDepth(H)}toALaw(){this.assure16Bit_();let H=new Int16Array(f(this.data.samples.length,2));S(this.data.samples,this.dataType,H,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"8a",c0(H),{container:this.correctContainer_()})}fromALaw(H="16"){if(this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"16",b0(this.data.samples),{container:this.correctContainer_()}),H!="16")this.toBitDepth(H)}toMuLaw(){this.assure16Bit_();let H=new Int16Array(f(this.data.samples.length,2));S(this.data.samples,this.dataType,H,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"8m",d0(H),{container:this.correctContainer_()})}fromMuLaw(H="16"){if(this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"16",m0(this.data.samples),{container:this.correctContainer_()}),H!="16")this.toBitDepth(H)}toBitDepth(H,O=!0){let M=H,G=this.bitDepth;if(!O){if(H!="32f")M=this.dataType.bits.toString();G=""+this.dataType.bits}this.assureUncompressed_();let q=this.getSamples(!0),J=new Float64Array(q.length);D0(q,G,J,M),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,H,J,{container:this.correctContainer_()})}toSampleRate(H,O){this.validateResample_(H);let M=this.getSamples(),G=[];if(M.constructor===Float64Array)G=E0(M,this.fmt.sampleRate,H,O);else for(let q=0;q<M.length;q++)G.push(E0(M[q],this.fmt.sampleRate,H,O));this.fromExisting_(this.fmt.numChannels,H,this.bitDepth,G,{container:this.correctContainer_()})}validateResample_(H){if(!p(this.fmt.numChannels,this.fmt.bitsPerSample,H))throw new Error("Invalid sample rate.");else if(["4","8a","8m"].indexOf(this.bitDepth)>-1)throw new Error("wavefile can\'t change the sample rate of compressed files.")}assure16Bit_(){if(this.assureUncompressed_(),this.bitDepth!="16")this.toBitDepth("16")}assureUncompressed_(){if(this.bitDepth=="8a")this.fromALaw();else if(this.bitDepth=="8m")this.fromMuLaw();else if(this.bitDepth=="4")this.fromIMAADPCM()}correctContainer_(){return this.container=="RF64"?"RIFF":this.container}fromExisting_(H,O,M,G,q){let J=new i;Object.assign(this.fmt,J.fmt),Object.assign(this.fact,J.fact),Object.assign(this.ds64,J.ds64),Object.assign(this.data,J.data),this.newWavFile_(H,O,M,G,q)}}class h extends F0{constructor(H){super();if(H)this.fromBuffer(H)}fromBase64(H){this.fromBuffer(C0(H))}toBase64(){return w0(this.toBuffer())}toDataURI(){return"data:audio/wav;base64,"+this.toBase64()}fromDataURI(H){this.fromBase64(H.replace("data:audio/wav;base64,",""))}}import{useState as C3} from"preact/hooks";import{useEditor as g3} from"@blockcode/core";import{useState as N3} from"preact/hooks";import{useLocale as E3,useLayout as F3,useEditor as X3} from"@blockcode/core";import{IconSelector as V3,ActionButton as A3} from"@blockcode/ui";var t0=I1(s0(),1);function e0(H){return new Promise(async(O,M)=>{const G=new FileReader;G.readAsArrayBuffer(H),G.addEventListener("load",()=>{const q=new h;try{q.fromBuffer(new Uint8Array(G.result)),q.toBitDepth(8),q.toSampleRate(11025)}catch(J){M(J)}O(q)})})}async function H1(H){const O=new h,G=await new AudioContext().decodeAudioData(await H.arrayBuffer());return O.fromBuffer(new Uint8Array(t0.default(G))),O.toBitDepth(8),O.toSampleRate(11025),O}async function O1(H){const M=await(await fetch(H,{})).arrayBuffer(),G=new h;return G.fromBuffer(new Uint8Array(M)),G}function X0(H){const O=Math.floor(H/60),M=Math.floor(H%60);return`${O}:${`00${M}`.slice(-2)}.${H.toFixed(3).slice(-3)}`}function c(H=32){const O=[];for(let M=0;M<H;M++)O[M]="0123456789abcdefghijklmnopqrstuvwxyz".charAt(Math.random()*"0123456789abcdefghijklmnopqrstuvwxyz".length);return O.join("")}function x(H){const O=globalThis.document,M=O.createElement("style");M.appendChild(O.createTextNode(H)),O.head.append(M)}x("._5PgNba_selector-wrapper{background:var(--ui-secondary);width:150px;position:relative}._5PgNba_selector-items-wrapper{width:150px;min-height:100%;padding-bottom:100px}._5PgNba_selector-item{width:5rem;height:5rem;margin:.5rem auto}._5PgNba_delete-menu-item:hover{background:var(--error-primary)}._5PgNba_add-button-wrapper{background:linear-gradient(transparent,var(--ui-secondary));width:100%;height:100px;display:flex;position:absolute;bottom:0;left:0;right:0}._5PgNba_add-button{margin:.75rem auto}");var k={selectorItem:"_5PgNba_selector-item",addButton:"_5PgNba_add-button",selectorItemsWrapper:"_5PgNba_selector-items-wrapper",addButtonWrapper:"_5PgNba_add-button-wrapper",selectorWrapper:"_5PgNba_selector-wrapper",deleteMenuItem:"_5PgNba_delete-menu-item"};var M1="./assets/icon-thumb-a541e14895441e52.svg";var G1="./assets/icon-sound-14bb688cabf50625.svg";var q1="./assets/icon-search-da6ddbb0d3689046.svg";var b="./assets/icon-record-f368333f0c930073.svg";var J1="./assets/icon-surprise-8aa9e285645a254d.svg";var Q1="./assets/icon-file-upload-8698118c8522bf00.svg";import{jsx as o} from"preact/jsx-runtime";function V0({soundList:H,soundIndex:O,onSelect:M,onSetupLibrary:G}){const[q,J]=N3(!1),{getText:Q}=E3(),{createAlert:Y,removeAlert:U}=F3(),{addAsset:Z,deleteAsset:K}=X3(),{SoundsLibrary:z}=G(),N=()=>J(!0),E=()=>J(!1),A=async(V)=>{const X=c();Y("importing",{id:X});const R=await O1(`./assets/${V.id}.wav`);Z({...V,id:X,type:"audio/wav",data:R.toBase64(),sampleCount:R.data.chunkSize}),U(X),M(H.length)},T=()=>A(z.surprise()),_=()=>{const V=document.createElement("input");V.type="file",V.accept="audio/wav",V.multiple=!0,V.click(),V.addEventListener("change",async(X)=>{const R=c();Y("importing",{id:R});try{for(let L of X.target.files){const C=c(),g=L.name.slice(0,L.name.lastIndexOf(".")),B=await e0(L);console.log(B),Z({id:C,type:L.type,name:g,data:B.toBase64(),rate:B.fmt.sampleRate,sampleCount:B.data.chunkSize})}U(R)}catch(L){Y({id:R,message:Q("waveSurfer.error.formatNotSupperted","This wav format is not supported.")},2000)}})},I=()=>{Z({id:c(),type:"audio/wav",name:Q("waveSurfer.surfer.sound","Sound"),data:"UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAABErAAABAAgAZGF0YQAAAAA=",rate:11025,sampleCount:0,record:!0}),M(H.length)},F=(V)=>{K(H[V].id)};return o("div",{className:k.selectorWrapper,children:[o(V3,{displayOrder:!0,id:"paint-selector",className:k.selectorItemsWrapper,items:H.map((V,X)=>({...V,details:`${X0(V.sampleCount/V.rate||0)}`,icon:M1,order:X,className:k.selectorItem,contextMenu:[[{label:Q("waveSurfer.contextMenu.export","export"),disabled:!0}],[{label:Q("waveSurfer.contextMenu.delete","delete"),className:k.deleteMenuItem,disabled:H.length<=1,onClick:()=>F(X)}]]})),selectedIndex:O,onSelect:M,onDelete:F}),o("div",{className:k.addButtonWrapper,children:o(A3,{tooltipPlacement:"right",className:k.addButton,icon:G1,tooltip:Q("waveSurfer.actionButton.sound","Choose a Sound"),onClick:N,moreButtons:[{icon:Q1,tooltip:Q("waveSurfer.actionButton.upload","Upload Sound"),onClick:_},{icon:J1,tooltip:Q("waveSurfer.actionButton.surprise","Surprise"),onClick:T},{icon:b,tooltip:Q("waveSurfer.actionButton.record","Record"),onClick:I},{icon:q1,tooltip:Q("waveSurfer.actionButton.sound","Choose a Sound"),onClick:N}]})}),q&&z&&o(z,{onClose:E,onSelect:A})]})}var j=function(H,O,M,G){return new(M||(M=Promise))(function(q,J){function Q(Z){try{U(G.next(Z))}catch(K){J(K)}}function Y(Z){try{U(G.throw(Z))}catch(K){J(K)}}function U(Z){var K;Z.done?q(Z.value):(K=Z.value,K instanceof M?K:new M(function(z){z(K)})).then(Q,Y)}U((G=G.apply(H,O||[])).next())})},Z1=function(H,O){const M=O.xmlns?document.createElementNS(O.xmlns,H):document.createElement(H);for(let[G,q]of Object.entries(O))if(G==="children")for(let[J,Q]of Object.entries(O))typeof Q=="string"?M.appendChild(document.createTextNode(Q)):M.appendChild(Z1(J,Q));else G==="style"?Object.assign(M.style,q):G==="textContent"?M.textContent=q:M.setAttribute(G,q.toString());return M},Y1=function(H,O,M){const G=Z1(H,O||{});return M==null||M.appendChild(G),G};class m{constructor(){this.listeners={}}on(H,O,M){if(this.listeners[H]||(this.listeners[H]=new Set),this.listeners[H].add(O),M==null?void 0:M.once){const G=()=>{this.un(H,G),this.un(H,O)};return this.on(H,G),G}return()=>this.un(H,O)}un(H,O){var M;(M=this.listeners[H])===null||M===void 0||M.delete(O)}once(H,O){return this.on(H,O,{once:!0})}unAll(){this.listeners={}}emit(H,...O){this.listeners[H]&&this.listeners[H].forEach((M)=>M(...O))}}var U1={decode:function(H,O){return j(this,void 0,void 0,function*(){const M=new AudioContext({sampleRate:O});return M.decodeAudioData(H).finally(()=>M.close())})},createBuffer:function(H,O){return typeof H[0]=="number"&&(H=[H]),function(M){const G=M[0];if(G.some((q)=>q>1||q<-1)){const q=G.length;let J=0;for(let Q=0;Q<q;Q++){const Y=Math.abs(G[Q]);Y>J&&(J=Y)}for(let Q of M)for(let Y=0;Y<q;Y++)Q[Y]/=J}}(H),{duration:O,length:H[0].length,sampleRate:H[0].length/O,numberOfChannels:H.length,getChannelData:(M)=>H==null?void 0:H[M],copyFromChannel:AudioBuffer.prototype.copyFromChannel,copyToChannel:AudioBuffer.prototype.copyToChannel}}},W3=Object.freeze({__proto__:null,createElement:Y1,default:Y1}),P3={fetchBlob:function(H,O,M){return j(this,void 0,void 0,function*(){const G=yield fetch(H,M);if(G.status>=400)throw new Error(`Failed to fetch ${H}: ${G.status} (${G.statusText})`);return function(q,J){j(this,void 0,void 0,function*(){if(!q.body||!q.headers)return;const Q=q.body.getReader(),Y=Number(q.headers.get("Content-Length"))||0;let U=0;const Z=(z)=>j(this,void 0,void 0,function*(){U+=(z==null?void 0:z.length)||0;const N=Math.round(U/Y*100);J(N)}),K=()=>j(this,void 0,void 0,function*(){let z;try{z=yield Q.read()}catch(N){return}z.done||(Z(z.value),yield K())});K()})}(G.clone(),O),G.blob()})}};class $1 extends m{constructor(H){super(),this.isExternalMedia=!1,H.media?(this.media=H.media,this.isExternalMedia=!0):this.media=document.createElement("audio"),H.mediaControls&&(this.media.controls=!0),H.autoplay&&(this.media.autoplay=!0),H.playbackRate!=null&&this.onMediaEvent("canplay",()=>{H.playbackRate!=null&&(this.media.playbackRate=H.playbackRate)},{once:!0})}onMediaEvent(H,O,M){return this.media.addEventListener(H,O,M),()=>this.media.removeEventListener(H,O,M)}getSrc(){return this.media.currentSrc||this.media.src||""}revokeSrc(){const H=this.getSrc();H.startsWith("blob:")&&URL.revokeObjectURL(H)}canPlayType(H){return this.media.canPlayType(H)!==""}setSrc(H,O){if(this.getSrc()===H)return;this.revokeSrc();const M=O instanceof Blob&&this.canPlayType(O.type)?URL.createObjectURL(O):H;this.media.src=M}destroy(){this.media.pause(),this.isExternalMedia||(this.media.remove(),this.revokeSrc(),this.media.src="",this.media.load())}setMediaElement(H){this.media=H}play(){return j(this,void 0,void 0,function*(){return this.media.play()})}pause(){this.media.pause()}isPlaying(){return!this.media.paused&&!this.media.ended}setTime(H){this.media.currentTime=H}getDuration(){return this.media.duration}getCurrentTime(){return this.media.currentTime}getVolume(){return this.media.volume}setVolume(H){this.media.volume=H}getMuted(){return this.media.muted}setMuted(H){this.media.muted=H}getPlaybackRate(){return this.media.playbackRate}isSeeking(){return this.media.seeking}setPlaybackRate(H,O){O!=null&&(this.media.preservesPitch=O),this.media.playbackRate=H}getMediaElement(){return this.media}setSinkId(H){return this.media.setSinkId(H)}}class a extends m{constructor(H,O){super(),this.timeouts=[],this.isScrollable=!1,this.audioData=null,this.resizeObserver=null,this.lastContainerWidth=0,this.isDragging=!1,this.subscriptions=[],this.subscriptions=[],this.options=H;const M=this.parentFromOptionsContainer(H.container);this.parent=M;const[G,q]=this.initHtml();M.appendChild(G),this.container=G,this.scrollContainer=q.querySelector(".scroll"),this.wrapper=q.querySelector(".wrapper"),this.canvasWrapper=q.querySelector(".canvases"),this.progressWrapper=q.querySelector(".progress"),this.cursor=q.querySelector(".cursor"),O&&q.appendChild(O),this.initEvents()}parentFromOptionsContainer(H){let O;if(typeof H=="string"?O=document.querySelector(H):H instanceof HTMLElement&&(O=H),!O)throw new Error("Container not found");return O}initEvents(){const H=(M)=>{const G=this.wrapper.getBoundingClientRect(),q=M.clientX-G.left,J=M.clientY-G.top;return[q/G.width,J/G.height]};this.wrapper.addEventListener("click",(M)=>{const[G,q]=H(M);this.emit("click",G,q)}),this.wrapper.addEventListener("dblclick",(M)=>{const[G,q]=H(M);this.emit("dblclick",G,q)}),this.options.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.scrollContainer.addEventListener("scroll",()=>{const{scrollLeft:M,scrollWidth:G,clientWidth:q}=this.scrollContainer,J=M/G,Q=(M+q)/G;this.emit("scroll",J,Q)});const O=this.createDelay(100);this.resizeObserver=new ResizeObserver(()=>{O().then(()=>this.onContainerResize()).catch(()=>{})}),this.resizeObserver.observe(this.scrollContainer)}onContainerResize(){const H=this.parent.clientWidth;H===this.lastContainerWidth&&this.options.height!=="auto"||(this.lastContainerWidth=H,this.reRender())}initDrag(){this.subscriptions.push(function(H,O,M,G,q=3,J=0,Q=100){if(!H)return()=>{};const Y=matchMedia("(pointer: coarse)").matches;let U=()=>{};const Z=(K)=>{if(K.button!==J)return;K.preventDefault(),K.stopPropagation();let{clientX:z,clientY:N}=K,E=!1;const A=Date.now(),T=(X)=>{if(X.preventDefault(),X.stopPropagation(),Y&&Date.now()-A<Q)return;const{clientX:R,clientY:L}=X,C=R-z,g=L-N;if(E||Math.abs(C)>q||Math.abs(g)>q){const B=H.getBoundingClientRect(),{left:L0,top:B0}=B;E||(M==null||M(z-L0,N-B0),E=!0),O(C,g,R-L0,L-B0),z=R,N=L}},_=(X)=>{if(E){const{clientX:R,clientY:L}=X,C=H.getBoundingClientRect(),{left:g,top:B}=C;G==null||G(R-g,L-B)}U()},I=(X)=>{X.relatedTarget&&X.relatedTarget!==document.documentElement||_(X)},F=(X)=>{E&&(X.stopPropagation(),X.preventDefault())},V=(X)=>{E&&X.preventDefault()};document.addEventListener("pointermove",T),document.addEventListener("pointerup",_),document.addEventListener("pointerout",I),document.addEventListener("pointercancel",I),document.addEventListener("touchmove",V,{passive:!1}),document.addEventListener("click",F,{capture:!0}),U=()=>{document.removeEventListener("pointermove",T),document.removeEventListener("pointerup",_),document.removeEventListener("pointerout",I),document.removeEventListener("pointercancel",I),document.removeEventListener("touchmove",V),setTimeout(()=>{document.removeEventListener("click",F,{capture:!0})},10)}};return H.addEventListener("pointerdown",Z),()=>{U(),H.removeEventListener("pointerdown",Z)}}(this.wrapper,(H,O,M)=>{this.emit("drag",Math.max(0,Math.min(1,M/this.wrapper.getBoundingClientRect().width)))},(H)=>{this.isDragging=!0,this.emit("dragstart",Math.max(0,Math.min(1,H/this.wrapper.getBoundingClientRect().width)))},(H)=>{this.isDragging=!1,this.emit("dragend",Math.max(0,Math.min(1,H/this.wrapper.getBoundingClientRect().width)))}))}getHeight(H,O){var M;const G=((M=this.audioData)===null||M===void 0?void 0:M.numberOfChannels)||1;if(H==null)return 128;if(!isNaN(Number(H)))return Number(H);if(H==="auto"){const q=this.parent.clientHeight||128;return(O==null?void 0:O.every((J)=>!J.overlay))?q/G:q}return 128}initHtml(){const H=document.createElement("div"),O=H.attachShadow({mode:"open"});return O.innerHTML=`\n      <style>\n        :host {\n          user-select: none;\n          min-width: 1px;\n        }\n        :host audio {\n          display: block;\n          width: 100%;\n        }\n        :host .scroll {\n          overflow-x: auto;\n          overflow-y: hidden;\n          width: 100%;\n          position: relative;\n        }\n        :host .noScrollbar {\n          scrollbar-color: transparent;\n          scrollbar-width: none;\n        }\n        :host .noScrollbar::-webkit-scrollbar {\n          display: none;\n          -webkit-appearance: none;\n        }\n        :host .wrapper {\n          position: relative;\n          overflow: visible;\n          z-index: 2;\n        }\n        :host .canvases {\n          min-height: ${this.getHeight(this.options.height,this.options.splitChannels)}px;\n        }\n        :host .canvases > div {\n          position: relative;\n        }\n        :host canvas {\n          display: block;\n          position: absolute;\n          top: 0;\n          image-rendering: pixelated;\n        }\n        :host .progress {\n          pointer-events: none;\n          position: absolute;\n          z-index: 2;\n          top: 0;\n          left: 0;\n          width: 0;\n          height: 100%;\n          overflow: hidden;\n        }\n        :host .progress > div {\n          position: relative;\n        }\n        :host .cursor {\n          pointer-events: none;\n          position: absolute;\n          z-index: 5;\n          top: 0;\n          left: 0;\n          height: 100%;\n          border-radius: 2px;\n        }\n      </style>\n\n      <div class="scroll" part="scroll">\n        <div class="wrapper" part="wrapper">\n          <div class="canvases" part="canvases"></div>\n          <div class="progress" part="progress"></div>\n          <div class="cursor" part="cursor"></div>\n        </div>\n      </div>\n    `,[H,O]}setOptions(H){if(this.options.container!==H.container){const O=this.parentFromOptionsContainer(H.container);O.appendChild(this.container),this.parent=O}H.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.options=H,this.reRender()}getWrapper(){return this.wrapper}getScroll(){return this.scrollContainer.scrollLeft}setScroll(H){this.scrollContainer.scrollLeft=H}setScrollPercentage(H){const{scrollWidth:O}=this.scrollContainer,M=O*H;this.setScroll(M)}destroy(){var H;this.subscriptions.forEach((O)=>O()),this.container.remove(),(H=this.resizeObserver)===null||H===void 0||H.disconnect()}createDelay(H=10){let O,M;const G=()=>{O&&clearTimeout(O),M&&M()};return this.timeouts.push(G),()=>new Promise((q,J)=>{G(),M=J,O=setTimeout(()=>{O=void 0,M=void 0,q()},H)})}convertColorValues(H){if(!Array.isArray(H))return H||"";if(H.length<2)return H[0]||"";const O=document.createElement("canvas"),M=O.getContext("2d"),G=O.height*(window.devicePixelRatio||1),q=M.createLinearGradient(0,0,0,G),J=1/(H.length-1);return H.forEach((Q,Y)=>{const U=Y*J;q.addColorStop(U,Q)}),q}renderBarWaveform(H,O,M,G){const q=H[0],J=H[1]||H[0],Q=q.length,{width:Y,height:U}=M.canvas,Z=U/2,K=window.devicePixelRatio||1,z=O.barWidth?O.barWidth*K:1,N=O.barGap?O.barGap*K:O.barWidth?z/2:0,E=O.barRadius||0,A=Y/(z+N)/Q,T=E&&"roundRect"in M?"roundRect":"rect";M.beginPath();let _=0,I=0,F=0;for(let V=0;V<=Q;V++){const X=Math.round(V*A);if(X>_){const C=Math.round(I*Z*G),g=C+Math.round(F*Z*G)||1;let B=Z-C;O.barAlign==="top"?B=0:O.barAlign==="bottom"&&(B=U-g),M[T](_*(z+N),B,z,g,E),_=X,I=0,F=0}const R=Math.abs(q[V]||0),L=Math.abs(J[V]||0);R>I&&(I=R),L>F&&(F=L)}M.fill(),M.closePath()}renderLineWaveform(H,O,M,G){const q=(J)=>{const Q=H[J]||H[0],Y=Q.length,{height:U}=M.canvas,Z=U/2,K=M.canvas.width/Y;M.moveTo(0,Z);let z=0,N=0;for(let E=0;E<=Y;E++){const A=Math.round(E*K);if(A>z){const _=Z+(Math.round(N*Z*G)||1)*(J===0?-1:1);M.lineTo(z,_),z=A,N=0}const T=Math.abs(Q[E]||0);T>N&&(N=T)}M.lineTo(z,Z)};M.beginPath(),q(0),q(1),M.fill(),M.closePath()}renderWaveform(H,O,M){if(M.fillStyle=this.convertColorValues(O.waveColor),O.renderFunction)return void O.renderFunction(H,M);let G=O.barHeight||1;if(O.normalize){const q=Array.from(H[0]).reduce((J,Q)=>Math.max(J,Math.abs(Q)),0);G=q?1/q:1}O.barWidth||O.barGap||O.barAlign?this.renderBarWaveform(H,O,M,G):this.renderLineWaveform(H,O,M,G)}renderSingleCanvas(H,O,M,G,q,J,Q){const Y=window.devicePixelRatio||1,U=document.createElement("canvas");U.width=Math.round(M*Y),U.height=Math.round(G*Y),U.style.width=`${M}px`,U.style.height=`${G}px`,U.style.left=`${Math.round(q)}px`,J.appendChild(U);const Z=U.getContext("2d");if(this.renderWaveform(H,O,Z),U.width>0&&U.height>0){const K=U.cloneNode(),z=K.getContext("2d");z.drawImage(U,0,0),z.globalCompositeOperation="source-in",z.fillStyle=this.convertColorValues(O.progressColor),z.fillRect(0,0,U.width,U.height),Q.appendChild(K)}}renderMultiCanvas(H,O,M,G,q,J){return j(this,void 0,void 0,function*(){const Q=window.devicePixelRatio||1,Y=M/Q;let U=Math.min(a.MAX_CANVAS_WIDTH,this.scrollContainer.clientWidth);if(O.barWidth||O.barGap){const E=O.barWidth||0.5,A=E+(O.barGap||E/2);U%A!=0&&(U=Math.floor(U/A)*A)}const Z=(E)=>{const A=E*U,T=Math.min(Y-A,U),_=H.map((I)=>{const F=Math.floor(A/Y*I.length),V=Math.floor((A+T)/Y*I.length);return I.slice(F,V)});this.renderSingleCanvas(_,O,T,G,A,q,J)},K=Math.ceil(Y/U);if(K===1)return void Z(0);const z=this.scrollContainer.scrollLeft/Y,N=Math.floor(z*K);Z(N),Z(N+1),yield Promise.all([(()=>j(this,void 0,void 0,function*(){const E=this.createDelay();for(let A=N-1;A>=0;A--)yield E(),Z(A)}))(),(()=>j(this,void 0,void 0,function*(){const E=this.createDelay();for(let A=N+2;A<K;A++)yield E(),Z(A)}))()])})}renderChannel(H,O,M,G){return j(this,void 0,void 0,function*(){var{overlay:q}=O,J=function(Z,K){var z={};for(var N in Z)Object.prototype.hasOwnProperty.call(Z,N)&&K.indexOf(N)<0&&(z[N]=Z[N]);if(Z!=null&&typeof Object.getOwnPropertySymbols=="function"){var E=0;for(N=Object.getOwnPropertySymbols(Z);E<N.length;E++)K.indexOf(N[E])<0&&Object.prototype.propertyIsEnumerable.call(Z,N[E])&&(z[N[E]]=Z[N[E]])}return z}(O,["overlay"]);const Q=document.createElement("div"),Y=this.getHeight(J.height,J.splitChannels);Q.style.height=`${Y}px`,q&&G>0&&(Q.style.marginTop=`-${Y}px`),this.canvasWrapper.style.minHeight=`${Y}px`,this.canvasWrapper.appendChild(Q);const U=Q.cloneNode();this.progressWrapper.appendChild(U),yield this.renderMultiCanvas(H,J,M,Y,Q,U)})}render(H){return j(this,void 0,void 0,function*(){this.timeouts.forEach((Q)=>Q()),this.timeouts=[],this.canvasWrapper.innerHTML="",this.progressWrapper.innerHTML="",this.options.width!=null&&(this.scrollContainer.style.width=typeof this.options.width=="number"?`${this.options.width}px`:this.options.width);const O=window.devicePixelRatio||1,M=this.scrollContainer.clientWidth,G=Math.ceil(H.duration*(this.options.minPxPerSec||0));this.isScrollable=G>M;const q=this.options.fillParent&&!this.isScrollable,J=(q?M:G)*O;this.wrapper.style.width=q?"100%":`${G}px`,this.scrollContainer.style.overflowX=this.isScrollable?"auto":"hidden",this.scrollContainer.classList.toggle("noScrollbar",!!this.options.hideScrollbar),this.cursor.style.backgroundColor=`${this.options.cursorColor||this.options.progressColor}`,this.cursor.style.width=`${this.options.cursorWidth}px`,this.audioData=H,this.emit("render");try{if(this.options.splitChannels)yield Promise.all(Array.from({length:H.numberOfChannels}).map((Q,Y)=>{var U;const Z=Object.assign(Object.assign({},this.options),(U=this.options.splitChannels)===null||U===void 0?void 0:U[Y]);return this.renderChannel([H.getChannelData(Y)],Z,J,Y)}));else{const Q=[H.getChannelData(0)];H.numberOfChannels>1&&Q.push(H.getChannelData(1)),yield this.renderChannel(Q,this.options,J,0)}}catch(Q){return}this.emit("rendered")})}reRender(){if(!this.audioData)return;const{scrollWidth:H}=this.scrollContainer,{right:O}=this.progressWrapper.getBoundingClientRect();if(this.render(this.audioData),this.isScrollable&&H!==this.scrollContainer.scrollWidth){const{right:M}=this.progressWrapper.getBoundingClientRect();let G=M-O;G*=2,G=G<0?Math.floor(G):Math.ceil(G),G/=2,this.scrollContainer.scrollLeft+=G}}zoom(H){this.options.minPxPerSec=H,this.reRender()}scrollIntoView(H,O=!1){const{scrollLeft:M,scrollWidth:G,clientWidth:q}=this.scrollContainer,J=H*G,Q=M,Y=M+q,U=q/2;if(this.isDragging)J+30>Y?this.scrollContainer.scrollLeft+=30:J-30<Q&&(this.scrollContainer.scrollLeft-=30);else{(J<Q||J>Y)&&(this.scrollContainer.scrollLeft=J-(this.options.autoCenter?U:0));const Z=J-M-U;O&&this.options.autoCenter&&Z>0&&(this.scrollContainer.scrollLeft+=Math.min(Z,10))}{const Z=this.scrollContainer.scrollLeft,K=Z/G,z=(Z+q)/G;this.emit("scroll",K,z)}}renderProgress(H,O){if(isNaN(H))return;const M=100*H;this.canvasWrapper.style.clipPath=`polygon(${M}% 0, 100% 0, 100% 100%, ${M}% 100%)`,this.progressWrapper.style.width=`${M}%`,this.cursor.style.left=`${M}%`,this.cursor.style.transform=`translateX(-${Math.round(M)===100?this.options.cursorWidth:0}px)`,this.isScrollable&&this.options.autoScroll&&this.scrollIntoView(H,O)}exportImage(H,O,M){return j(this,void 0,void 0,function*(){const G=this.canvasWrapper.querySelectorAll("canvas");if(!G.length)throw new Error("No waveform data");if(M==="dataURL"){const q=Array.from(G).map((J)=>J.toDataURL(H,O));return Promise.resolve(q)}return Promise.all(Array.from(G).map((q)=>new Promise((J,Q)=>{q.toBlob((Y)=>{Y?J(Y):Q(new Error("Could not export image"))},H,O)})))})}}a.MAX_CANVAS_WIDTH=4000;class K1 extends m{constructor(){super(...arguments),this.unsubscribe=()=>{}}start(){this.unsubscribe=this.on("tick",()=>{requestAnimationFrame(()=>{this.emit("tick")})}),this.emit("tick")}stop(){this.unsubscribe()}destroy(){this.unsubscribe()}}class A0 extends m{constructor(H=new AudioContext){super(),this.bufferNode=null,this.playStartTime=0,this.playedDuration=0,this._muted=!1,this._playbackRate=1,this._duration=void 0,this.buffer=null,this.currentSrc="",this.paused=!0,this.crossOrigin=null,this.seeking=!1,this.autoplay=!1,this.addEventListener=this.on,this.removeEventListener=this.un,this.audioContext=H,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination)}load(){return j(this,void 0,void 0,function*(){})}get src(){return this.currentSrc}set src(H){if(this.currentSrc=H,this._duration=void 0,!H)return this.buffer=null,void this.emit("emptied");fetch(H).then((O)=>{if(O.status>=400)throw new Error(`Failed to fetch ${H}: ${O.status} (${O.statusText})`);return O.arrayBuffer()}).then((O)=>this.currentSrc!==H?null:this.audioContext.decodeAudioData(O)).then((O)=>{this.currentSrc===H&&(this.buffer=O,this.emit("loadedmetadata"),this.emit("canplay"),this.autoplay&&this.play())})}_play(){var H;if(!this.paused)return;this.paused=!1,(H=this.bufferNode)===null||H===void 0||H.disconnect(),this.bufferNode=this.audioContext.createBufferSource(),this.buffer&&(this.bufferNode.buffer=this.buffer),this.bufferNode.playbackRate.value=this._playbackRate,this.bufferNode.connect(this.gainNode);let O=this.playedDuration*this._playbackRate;O>=this.duration&&(O=0,this.playedDuration=0),this.bufferNode.start(this.audioContext.currentTime,O),this.playStartTime=this.audioContext.currentTime,this.bufferNode.onended=()=>{this.currentTime>=this.duration&&(this.pause(),this.emit("ended"))}}_pause(){var H;this.paused=!0,(H=this.bufferNode)===null||H===void 0||H.stop(),this.playedDuration+=this.audioContext.currentTime-this.playStartTime}play(){return j(this,void 0,void 0,function*(){this.paused&&(this._play(),this.emit("play"))})}pause(){this.paused||(this._pause(),this.emit("pause"))}stopAt(H){var O,M;const G=H-this.currentTime;(O=this.bufferNode)===null||O===void 0||O.stop(this.audioContext.currentTime+G),(M=this.bufferNode)===null||M===void 0||M.addEventListener("ended",()=>{this.bufferNode=null,this.pause()},{once:!0})}setSinkId(H){return j(this,void 0,void 0,function*(){return this.audioContext.setSinkId(H)})}get playbackRate(){return this._playbackRate}set playbackRate(H){this._playbackRate=H,this.bufferNode&&(this.bufferNode.playbackRate.value=H)}get currentTime(){return(this.paused?this.playedDuration:this.playedDuration+(this.audioContext.currentTime-this.playStartTime))*this._playbackRate}set currentTime(H){const O=!this.paused;O&&this._pause(),this.playedDuration=H/this._playbackRate,O&&this._play(),this.emit("seeking"),this.emit("timeupdate")}get duration(){var H,O;return(H=this._duration)!==null&&H!==void 0?H:((O=this.buffer)===null||O===void 0?void 0:O.duration)||0}set duration(H){this._duration=H}get volume(){return this.gainNode.gain.value}set volume(H){this.gainNode.gain.value=H,this.emit("volumechange")}get muted(){return this._muted}set muted(H){this._muted!==H&&(this._muted=H,this._muted?this.gainNode.disconnect():this.gainNode.connect(this.audioContext.destination))}canPlayType(H){return/^(audio|video)\//.test(H)}getGainNode(){return this.gainNode}getChannelData(){const H=[];if(!this.buffer)return H;const O=this.buffer.numberOfChannels;for(let M=0;M<O;M++)H.push(this.buffer.getChannelData(M));return H}}var j3={waveColor:"#999",progressColor:"#555",cursorWidth:1,minPxPerSec:0,fillParent:!0,interact:!0,dragToSeek:!1,autoScroll:!0,autoCenter:!0,sampleRate:8000};class d extends $1{static create(H){return new d(H)}constructor(H){const O=H.media||(H.backend==="WebAudio"?new A0:void 0);super({media:O,mediaControls:H.mediaControls,autoplay:H.autoplay,playbackRate:H.audioRate}),this.plugins=[],this.decodedData=null,this.subscriptions=[],this.mediaSubscriptions=[],this.abortController=null,this.options=Object.assign({},j3,H),this.timer=new K1;const M=O?void 0:this.getMediaElement();this.renderer=new a(this.options,M),this.initPlayerEvents(),this.initRendererEvents(),this.initTimerEvents(),this.initPlugins();const G=this.options.url||this.getSrc()||"";Promise.resolve().then(()=>{this.emit("init");const{peaks:q,duration:J}=this.options;(G||q&&J)&&this.load(G,q,J).catch(()=>null)})}updateProgress(H=this.getCurrentTime()){return this.renderer.renderProgress(H/this.getDuration(),this.isPlaying()),H}initTimerEvents(){this.subscriptions.push(this.timer.on("tick",()=>{if(!this.isSeeking()){const H=this.updateProgress();this.emit("timeupdate",H),this.emit("audioprocess",H)}}))}initPlayerEvents(){this.isPlaying()&&(this.emit("play"),this.timer.start()),this.mediaSubscriptions.push(this.onMediaEvent("timeupdate",()=>{const H=this.updateProgress();this.emit("timeupdate",H)}),this.onMediaEvent("play",()=>{this.emit("play"),this.timer.start()}),this.onMediaEvent("pause",()=>{this.emit("pause"),this.timer.stop()}),this.onMediaEvent("emptied",()=>{this.timer.stop()}),this.onMediaEvent("ended",()=>{this.emit("finish")}),this.onMediaEvent("seeking",()=>{this.emit("seeking",this.getCurrentTime())}),this.onMediaEvent("error",(H)=>{this.emit("error",H.error)}))}initRendererEvents(){this.subscriptions.push(this.renderer.on("click",(H,O)=>{this.options.interact&&(this.seekTo(H),this.emit("interaction",H*this.getDuration()),this.emit("click",H,O))}),this.renderer.on("dblclick",(H,O)=>{this.emit("dblclick",H,O)}),this.renderer.on("scroll",(H,O)=>{const M=this.getDuration();this.emit("scroll",H*M,O*M)}),this.renderer.on("render",()=>{this.emit("redraw")}),this.renderer.on("rendered",()=>{this.emit("redrawcomplete")}),this.renderer.on("dragstart",(H)=>{this.emit("dragstart",H)}),this.renderer.on("dragend",(H)=>{this.emit("dragend",H)}));{let H;this.subscriptions.push(this.renderer.on("drag",(O)=>{if(!this.options.interact)return;let M;this.renderer.renderProgress(O),clearTimeout(H),this.isPlaying()?M=0:this.options.dragToSeek===!0?M=200:typeof this.options.dragToSeek=="object"&&this.options.dragToSeek!==void 0&&(M=this.options.dragToSeek.debounceTime),H=setTimeout(()=>{this.seekTo(O)},M),this.emit("interaction",O*this.getDuration()),this.emit("drag",O)}))}}initPlugins(){var H;((H=this.options.plugins)===null||H===void 0?void 0:H.length)&&this.options.plugins.forEach((O)=>{this.registerPlugin(O)})}unsubscribePlayerEvents(){this.mediaSubscriptions.forEach((H)=>H()),this.mediaSubscriptions=[]}setOptions(H){this.options=Object.assign({},this.options,H),this.renderer.setOptions(this.options),H.audioRate&&this.setPlaybackRate(H.audioRate),H.mediaControls!=null&&(this.getMediaElement().controls=H.mediaControls)}registerPlugin(H){return H._init(this),this.plugins.push(H),this.subscriptions.push(H.once("destroy",()=>{this.plugins=this.plugins.filter((O)=>O!==H)})),H}getWrapper(){return this.renderer.getWrapper()}getScroll(){return this.renderer.getScroll()}setScroll(H){return this.renderer.setScroll(H)}setScrollTime(H){const O=H/this.getDuration();this.renderer.setScrollPercentage(O)}getActivePlugins(){return this.plugins}loadAudio(H,O,M,G){return j(this,void 0,void 0,function*(){var q;if(this.emit("load",H),!this.options.media&&this.isPlaying()&&this.pause(),this.decodedData=null,!O&&!M){const Q=this.options.fetchParams||{};window.AbortController&&!Q.signal&&(this.abortController=new AbortController,Q.signal=(q=this.abortController)===null||q===void 0?void 0:q.signal);const Y=(U)=>this.emit("loading",U);O=yield P3.fetchBlob(H,Y,Q)}this.setSrc(H,O);const J=G||this.getDuration()||(yield new Promise((Q)=>{this.onMediaEvent("loadedmetadata",()=>Q(this.getDuration()),{once:!0})}));if(!H&&!O){const Q=this.getMediaElement();Q instanceof A0&&(Q.duration=J)}if(M)this.decodedData=U1.createBuffer(M,J||0);else if(O){const Q=yield O.arrayBuffer();this.decodedData=yield U1.decode(Q,this.options.sampleRate)}this.decodedData&&(this.emit("decode",this.getDuration()),this.renderer.render(this.decodedData)),this.emit("ready",this.getDuration())})}load(H,O,M){return j(this,void 0,void 0,function*(){try{return yield this.loadAudio(H,void 0,O,M)}catch(G){throw this.emit("error",G),G}})}loadBlob(H,O,M){return j(this,void 0,void 0,function*(){try{return yield this.loadAudio("blob",H,O,M)}catch(G){throw this.emit("error",G),G}})}zoom(H){if(!this.decodedData)throw new Error("No audio loaded");this.renderer.zoom(H),this.emit("zoom",H)}getDecodedData(){return this.decodedData}exportPeaks({channels:H=2,maxLength:O=8000,precision:M=1e4}={}){if(!this.decodedData)throw new Error("The audio has not been decoded yet");const G=Math.min(H,this.decodedData.numberOfChannels),q=[];for(let J=0;J<G;J++){const Q=this.decodedData.getChannelData(J),Y=[],U=Q.length/O;for(let Z=0;Z<O;Z++){const K=Q.slice(Math.floor(Z*U),Math.ceil((Z+1)*U));let z=0;for(let N=0;N<K.length;N++){const E=K[N];Math.abs(E)>Math.abs(z)&&(z=E)}Y.push(Math.round(z*M)/M)}q.push(Y)}return q}getDuration(){let H=super.getDuration()||0;return H!==0&&H!==Infinity||!this.decodedData||(H=this.decodedData.duration),H}toggleInteraction(H){this.options.interact=H}setTime(H){super.setTime(H),this.updateProgress(H),this.emit("timeupdate",H)}seekTo(H){const O=this.getDuration()*H;this.setTime(O)}playPause(){return j(this,void 0,void 0,function*(){return this.isPlaying()?this.pause():this.play()})}stop(){this.pause(),this.setTime(0)}skip(H){this.setTime(this.getCurrentTime()+H)}empty(){this.load("",[[0]],0.001)}setMediaElement(H){this.unsubscribePlayerEvents(),super.setMediaElement(H),this.initPlayerEvents()}exportImage(){return j(this,arguments,void 0,function*(H="image/png",O=1,M="dataURL"){return this.renderer.exportImage(H,O,M)})}destroy(){var H;this.emit("destroy"),(H=this.abortController)===null||H===void 0||H.abort(),this.plugins.forEach((O)=>O.destroy()),this.subscriptions.forEach((O)=>O()),this.unsubscribePlayerEvents(),this.timer.destroy(),this.renderer.destroy(),super.destroy()}}d.BasePlugin=class extends m{constructor(H){super(),this.subscriptions=[],this.options=H}onInit(){}_init(H){this.wavesurfer=H,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((H)=>H())}},d.dom=W3;var W0=function(H,O,M,G){return new(M||(M=Promise))(function(q,J){function Q(Z){try{U(G.next(Z))}catch(K){J(K)}}function Y(Z){try{U(G.throw(Z))}catch(K){J(K)}}function U(Z){var K;Z.done?q(Z.value):(K=Z.value,K instanceof M?K:new M(function(z){z(K)})).then(Q,Y)}U((G=G.apply(H,O||[])).next())})};class P0{constructor(){this.listeners={}}on(H,O,M){if(this.listeners[H]||(this.listeners[H]=new Set),this.listeners[H].add(O),M==null?void 0:M.once){const G=()=>{this.un(H,G),this.un(H,O)};return this.on(H,G),G}return()=>this.un(H,O)}un(H,O){var M;(M=this.listeners[H])===null||M===void 0||M.delete(O)}once(H,O){return this.on(H,O,{once:!0})}unAll(){this.listeners={}}emit(H,...O){this.listeners[H]&&this.listeners[H].forEach((M)=>M(...O))}}class z1 extends P0{constructor(H){super(),this.subscriptions=[],this.options=H}onInit(){}_init(H){this.wavesurfer=H,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((H)=>H())}}class N1 extends P0{constructor(){super(...arguments),this.unsubscribe=()=>{}}start(){this.unsubscribe=this.on("tick",()=>{requestAnimationFrame(()=>{this.emit("tick")})}),this.emit("tick")}stop(){this.unsubscribe()}destroy(){this.unsubscribe()}}var I3=["audio/webm","audio/wav","audio/mpeg","audio/mp4","audio/mp3"];class s extends z1{constructor(H){var O,M,G,q;super(Object.assign(Object.assign({},H),{audioBitsPerSecond:(O=H.audioBitsPerSecond)!==null&&O!==void 0?O:128000,scrollingWaveform:(M=H.scrollingWaveform)!==null&&M!==void 0&&M,scrollingWaveformWindow:(G=H.scrollingWaveformWindow)!==null&&G!==void 0?G:5,renderRecordedAudio:(q=H.renderRecordedAudio)===null||q===void 0||q})),this.stream=null,this.mediaRecorder=null,this.dataWindow=null,this.isWaveformPaused=!1,this.lastStartTime=0,this.lastDuration=0,this.duration=0,this.timer=new N1,this.subscriptions.push(this.timer.on("tick",()=>{const J=performance.now()-this.lastStartTime;this.duration=this.isPaused()?this.duration:this.lastDuration+J,this.emit("record-progress",this.duration)}))}static create(H){return new s(H||{})}renderMicStream(H){const O=new AudioContext,M=O.createMediaStreamSource(H),G=O.createAnalyser();M.connect(G);const q=G.frequencyBinCount,J=new Float32Array(q);let Q;const Y=Math.floor((this.options.scrollingWaveformWindow||0)*O.sampleRate),U=()=>{var Z;if(this.isWaveformPaused)return void(Q=requestAnimationFrame(U));if(G.getFloatTimeDomainData(J),this.options.scrollingWaveform){const z=Math.min(Y,this.dataWindow?this.dataWindow.length+q:q),N=new Float32Array(Y);if(this.dataWindow){const E=Math.max(0,Y-this.dataWindow.length);N.set(this.dataWindow.slice(-z+q),E)}N.set(J,Y-q),this.dataWindow=N}else this.dataWindow=J;const K=this.options.scrollingWaveformWindow;this.wavesurfer&&((Z=this.originalOptions)!==null&&Z!==void 0||(this.originalOptions={cursorWidth:this.wavesurfer.options.cursorWidth,interact:this.wavesurfer.options.interact}),this.wavesurfer.options.cursorWidth=0,this.wavesurfer.options.interact=!1,this.wavesurfer.load("",[this.dataWindow],K)),Q=requestAnimationFrame(U)};return U(),{onDestroy:()=>{cancelAnimationFrame(Q),M==null||M.disconnect(),O==null||O.close()},onEnd:()=>{this.isWaveformPaused=!0,cancelAnimationFrame(Q),this.stopMic()}}}startMic(H){return W0(this,void 0,void 0,function*(){let O;try{O=yield navigator.mediaDevices.getUserMedia({audio:!(H==null?void 0:H.deviceId)||{deviceId:H.deviceId}})}catch(q){throw new Error("Error accessing the microphone: "+q.message)}const{onDestroy:M,onEnd:G}=this.renderMicStream(O);return this.subscriptions.push(this.once("destroy",M)),this.subscriptions.push(this.once("record-end",G)),this.stream=O,O})}stopMic(){this.stream&&(this.stream.getTracks().forEach((H)=>H.stop()),this.stream=null,this.mediaRecorder=null)}startRecording(H){return W0(this,void 0,void 0,function*(){const O=this.stream||(yield this.startMic(H));this.dataWindow=null;const M=this.mediaRecorder||new MediaRecorder(O,{mimeType:this.options.mimeType||I3.find((J)=>MediaRecorder.isTypeSupported(J)),audioBitsPerSecond:this.options.audioBitsPerSecond});this.mediaRecorder=M,this.stopRecording();const G=[];M.ondataavailable=(J)=>{J.data.size>0&&G.push(J.data)};const q=(J)=>{var Q;const Y=new Blob(G,{type:M.mimeType});this.emit(J,Y),this.options.renderRecordedAudio&&(this.applyOriginalOptionsIfNeeded(),(Q=this.wavesurfer)===null||Q===void 0||Q.load(URL.createObjectURL(Y)))};M.onpause=()=>q("record-pause"),M.onstop=()=>q("record-end"),M.start(),this.lastStartTime=performance.now(),this.lastDuration=0,this.duration=0,this.isWaveformPaused=!1,this.timer.start(),this.emit("record-start")})}getDuration(){return this.duration}isRecording(){var H;return((H=this.mediaRecorder)===null||H===void 0?void 0:H.state)==="recording"}isPaused(){var H;return((H=this.mediaRecorder)===null||H===void 0?void 0:H.state)==="paused"}isActive(){var H;return((H=this.mediaRecorder)===null||H===void 0?void 0:H.state)!=="inactive"}stopRecording(){var H;this.isActive()&&((H=this.mediaRecorder)===null||H===void 0||H.stop(),this.timer.stop())}pauseRecording(){var H,O;this.isRecording()&&(this.isWaveformPaused=!0,(H=this.mediaRecorder)===null||H===void 0||H.requestData(),(O=this.mediaRecorder)===null||O===void 0||O.pause(),this.timer.stop(),this.lastDuration=this.duration)}resumeRecording(){var H;this.isPaused()&&(this.isWaveformPaused=!1,(H=this.mediaRecorder)===null||H===void 0||H.resume(),this.timer.start(),this.lastStartTime=performance.now(),this.emit("record-resume"))}static getAvailableAudioDevices(){return W0(this,void 0,void 0,function*(){return navigator.mediaDevices.enumerateDevices().then((H)=>H.filter((O)=>O.kind==="audioinput"))})}destroy(){this.applyOriginalOptionsIfNeeded(),super.destroy(),this.stopRecording(),this.stopMic()}applyOriginalOptionsIfNeeded(){this.wavesurfer&&this.originalOptions&&(this.wavesurfer.options.cursorWidth=this.originalOptions.cursorWidth,this.wavesurfer.options.interact=this.originalOptions.interact,delete this.originalOptions)}}import{useRef as I0,useEffect as R3} from"preact/hooks";import{useLocale as L3,useEditor as B3} from"@blockcode/core";import{classNames as _0,Label as v3,BufferedInput as w3,Button as E1} from"@blockcode/ui";x(".AHUB0G_surfer-wrapper{padding:calc(var(--space)*1.5);border-left:1px solid var(--ui-black-transparent);color:var(--text-primary);flex-direction:column;flex:1;display:flex}.AHUB0G_surfer-wrapper.AHUB0G_disabled{opacity:.5;pointer-events:none}.AHUB0G_row{min-height:3rem;margin-bottom:.5rem;display:flex}.AHUB0G_row-fill{padding-top:calc(var(--space)*2.5);border-top:1px dashed var(--ui-black-transparent);flex-direction:row;flex:1}.AHUB0G_row-right{margin-right:var(--space);justify-content:right}.AHUB0G_row:last-child{min-height:unset;margin-bottom:0}.AHUB0G_group{margin-right:calc(var(--space)*1.5);flex-direction:row;align-items:center;display:inline-flex}.AHUB0G_dashed-border{border-right:1px dashed var(--ui-black-transparent);padding-right:var(--space)}.AHUB0G_name-input{width:8rem}.AHUB0G_large-input{width:4rem}.AHUB0G_tool-icon{margin-right:var(--space);width:2rem;height:2rem}.AHUB0G_label-image{vertical-align:middle;margin-right:calc(var(--space)/2)}.AHUB0G_button{width:calc(2rem + 2px);height:calc(2rem + 2px);padding:.375rem}.AHUB0G_button-icon{width:100%;height:100%;margin:auto}.AHUB0G_group-button{border-left:none;border-radius:0}.AHUB0G_group-button-first{border-top-right-radius:0;border-bottom-right-radius:0}.AHUB0G_group-button-last{border-left:none;border-top-left-radius:0;border-bottom-left-radius:0}.AHUB0G_group-button-toggled-off{filter:saturate(0)}.AHUB0G_label-button{border:0;font-weight:400}.AHUB0G_label-button.AHUB0G_selected{background:var(--motion-primary);color:var(--ui-white)}.AHUB0G_label-button.AHUB0G_selected .AHUB0G_button-icon{filter:brightness(0)invert()}.AHUB0G_play-button,.AHUB0G_record-button{cursor:pointer;margin:0 var(--space);border:0;border-radius:100%;width:3rem;height:3rem;padding:.75rem}.AHUB0G_play-button{background:var(--motion-primary)}.AHUB0G_record-button{background:var(--red-primary)}.AHUB0G_wave-box-wrapper{margin:20px var(--space);border:1px solid var(--ui-black-transparent);border-radius:calc(var(--space)*.8);background:hsl(from var(--sound-primary)h s l/.15);flex:1;min-height:160px;position:relative;overflow:hidden}");var W={groupButtonToggledOff:"AHUB0G_group-button-toggled-off",groupButtonFirst:"AHUB0G_group-button-first",toolIcon:"AHUB0G_tool-icon",surferWrapper:"AHUB0G_surfer-wrapper",buttonIcon:"AHUB0G_button-icon",rowRight:"AHUB0G_row-right",disabled:"AHUB0G_disabled",button:"AHUB0G_button",selected:"AHUB0G_selected",playButton:"AHUB0G_play-button",labelImage:"AHUB0G_label-image",rowFill:"AHUB0G_row-fill",dashedBorder:"AHUB0G_dashed-border",row:"AHUB0G_row",groupButton:"AHUB0G_group-button",waveBoxWrapper:"AHUB0G_wave-box-wrapper",largeInput:"AHUB0G_large-input",groupButtonLast:"AHUB0G_group-button-last",labelButton:"AHUB0G_label-button",group:"AHUB0G_group",recordButton:"AHUB0G_record-button",nameInput:"AHUB0G_name-input"};var t="./assets/icon-play-af382a3aaf569574.svg";var j0="./assets/icon-stop-cac05cfb77c72465.svg";import{jsx as w} from"preact/jsx-runtime";function T0({soundList:H,soundIndex:O}){const M=I0(),G=I0(),q=I0(),{getText:J}=L3(),{modifyAsset:Q}=B3(),Y=H[O],U=!Y;if(M.ws)M.ws.stop(),M.ws.setTime(0),setTimeout(()=>{M.ws.setOptions({cursorColor:"hsla(215, 100%, 65%, 0)",cursorWidth:0})});if(M.record)M.record.soundAsset=Y;if(G.current)G.current.src=t,G.current.title=J("waveSurfer.surfer.play","Play");if(q.current)q.current.src=b,q.current.title=J("waveSurfer.surfer.record","Record");const Z=(F,V)=>{Q({...Y,[F]:V})},K=()=>{if(M.ws){if(M.ws.isPlaying())M.ws.stop();else if(Y.sampleCount>0)M.ws.play()}if(q.current)setTimeout(()=>{const F=q.current.parentElement.parentElement;if(F.disabled=M.ws.isPlaying(),M.ws.isPlaying())F.classList.add(W.groupButtonToggledOff);else F.classList.remove(W.groupButtonToggledOff)})},z=()=>{if(G.current)G.current.src=j0,G.current.title=J("waveSurfer.surfer.stop","Stop");if(M.ws)M.ws.setOptions({cursorColor:"hsla(215, 100%, 65%, 1)",cursorWidth:1});if(q.current){const F=q.current.parentElement.parentElement;F.disabled=!1,F.classList.remove(W.groupButtonToggledOff)}},N=()=>{if(G.current){if(G.current.src=t,G.current.title=J("waveSurfer.surfer.play","Play"),M.ws)M.ws.setTime(0),setTimeout(()=>{M.ws.setOptions({cursorColor:"hsla(215, 100%, 65%, 0)",cursorWidth:0})})}if(q.current){q.current.src=b,q.current.title=J("waveSurfer.surfer.record","Record");const F=q.current.parentElement.parentElement;F.disabled=!1,F.classList.remove(W.groupButtonToggledOff)}},E=()=>{if(M.ws&&!M.record.isRecording())M.ws.setOptions({cursorColor:"hsla(215, 100%, 65%, 1)",cursorWidth:1})},A=()=>{if(q.current)q.current.src=j0,q.current.title=J("waveSurfer.surfer.stop","Stop");if(G.current){const F=G.current.parentElement.parentElement;F.disabled=!0,F.classList.add(W.groupButtonToggledOff)}};let T;const _=()=>{if(M.record)if(M.record.isRecording())M.record.stopRecording(),M.record.stopMic(),clearTimeout(T);else M.record.startRecording(),T=setTimeout(_,1e4)},I=async(F)=>{const V=await H1(F);if(Q({...M.record.soundAsset,data:V.toBase64(),sampleCount:V.data.chunkSize}),G.current){const X=G.current.parentElement.parentElement;X.disabled=!1,X.classList.remove(W.groupButtonToggledOff)}};if(Y&&M.ws){if(M.ws.isPlaying())M.ws.stop();if(M.ws.empty(),Y.sampleCount>0)M.ws.load(`data:${Y.type};base64,${Y.data}`)}return R3(()=>{if(M.current){if(M.ws=d.create({container:M.current,dragToSeek:!0,height:"auto",waveColor:"hsla(300, 48%, 50%, 1)",progressColor:"hsla(300, 48%, 50%, 0.8)",cursorColor:"hsla(215, 100%, 65%, 0)",cursorWidth:0}),M.record=M.ws.registerPlugin(s.create()),M.ws.on("play",z),M.ws.on("pause",N),M.ws.on("finish",N),M.ws.on("seeking",E),M.record.on("record-start",A),M.record.on("record-end",I),Y){if(M.ws.empty(),Y.sampleCount>0)M.ws.load(`data:${Y.type};base64,${Y.data}`);M.record.soundAsset=Y}}return()=>{if(M.ws)M.ws.destroy()}},[M]),w("div",{className:_0(W.surferWrapper,{[W.disabled]:U}),children:[w("div",{className:W.row,children:w("div",{className:W.group,children:w(v3,{text:J("waveSurfer.surfer.sound","Sound"),children:w(w3,{disabled:U,className:W.nameInput,placeholder:J("waveSurfer.surfer.name","name"),onSubmit:(F)=>Z("name",F),value:Y?Y.name:J("waveSurfer.surfer.sound","Sound")})})})}),w("div",{className:W.row,children:w("div",{ref:M,className:W.waveBoxWrapper})}),w("div",{className:W.row,children:[w(E1,{className:_0(W.button,W.playButton,{[W.groupButtonToggledOff]:U}),onClick:K,children:w("img",{ref:G,src:t,className:W.buttonIcon,title:J("waveSurfer.surfer.play","Play")})}),Y&&Y.record&&w(E1,{className:_0(W.button,W.recordButton,{[W.groupButtonToggledOff]:U}),onClick:_,children:w("img",{ref:q,src:b,className:W.buttonIcon,title:J("waveSurfer.surfer.record","Record")})})]})]})}x(".adcUka_wave-surfer-wrapper{background:var(--ui-white);border-radius:inherit;flex-grow:1;display:flex}");var F1={waveSurferWrapper:"adcUka_wave-surfer-wrapper"};function S3({onSetupLibrary:H}){const[O,M]=C3(0),{assetList:G}=g3(),q=G.filter((Q)=>/^audio\//.test(Q.type)),J=q.findLastIndex((Q)=>Q.record&&Q.sampleCount===0);if(J!==-1)M(J);return R0("div",{className:F1.waveSurferWrapper,children:[R0(V0,{soundList:q,soundIndex:O,onSelect:M,onSetupLibrary:H}),R0(T0,{soundList:q,soundIndex:O})]})}import{jsx as R0} from"preact/jsx-runtime";var X1={"waveSurfer.contextMenu.export":"export","waveSurfer.contextMenu.delete":"delete","waveSurfer.actionButton.upload":"Upload Sound","waveSurfer.actionButton.surprise":"Surprise","waveSurfer.actionButton.record":"Record","waveSurfer.actionButton.sound":"Choose a Sound","waveSurfer.surfer.sound":"Sound","waveSurfer.surfer.play":"Play","waveSurfer.surfer.record":"Record","waveSurfer.surfer.stop":"Stop","waveSurfer.surfer.name":"name","waveSurfer.error.formatNotSupperted":"This wav format is not supported."};var V1={"waveSurfer.contextMenu.export":"\u5BFC\u51FA","waveSurfer.contextMenu.delete":"\u5220\u9664","waveSurfer.actionButton.upload":"\u4E0A\u4F20\u58F0\u97F3","waveSurfer.actionButton.surprise":"\u968F\u673A","waveSurfer.actionButton.record":"\u5F55\u5236","waveSurfer.actionButton.sound":"\u9009\u62E9\u4E00\u4E2A\u58F0\u97F3","waveSurfer.surfer.sound":"\u58F0\u97F3","waveSurfer.surfer.play":"\u64AD\u653E","waveSurfer.surfer.record":"\u5F55\u97F3","waveSurfer.surfer.stop":"\u505C\u6B62","waveSurfer.surfer.name":"\u540D\u79F0","waveSurfer.error.formatNotSupperted":"\u58F0\u97F3\u6587\u4EF6\u683C\u5F0F\u4E0D\u652F\u6301\u3002"};var c2={en:X1,"zh-Hans":V1};export{c2 as locales,S3 as WaveSurfer,h as WaveFile};
