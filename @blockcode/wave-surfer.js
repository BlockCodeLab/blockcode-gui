var Cr=Object.create;var{getPrototypeOf:ur,defineProperty:Fo,getOwnPropertyNames:Hr}=Object;var ar=Object.prototype.hasOwnProperty;var Gr=(o,r,t)=>{t=o!=null?Cr(ur(o)):{};let i=r||!o||!o.__esModule?Fo(t,"default",{value:o,enumerable:!0}):t;for(let n of Hr(o))if(!ar.call(i,n))Fo(i,n,{get:()=>o[n],enumerable:!0});return i};var Ur=(o,r)=>()=>(r||o((r={exports:{}}).exports,r),r.exports);var fo=Ur((Zi,ko)=>{ko.exports=nt;function nt(o,r){r=r||{};var{numberOfChannels:t,sampleRate:i}=o,n=r.float32?3:1,h=n===3?32:16,d;if(t===2)d=dt(o.getChannelData(0),o.getChannelData(1));else d=o.getChannelData(0);return ht(d,n,i,t,h)}function ht(o,r,t,i,n){var h=n/8,d=i*h,c=new ArrayBuffer(44+o.length*h),s=new DataView(c);if(m(s,0,"RIFF"),s.setUint32(4,36+o.length*h,!0),m(s,8,"WAVE"),m(s,12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,r,!0),s.setUint16(22,i,!0),s.setUint32(24,t,!0),s.setUint32(28,t*d,!0),s.setUint16(32,d,!0),s.setUint16(34,n,!0),m(s,36,"data"),s.setUint32(40,o.length*h,!0),r===1)st(s,44,o);else ct(s,44,o);return c}function dt(o,r){var t=o.length+r.length,i=new Float32Array(t),n=0,h=0;while(n<t)i[n++]=o[h],i[n++]=r[h],h++;return i}function ct(o,r,t){for(var i=0;i<t.length;i++,r+=4)o.setFloat32(r,t[i],!0)}function st(o,r,t){for(var i=0;i<t.length;i++,r+=2){var n=Math.max(-1,Math.min(1,t[i]));o.setInt16(r,n<0?n*32768:n*32767,!0)}}function m(o,r,t){for(var i=0;i<t.length;i++)o.setUint8(r+i,t.charCodeAt(i))}});function Io(o){let r="";for(let t=0;t<o.length;t+=3)r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[o[t]>>2],r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(o[t]&3)<<4|o[t+1]>>4],r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[(o[t+1]&15)<<2|o[t+2]>>6],r+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[o[t+2]&63];if(o.length%3===2)r=r.substring(0,r.length-1)+"=";else if(o.length%3===1)r=r.substring(0,r.length-2)+"==";return r}function To(o){let r=new Uint8Array(256);for(let n=0;n<64;n++)r["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charCodeAt(n)]=n;let t=o.length*0.75;if(o[o.length-1]==="="){if(t--,o[o.length-2]==="=")t--}let i=new Uint8Array(t);for(let n=0,h=0;n<o.length;n+=4){let d=r[o.charCodeAt(n)],c=r[o.charCodeAt(n+1)],s=r[o.charCodeAt(n+2)],e=r[o.charCodeAt(n+3)];i[h++]=d<<2|c>>4,i[h++]=(c&15)<<4|s>>2,i[h++]=(s&3)<<6|e&63}return i}function Lo(o,r,t,i){if(["32f","64"].indexOf(r)>-1&&["32f","64"].indexOf(i)>-1){t.set(o);return}Ro(r),Ro(i);let n=Ir(r,i),h={oldMin:Math.pow(2,parseInt(r,10))/2,newMin:Math.pow(2,parseInt(i,10))/2,oldMax:Math.pow(2,parseInt(r,10))/2-1,newMax:Math.pow(2,parseInt(i,10))/2-1};_o(r,o,!0);for(let d=0,c=o.length;d<c;d++)t[d]=n(o[d],h);_o(i,t,!1)}function Sr(o,r){if(o>0)o=parseInt(o/r.oldMax*r.newMax,10);else o=parseInt(o/r.oldMin*r.newMin,10);return o}function Pr(o,r){return parseInt(o>0?o*r.newMax:o*r.newMin,10)}function Fr(o,r){return o>0?o/r.oldMax:o/r.oldMin}function Ir(o,r){let t=function(i){return i};if(o!=r)if(["32f","64"].includes(o))t=Pr;else if(["32f","64"].includes(r))t=Fr;else t=Sr;return t}function Ro(o){if(o!="32f"&&o!="64"&&(parseInt(o,10)<"8"||parseInt(o,10)>"53"))throw new Error("Invalid bit depth.")}function _o(o,r,t){if(o=="8"){let i=t?-128:128;for(let n=0,h=r.length;n<h;n++)r[n]=r[n]+=i}}var Zo=[-1,-1,-1,-1,2,4,6,8,-1,-1,-1,-1,2,4,6,8],oo=[7,8,9,10,11,12,13,14,16,17,19,21,23,25,28,31,34,37,41,45,50,55,60,66,73,80,88,97,107,118,130,143,157,173,190,209,230,253,279,307,337,371,408,449,494,544,598,658,724,796,876,963,1060,1166,1282,1411,1552,1707,1878,2066,2272,2499,2749,3024,3327,3660,4026,4428,4871,5358,5894,6484,7132,7845,8630,9493,10442,11487,12635,13899,15289,16818,18500,20350,22385,24623,27086,29794,32767];function Yo(o){let r={index:0,predicted:0,step:7},t=new Uint8Array(o.length),i=[],n=0,h=0;for(let c=0,s=o.length;c<s;c++){if(c%505==0&&c!=0)t.set(Tr(i,r),n),n+=256,i=[],h++;i.push(o[c])}let d=o.length/2;if(d%2)d++;return t.slice(0,d+512+h*4)}function qo(o,r=256){let t={index:0,predicted:0,step:7},i=new Int16Array(o.length*2),n=[],h=0;for(let d=0,c=o.length;d<c;d++){if(d%r==0&&d!=0){let s=Rr(n,t);i.set(s,h),h+=s.length,n=[]}n.push(o[d])}return i}function Tr(o,r){let t=Zr(o[0],r);for(let i=3,n=o.length;i<n;i+=2){let h=p(o[i],r),d=p(o[i+1],r);t.push(d<<4|h)}return t}function Rr(o,r){r.predicted=_r(o[1]<<8|o[0]),r.index=o[2],r.step=oo[r.index];let t=[r.predicted,r.predicted];for(let i=4,n=o.length;i<n;i++){let h=o[i],d=h>>4,c=d<<4^h;t.push($o(c,r)),t.push($o(d,r))}return t}function _r(o){return o>32768?o-65536:o}function p(o,r){let t=o-r.predicted,i=0;if(t>=0)i=0;else i=8,t=-t;let n=oo[r.index],h=n>>3;if(t>n)i|=4,t-=n,h+=n;if(n>>=1,t>n)i|=2,t-=n,h+=n;if(n>>=1,t>n)i|=1,h+=n;return Lr(i,h,r),i}function Lr(o,r,t){if(o&8)t.predicted-=r;else t.predicted+=r;if(t.predicted<-32768)t.predicted=-32768;else if(t.predicted>32767)t.predicted=32767;if(t.index+=Zo[o&7],t.index<0)t.index=0;else if(t.index>88)t.index=88}function $o(o,r){let t=0;if(o&4)t+=r.step;if(o&2)t+=r.step>>1;if(o&1)t+=r.step>>2;if(t+=r.step>>3,o&8)t=-t;if(r.predicted+=t,r.predicted>32767)r.predicted=32767;else if(r.predicted<-32767)r.predicted=-32767;return $r(o,r),r.predicted}function $r(o,r){if(r.index+=Zo[o],r.index<0)r.index=0;else if(r.index>88)r.index=88;r.step=oo[r.index]}function Zr(o,r){p(o,r);let t=[];return t.push(o&255),t.push(o>>8&255),t.push(r.index),t.push(0),t}var qr=[1,1,2,2,3,3,3,3,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7];function Br(o){let r;o=o==-32768?-32767:o;let t=~o>>8&128;if(!t)o=o*-1;if(o>32635)o=32635;if(o>=256){let i=qr[o>>8&127],n=o>>i+3&15;r=i<<4|n}else r=o>>4;return r^(t^85)}function zr(o){let r=0;if(o^=85,(o&128)!==0)o&=-129,r=-1;let t=((o&240)>>4)+4,i=0;if(t!=4)i=1<<t|(o&15)<<t-4|1<<t-5;else i=o<<1|1;return i=r===0?i:-i,i*8*-1}function Bo(o){let r=new Uint8Array(o.length);for(let t=0,i=o.length;t<i;t++)r[t]=Br(o[t]);return r}function zo(o){let r=new Int16Array(o.length);for(let t=0,i=o.length;t<i;t++)r[t]=zr(o[t]);return r}var Kr=[0,0,1,1,2,2,2,2,3,3,3,3,3,3,3,3,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7],Jr=[0,132,396,924,1980,4092,8316,16764];function Xr(o){let r,t,i,n;if(r=o>>8&128,r!=0)o=-o;if(o=o+132,o>32635)o=32635;return t=Kr[o>>7&255],i=o>>t+3&15,n=~(r|t<<4|i),n}function Vr(o){let r,t,i,n;if(o=~o,r=o&128,t=o>>4&7,i=o&15,n=Jr[t]+(i<<t+3),r!=0)n=-n;return n}function Qo(o){let r=new Uint8Array(o.length);for(let t=0,i=o.length;t<i;t++)r[t]=Xr(o[t]);return r}function Ko(o){let r=new Int16Array(o.length);for(let t=0,i=o.length;t<i;t++)r[t]=Vr(o[t]);return r}function ro(o,r,t=0,i=o.length){for(let n=t;n<i;n+=r)yr(o,r,n)}function yr(o,r,t){r--;for(let i=0;i<r;i++){let n=o[t+i];o[t+i]=o[t+r],o[t+r]=n,r--}}function Jo(o,r=0,t=o.length){let i="";for(let n=r;n<t;){let h=128,d=191,c=!1,s=o[n++];if(s>=0&&s<=127)i+=String.fromCharCode(s);else{let e=0;if(s>=194&&s<=223)e=1;else if(s>=224&&s<=239){if(e=2,o[n]===224)h=160;if(o[n]===237)d=159}else if(s>=240&&s<=244){if(e=3,o[n]===240)h=144;if(o[n]===244)d=143}else c=!0;s=s&(1<<8-e-1)-1;for(let v=0;v<e;v++){if(o[n]<h||o[n]>d)c=!0;s=s<<6|o[n]&63,n++}if(c)i+=String.fromCharCode(65533);else if(s<=65535)i+=String.fromCharCode(s);else s-=65536,i+=String.fromCharCode((s>>10&1023)+55296,(s&1023)+56320)}}return i}function to(o,r,t=0){let i=0,n=o.length;while(i<n){let h=o.codePointAt(i);if(h<128)r[t]=h,t++;else{let d=0,c=0;if(h<=2047)d=1,c=192;else if(h<=65535)d=2,c=224;else if(h<=1114111)d=3,c=240,i++;r[t]=(h>>6*d)+c,t++;while(d>0)r[t]=128|h>>6*(d-1)&63,t++,d--}i++}return t}class io{constructor(o,r=!1){if(this.bits=o,this.offset=Math.ceil(o/8),this.max=Math.pow(2,o)-1,this.min=0,this.unpack=this.unpack_,r)this.max=Math.pow(2,o)/2-1,this.min=-this.max-1,this.unpack=this.unpackSigned_}pack(o,r,t=0){r=this.clamp_(Math.round(r));for(let i=0,n=this.offset;i<n;i++)o[t]=Math.floor(r/Math.pow(2,i*8))&255,t++;return t}unpack_(o,r=0){let t=0;for(let i=0;i<this.offset;i++)t+=o[r+i]*Math.pow(256,i);return t}unpackSigned_(o,r=0){return this.sign_(this.unpack_(o,r))}clamp_(o){if(o>this.max)return this.max;else if(o<this.min)return this.min;return o}sign_(o){if(o>this.max)o-=this.max*2+2;return o}}class j{constructor(o,r){this.offset=Math.ceil((o+r)/8),this.ebits=o,this.fbits=r,this.bias=(1<<o-1)-1,this.biasP2=Math.pow(2,this.bias+1),this.ebitsFbits=o+r,this.fbias=Math.pow(2,-(8*this.offset-1-o))}pack(o,r,t){if(Math.abs(r)>this.biasP2-this.ebitsFbits*2)r=r<0?-1/0:1/0;let i=((r=+r)||1/r)<0?1:r<0?1:0;r=Math.abs(r);let n=Math.min(Math.floor(Math.log(r)/Math.LN2),1023),h=no(r/Math.pow(2,n)*Math.pow(2,this.fbits));if(r!==r)h=Math.pow(2,this.fbits-1),n=(1<<this.ebits)-1;else if(r!==0)if(r>=Math.pow(2,1-this.bias)){if(h/Math.pow(2,this.fbits)>=2)n=n+1,h=1;if(n>this.bias)n=(1<<this.ebits)-1,h=0;else n=n+this.bias,h=no(h)-Math.pow(2,this.fbits)}else h=no(r/Math.pow(2,1-this.bias-this.fbits)),n=0;return this.packFloatBits_(o,t,i,n,h)}unpack(o,r){let t=(1<<this.ebits)-1,i,n="";for(let c=this.offset-1;c>=0;c--){let s=o[c+r].toString(2);n+="00000000".substring(s.length)+s}let h=n.charAt(0)=="1"?-1:1;n=n.substring(1);let d=parseInt(n.substring(0,this.ebits),2);if(n=n.substring(this.ebits),d==t){if(parseInt(n,2)!==0)return NaN;return h*(1/0)}else if(d===0)d+=1,i=parseInt(n,2);else i=parseInt("1"+n,2);return h*i*this.fbias*Math.pow(2,d-this.bias)}packFloatBits_(o,r,t,i,n){let h=[];h.push(t);for(let v=this.ebits;v>0;v-=1)h[v]=i%2?1:0,i=Math.floor(i/2);let d=h.length;for(let v=this.fbits;v>0;v-=1)h[d+v]=n%2?1:0,n=Math.floor(n/2);let c=h.join(""),s=this.offset+r-1,e=r;while(s>=r)o[s]=parseInt(c.substring(0,8),2),c=c.substring(8),s--,e++;return e}}function no(o){let r=Math.floor(o),t=o-r;if(t<0.5)return r;if(t>0.5)return r+1;return r%2?r+1:r}function L(o,r=0,t=o.length){return Jo(o,r,t)}function H(o){let r=[];return to(o,r),r}function ho(o,r,t=0){return to(o,r,t)}function co(o,r,t,i=0){r=r||{};let n=Vo(r.bits,r.fp,r.signed),h=Math.ceil(r.bits/8),d=0,c=i;for(let s=o.length;d<s;d++)i=n.pack(t,o[d],i);if(r.be)ro(t,h,c,i);return i}function _(o,r,t,i=0,n=o.length){r=r||{};let h=Vo(r.bits,r.fp,r.signed);if(n=Dr(o,i,n,h.offset),r.be){let d=xr(o);if(r.be)ro(d,h.offset,i,n);Xo(d,t,i,n,h)}else Xo(o,t,i,n,h)}function X(o,r,t,i=0){return co([o],r,t,i)}function l(o,r){let t=[];return X(o,r,t,0),t}function $(o,r,t=0){let i=[];return _(o,r,i,t,t+Math.ceil(r.bits/8)),i[0]}function Xo(o,r,t,i,n){let h=n.offset;for(let d=0,c=t;c<i;c+=h,d++)r[d]=n.unpack(o,c)}function xr(o){return new Uint8Array(o)}function Dr(o,r,t,i){let n=(t-r)%i;return t-n}function Vo(o,r,t){if(r&&o==32)return new j(8,23);else if(r&&o==64)return new j(11,52);return new io(o,t)}class so{constructor(){this.container="",this.chunkSize=0,this.format="",this.signature=null,this.head=0,this.uInt32={bits:32,be:!1},this.supported_containers=["RIFF","RIFX"]}setSignature(o){if(this.head=0,this.container=this.readString(o,4),this.supported_containers.indexOf(this.container)===-1)throw Error("Not a supported format.");this.uInt32.be=this.container==="RIFX",this.chunkSize=this.readUInt32(o),this.format=this.readString(o,4),this.signature={chunkId:this.container,chunkSize:this.chunkSize,format:this.format,subChunks:this.getSubChunksIndex_(o)}}findChunk(o,r=!1){let t=this.signature.subChunks,i=[];for(let n=0;n<t.length;n++)if(t[n].chunkId==o)if(r)i.push(t[n]);else return t[n];if(o=="LIST")return i.length?i:null;return null}readString(o,r){let t="";return t=L(o,this.head,this.head+r),this.head+=r,t}readUInt32(o){let r=$(o,this.uInt32,this.head);return this.head+=4,r}getSubChunksIndex_(o){let r=[],t=this.head;while(t<=o.length-8)r.push(this.getSubChunkIndex_(o,t)),t+=8+r[r.length-1].chunkSize,t=t%2?t+1:t;return r}getSubChunkIndex_(o,r){let t={chunkId:this.getChunkId_(o,r),chunkSize:this.getChunkSize_(o,r)};if(t.chunkId=="LIST")t.format=L(o,r+8,r+12),this.head+=4,t.subChunks=this.getSubChunksIndex_(o);else{let i=t.chunkSize%2?t.chunkSize+1:t.chunkSize;this.head=r+8+i,t.chunkData={start:r+8,end:this.head}}return t}getChunkId_(o,r){return this.head+=4,L(o,r,r+4)}getChunkSize_(o,r){return this.head+=4,$(o,this.uInt32,r+4)}}class y extends so{constructor(){super();this.supported_containers.push("RF64"),this.fmt={chunkId:"",chunkSize:0,audioFormat:0,numChannels:0,sampleRate:0,byteRate:0,blockAlign:0,bitsPerSample:0,cbSize:0,validBitsPerSample:0,dwChannelMask:0,subformat:[]},this.fact={chunkId:"",chunkSize:0,dwSampleLength:0},this.cue={chunkId:"",chunkSize:0,dwCuePoints:0,points:[]},this.smpl={chunkId:"",chunkSize:0,dwManufacturer:0,dwProduct:0,dwSamplePeriod:0,dwMIDIUnityNote:0,dwMIDIPitchFraction:0,dwSMPTEFormat:0,dwSMPTEOffset:0,dwNumSampleLoops:0,dwSamplerData:0,loops:[]},this.bext={chunkId:"",chunkSize:0,description:"",originator:"",originatorReference:"",originationDate:"",originationTime:"",timeReference:[0,0],version:0,UMID:"",loudnessValue:0,loudnessRange:0,maxTruePeakLevel:0,maxMomentaryLoudness:0,maxShortTermLoudness:0,reserved:"",codingHistory:""},this.iXML={chunkId:"",chunkSize:0,value:""},this.ds64={chunkId:"",chunkSize:0,riffSizeHigh:0,riffSizeLow:0,dataSizeHigh:0,dataSizeLow:0,originationTime:0,sampleCountHigh:0,sampleCountLow:0},this.data={chunkId:"",chunkSize:0,samples:new Uint8Array(0)},this.LIST=[],this.junk={chunkId:"",chunkSize:0,chunkData:[]},this._PMX={chunkId:"",chunkSize:0,value:""},this.uInt16={bits:16,be:!1,signed:!1,fp:!1}}fromBuffer(o,r=!0){if(this.clearHeaders(),this.setSignature(o),this.uInt16.be=this.uInt32.be,this.format!="WAVE")throw Error('Could not find the "WAVE" format identifier');this.readDs64Chunk_(o),this.readFmtChunk_(o),this.readFactChunk_(o),this.readBextChunk_(o),this.readiXMLChunk_(o),this.readCueChunk_(o),this.readSmplChunk_(o),this.readDataChunk_(o,r),this.readJunkChunk_(o),this.readLISTChunk_(o),this.read_PMXChunk_(o)}clearHeaders(){let o=new y;Object.assign(this.fmt,o.fmt),Object.assign(this.fact,o.fact),Object.assign(this.cue,o.cue),Object.assign(this.smpl,o.smpl),Object.assign(this.bext,o.bext),Object.assign(this.iXML,o.iXML),Object.assign(this.ds64,o.ds64),Object.assign(this.data,o.data),this.LIST=[],Object.assign(this.junk,o.junk),Object.assign(this._PMX,o._PMX)}readFmtChunk_(o){let r=this.findChunk("fmt ");if(r)this.head=r.chunkData.start,this.fmt.chunkId=r.chunkId,this.fmt.chunkSize=r.chunkSize,this.fmt.audioFormat=this.readUInt16_(o),this.fmt.numChannels=this.readUInt16_(o),this.fmt.sampleRate=this.readUInt32(o),this.fmt.byteRate=this.readUInt32(o),this.fmt.blockAlign=this.readUInt16_(o),this.fmt.bitsPerSample=this.readUInt16_(o),this.readFmtExtension_(o);else throw Error('Could not find the "fmt " chunk')}readFmtExtension_(o){if(this.fmt.chunkSize>16){if(this.fmt.cbSize=this.readUInt16_(o),this.fmt.chunkSize>18){if(this.fmt.validBitsPerSample=this.readUInt16_(o),this.fmt.chunkSize>20)this.fmt.dwChannelMask=this.readUInt32(o),this.fmt.subformat=[this.readUInt32(o),this.readUInt32(o),this.readUInt32(o),this.readUInt32(o)]}}}readFactChunk_(o){let r=this.findChunk("fact");if(r)this.head=r.chunkData.start,this.fact.chunkId=r.chunkId,this.fact.chunkSize=r.chunkSize,this.fact.dwSampleLength=this.readUInt32(o)}readCueChunk_(o){let r=this.findChunk("cue ");if(r){this.head=r.chunkData.start,this.cue.chunkId=r.chunkId,this.cue.chunkSize=r.chunkSize,this.cue.dwCuePoints=this.readUInt32(o);for(let t=0;t<this.cue.dwCuePoints;t++)this.cue.points.push({dwName:this.readUInt32(o),dwPosition:this.readUInt32(o),fccChunk:this.readString(o,4),dwChunkStart:this.readUInt32(o),dwBlockStart:this.readUInt32(o),dwSampleOffset:this.readUInt32(o)})}}readSmplChunk_(o){let r=this.findChunk("smpl");if(r){this.head=r.chunkData.start,this.smpl.chunkId=r.chunkId,this.smpl.chunkSize=r.chunkSize,this.smpl.dwManufacturer=this.readUInt32(o),this.smpl.dwProduct=this.readUInt32(o),this.smpl.dwSamplePeriod=this.readUInt32(o),this.smpl.dwMIDIUnityNote=this.readUInt32(o),this.smpl.dwMIDIPitchFraction=this.readUInt32(o),this.smpl.dwSMPTEFormat=this.readUInt32(o),this.smpl.dwSMPTEOffset=this.readUInt32(o),this.smpl.dwNumSampleLoops=this.readUInt32(o),this.smpl.dwSamplerData=this.readUInt32(o);for(let t=0;t<this.smpl.dwNumSampleLoops;t++)this.smpl.loops.push({dwName:this.readUInt32(o),dwType:this.readUInt32(o),dwStart:this.readUInt32(o),dwEnd:this.readUInt32(o),dwFraction:this.readUInt32(o),dwPlayCount:this.readUInt32(o)})}}readDataChunk_(o,r){let t=this.findChunk("data");if(t){if(this.data.chunkId="data",this.data.chunkSize=t.chunkSize,r)this.data.samples=o.slice(t.chunkData.start,t.chunkData.end)}else throw Error('Could not find the "data" chunk')}readBextChunk_(o){let r=this.findChunk("bext");if(r)this.head=r.chunkData.start,this.bext.chunkId=r.chunkId,this.bext.chunkSize=r.chunkSize,this.bext.description=this.readString(o,256),this.bext.originator=this.readString(o,32),this.bext.originatorReference=this.readString(o,32),this.bext.originationDate=this.readString(o,10),this.bext.originationTime=this.readString(o,8),this.bext.timeReference=[this.readUInt32(o),this.readUInt32(o)],this.bext.version=this.readUInt16_(o),this.bext.UMID=this.readString(o,64),this.bext.loudnessValue=this.readUInt16_(o),this.bext.loudnessRange=this.readUInt16_(o),this.bext.maxTruePeakLevel=this.readUInt16_(o),this.bext.maxMomentaryLoudness=this.readUInt16_(o),this.bext.maxShortTermLoudness=this.readUInt16_(o),this.bext.reserved=this.readString(o,180),this.bext.codingHistory=this.readString(o,this.bext.chunkSize-602)}readiXMLChunk_(o){let r=this.findChunk("iXML");if(r)this.head=r.chunkData.start,this.iXML.chunkId=r.chunkId,this.iXML.chunkSize=r.chunkSize,this.iXML.value=L(o,this.head,this.head+this.iXML.chunkSize)}readDs64Chunk_(o){let r=this.findChunk("ds64");if(r)this.head=r.chunkData.start,this.ds64.chunkId=r.chunkId,this.ds64.chunkSize=r.chunkSize,this.ds64.riffSizeHigh=this.readUInt32(o),this.ds64.riffSizeLow=this.readUInt32(o),this.ds64.dataSizeHigh=this.readUInt32(o),this.ds64.dataSizeLow=this.readUInt32(o),this.ds64.originationTime=this.readUInt32(o),this.ds64.sampleCountHigh=this.readUInt32(o),this.ds64.sampleCountLow=this.readUInt32(o);else if(this.container=="RF64")throw Error('Could not find the "ds64" chunk')}readLISTChunk_(o){let r=this.findChunk("LIST",!0);if(r!==null)for(let t=0;t<r.length;t++){let i=r[t];this.LIST.push({chunkId:i.chunkId,chunkSize:i.chunkSize,format:i.format,subChunks:[]});for(let n=0;n<i.subChunks.length;n++)this.readLISTSubChunks_(i.subChunks[n],i.format,o)}}readLISTSubChunks_(o,r,t){if(r=="adtl"){if(["labl","note","ltxt"].indexOf(o.chunkId)>-1)this.readLISTadtlSubChunks_(t,o)}else if(r=="INFO")this.readLISTINFOSubChunks_(t,o)}readLISTadtlSubChunks_(o,r){this.head=r.chunkData.start;let t={chunkId:r.chunkId,chunkSize:r.chunkSize,dwName:this.readUInt32(o)};if(r.chunkId=="ltxt")t.dwSampleLength=this.readUInt32(o),t.dwPurposeID=this.readUInt32(o),t.dwCountry=this.readUInt16_(o),t.dwLanguage=this.readUInt16_(o),t.dwDialect=this.readUInt16_(o),t.dwCodePage=this.readUInt16_(o),t.value="";else t.value=this.readZSTR_(o,this.head);this.LIST[this.LIST.length-1].subChunks.push(t)}readLISTINFOSubChunks_(o,r){this.head=r.chunkData.start,this.LIST[this.LIST.length-1].subChunks.push({chunkId:r.chunkId,chunkSize:r.chunkSize,value:this.readZSTR_(o,this.head)})}readJunkChunk_(o){let r=this.findChunk("junk");if(r)this.junk={chunkId:r.chunkId,chunkSize:r.chunkSize,chunkData:[].slice.call(o.slice(r.chunkData.start,r.chunkData.end))}}read_PMXChunk_(o){let r=this.findChunk("_PMX");if(r)this.head=r.chunkData.start,this._PMX.chunkId=r.chunkId,this._PMX.chunkSize=r.chunkSize,this._PMX.value=L(o,this.head,this.head+this._PMX.chunkSize)}readZSTR_(o,r=0){for(let t=r;t<o.length;t++)if(this.head++,o[t]===0)break;return L(o,r,this.head-1)}readUInt16_(o){let r=$(o,this.uInt16,this.head);return this.head+=2,r}}function F(o,r){let t=H(o);for(let i=t.length;i<r;i++)t.push(0);return t}class eo extends y{toBuffer(){this.uInt16.be=this.container==="RIFX",this.uInt32.be=this.uInt16.be;let o=[this.getJunkBytes_(),this.getDs64Bytes_(),this.getBextBytes_(),this.getiXMLBytes_(),this.getFmtBytes_(),this.getFactBytes_(),H(this.data.chunkId),l(this.data.samples.length,this.uInt32),this.data.samples,this.getCueBytes_(),this.getSmplBytes_(),this.getLISTBytes_(),this.get_PMXBytes_()],r=0;for(let n=0;n<o.length;n++)r+=o[n].length;let t=new Uint8Array(r+12),i=0;i=ho(this.container,t,i),i=X(r+4,this.uInt32,t,i),i=ho(this.format,t,i);for(let n=0;n<o.length;n++)t.set(o[n],i),i+=o[n].length;return t}getBextBytes_(){let o=[];if(this.enforceBext_(),this.bext.chunkId)this.bext.chunkSize=602+this.bext.codingHistory.length,o=o.concat(H(this.bext.chunkId),l(602+this.bext.codingHistory.length,this.uInt32),F(this.bext.description,256),F(this.bext.originator,32),F(this.bext.originatorReference,32),F(this.bext.originationDate,10),F(this.bext.originationTime,8),l(this.bext.timeReference[0],this.uInt32),l(this.bext.timeReference[1],this.uInt32),l(this.bext.version,this.uInt16),F(this.bext.UMID,64),l(this.bext.loudnessValue,this.uInt16),l(this.bext.loudnessRange,this.uInt16),l(this.bext.maxTruePeakLevel,this.uInt16),l(this.bext.maxMomentaryLoudness,this.uInt16),l(this.bext.maxShortTermLoudness,this.uInt16),F(this.bext.reserved,180),F(this.bext.codingHistory,this.bext.codingHistory.length));return this.enforceByteLen_(o),o}enforceBext_(){for(let o in this.bext)if(this.bext.hasOwnProperty(o)){if(this.bext[o]&&o!="timeReference"){this.bext.chunkId="bext";break}}if(this.bext.timeReference[0]||this.bext.timeReference[1])this.bext.chunkId="bext"}getiXMLBytes_(){let o=[];if(this.iXML.chunkId){let r=H(this.iXML.value);this.iXML.chunkSize=r.length,o=o.concat(H(this.iXML.chunkId),l(this.iXML.chunkSize,this.uInt32),r)}return this.enforceByteLen_(o),o}getDs64Bytes_(){let o=[];if(this.ds64.chunkId)o=o.concat(H(this.ds64.chunkId),l(this.ds64.chunkSize,this.uInt32),l(this.ds64.riffSizeHigh,this.uInt32),l(this.ds64.riffSizeLow,this.uInt32),l(this.ds64.dataSizeHigh,this.uInt32),l(this.ds64.dataSizeLow,this.uInt32),l(this.ds64.originationTime,this.uInt32),l(this.ds64.sampleCountHigh,this.uInt32),l(this.ds64.sampleCountLow,this.uInt32));return this.enforceByteLen_(o),o}getCueBytes_(){let o=[];if(this.cue.chunkId){let r=this.getCuePointsBytes_();o=o.concat(H(this.cue.chunkId),l(r.length+4,this.uInt32),l(this.cue.dwCuePoints,this.uInt32),r)}return this.enforceByteLen_(o),o}getCuePointsBytes_(){let o=[];for(let r=0;r<this.cue.dwCuePoints;r++)o=o.concat(l(this.cue.points[r].dwName,this.uInt32),l(this.cue.points[r].dwPosition,this.uInt32),H(this.cue.points[r].fccChunk),l(this.cue.points[r].dwChunkStart,this.uInt32),l(this.cue.points[r].dwBlockStart,this.uInt32),l(this.cue.points[r].dwSampleOffset,this.uInt32));return o}getSmplBytes_(){let o=[];if(this.smpl.chunkId){let r=this.getSmplLoopsBytes_();o=o.concat(H(this.smpl.chunkId),l(r.length+36,this.uInt32),l(this.smpl.dwManufacturer,this.uInt32),l(this.smpl.dwProduct,this.uInt32),l(this.smpl.dwSamplePeriod,this.uInt32),l(this.smpl.dwMIDIUnityNote,this.uInt32),l(this.smpl.dwMIDIPitchFraction,this.uInt32),l(this.smpl.dwSMPTEFormat,this.uInt32),l(this.smpl.dwSMPTEOffset,this.uInt32),l(this.smpl.dwNumSampleLoops,this.uInt32),l(this.smpl.dwSamplerData,this.uInt32),r)}return this.enforceByteLen_(o),o}getSmplLoopsBytes_(){let o=[];for(let r=0;r<this.smpl.dwNumSampleLoops;r++)o=o.concat(l(this.smpl.loops[r].dwName,this.uInt32),l(this.smpl.loops[r].dwType,this.uInt32),l(this.smpl.loops[r].dwStart,this.uInt32),l(this.smpl.loops[r].dwEnd,this.uInt32),l(this.smpl.loops[r].dwFraction,this.uInt32),l(this.smpl.loops[r].dwPlayCount,this.uInt32));return o}getFactBytes_(){let o=[];if(this.fact.chunkId)o=o.concat(H(this.fact.chunkId),l(this.fact.chunkSize,this.uInt32),l(this.fact.dwSampleLength,this.uInt32));return this.enforceByteLen_(o),o}getFmtBytes_(){let o=[];if(this.fmt.chunkId){let r=o.concat(H(this.fmt.chunkId),l(this.fmt.chunkSize,this.uInt32),l(this.fmt.audioFormat,this.uInt16),l(this.fmt.numChannels,this.uInt16),l(this.fmt.sampleRate,this.uInt32),l(this.fmt.byteRate,this.uInt32),l(this.fmt.blockAlign,this.uInt16),l(this.fmt.bitsPerSample,this.uInt16),this.getFmtExtensionBytes_());return this.enforceByteLen_(r),r}throw Error('Could not find the "fmt " chunk')}getFmtExtensionBytes_(){let o=[];if(this.fmt.chunkSize>16)o=o.concat(l(this.fmt.cbSize,this.uInt16));if(this.fmt.chunkSize>18)o=o.concat(l(this.fmt.validBitsPerSample,this.uInt16));if(this.fmt.chunkSize>20)o=o.concat(l(this.fmt.dwChannelMask,this.uInt32));if(this.fmt.chunkSize>24)o=o.concat(l(this.fmt.subformat[0],this.uInt32),l(this.fmt.subformat[1],this.uInt32),l(this.fmt.subformat[2],this.uInt32),l(this.fmt.subformat[3],this.uInt32));return o}getLISTBytes_(){let o=[];for(let r=0;r<this.LIST.length;r++){let t=this.getLISTSubChunksBytes_(this.LIST[r].subChunks,this.LIST[r].format);o=o.concat(H(this.LIST[r].chunkId),l(t.length+4,this.uInt32),H(this.LIST[r].format),t)}return this.enforceByteLen_(o),o}getLISTSubChunksBytes_(o,r){let t=[];for(let i=0,n=o.length;i<n;i++){if(r=="INFO")t=t.concat(this.getLISTINFOSubChunksBytes_(o[i]));else if(r=="adtl")t=t.concat(this.getLISTadtlSubChunksBytes_(o[i]));this.enforceByteLen_(t)}return t}getLISTINFOSubChunksBytes_(o){let r=[],t=F(o.value,o.value.length);return r=r.concat(H(o.chunkId),l(t.length+1,this.uInt32),t),r.push(0),r}getLISTadtlSubChunksBytes_(o){let r=[];if(["labl","note"].indexOf(o.chunkId)>-1){let t=F(o.value,o.value.length);r=r.concat(H(o.chunkId),l(t.length+4+1,this.uInt32),l(o.dwName,this.uInt32),t),r.push(0)}else if(o.chunkId=="ltxt")r=r.concat(this.getLtxtChunkBytes_(o));return r}getLtxtChunkBytes_(o){return[].concat(H(o.chunkId),l(o.value.length+20,this.uInt32),l(o.dwName,this.uInt32),l(o.dwSampleLength,this.uInt32),l(o.dwPurposeID,this.uInt32),l(o.dwCountry,this.uInt16),l(o.dwLanguage,this.uInt16),l(o.dwDialect,this.uInt16),l(o.dwCodePage,this.uInt16),F(o.value,o.value.length))}get_PMXBytes_(){let o=[];if(this._PMX.chunkId){let r=H(this._PMX.value);this._PMX.chunkSize=r.length,o=o.concat(H(this._PMX.chunkId),l(this._PMX.chunkSize,this.uInt32),r)}return this.enforceByteLen_(o),o}getJunkBytes_(){let o=[];if(this.junk.chunkId)return o.concat(H(this.junk.chunkId),l(this.junk.chunkData.length,this.uInt32),this.junk.chunkData);return this.enforceByteLen_(o),o}enforceByteLen_(o){if(o.length%2)o.push(0)}}function jo(o){let r=[];if(o.length>0)if(o[0].constructor!==Number){r=new Float64Array(o[0].length*o.length);for(let t=0,i=o[0].length,n=0;t<i;t++)for(let h=0,d=o.length;h<d;h++,n++)r[n]=o[h][t]}else r=o;return r}function yo(o,r,t=Float64Array){let i=[];for(let n=0;n<r;n++)i[n]=new t(o.length/r);for(let n=0;n<r;n++)for(let h=n,d=0;h<o.length;h+=r,d++)i[n][d]=o[h];return i}function xo(o,r){let t=o*r/8;if(o<1||t>65535)return!1;return!0}function x(o,r,t){let i=o*(r/8)*t;if(t<1||i>4294967295)return!1;return!0}class lo extends eo{constructor(){super();this.bitDepth="0",this.dataType={bits:0,be:!1},this.WAV_AUDIO_FORMATS={"4":17,"8":1,"8a":6,"8m":7,"16":1,"24":1,"32":1,"32f":3,"64":3}}fromScratch(o,r,t,i,n){n=n||{},this.clearHeaders(),this.newWavFile_(o,r,t,i,n)}fromBuffer(o,r=!0){super.fromBuffer(o,r),this.bitDepthFromFmt_(),this.updateDataType_()}toBuffer(){return this.validateWavHeader_(),super.toBuffer()}getSamples(o=!1,r=Float64Array){let t=new r(this.data.samples.length/(this.dataType.bits/8));if(_(this.data.samples,this.dataType,t,0,this.data.samples.length),!o&&this.fmt.numChannels>1)return yo(t,this.fmt.numChannels,r);return t}getSample(o){if(o=o*(this.dataType.bits/8),o+this.dataType.bits/8>this.data.samples.length)throw new Error("Range error");return $(this.data.samples.slice(o,o+this.dataType.bits/8),this.dataType)}setSample(o,r){if(o=o*(this.dataType.bits/8),o+this.dataType.bits/8>this.data.samples.length)throw new Error("Range error");X(r,this.dataType,this.data.samples,o,!0)}getiXML(){return this.iXML.value}setiXML(o){if(typeof o!=="string")throw new TypeError("iXML value must be a string.");this.iXML.value=o,this.iXML.chunkId="iXML"}get_PMX(){return this._PMX.value}set_PMX(o){if(typeof o!=="string")throw new TypeError("_PMX value must be a string.");this._PMX.value=o,this._PMX.chunkId="_PMX"}newWavFile_(o,r,t,i,n){if(!n.container)n.container="RIFF";this.container=n.container,this.bitDepth=t,i=jo(i),this.updateDataType_();let h=this.dataType.bits/8;this.data.samples=new Uint8Array(i.length*h),co(i,this.dataType,this.data.samples,0,!0),this.makeWavHeader_(t,o,r,h,this.data.samples.length,n),this.data.chunkId="data",this.data.chunkSize=this.data.samples.length,this.validateWavHeader_()}makeWavHeader_(o,r,t,i,n,h){if(o=="4")this.createADPCMHeader_(o,r,t,i,n,h);else if(o=="8a"||o=="8m")this.createALawMulawHeader_(o,r,t,i,n,h);else if(Object.keys(this.WAV_AUDIO_FORMATS).indexOf(o)==-1||r>2)this.createExtensibleHeader_(o,r,t,i,n,h);else this.createPCMHeader_(o,r,t,i,n,h)}createPCMHeader_(o,r,t,i,n,h){this.container=h.container,this.chunkSize=36+n,this.format="WAVE",this.bitDepth=o,this.fmt={chunkId:"fmt ",chunkSize:16,audioFormat:this.WAV_AUDIO_FORMATS[o]||65534,numChannels:r,sampleRate:t,byteRate:r*i*t,blockAlign:r*i,bitsPerSample:parseInt(o,10),cbSize:0,validBitsPerSample:0,dwChannelMask:0,subformat:[]}}createADPCMHeader_(o,r,t,i,n,h){this.createPCMHeader_(o,r,t,i,n,h),this.chunkSize=40+n,this.fmt.chunkSize=20,this.fmt.byteRate=4055,this.fmt.blockAlign=256,this.fmt.bitsPerSample=4,this.fmt.cbSize=2,this.fmt.validBitsPerSample=505,this.fact={chunkId:"fact",chunkSize:4,dwSampleLength:n*2}}createExtensibleHeader_(o,r,t,i,n,h){this.createPCMHeader_(o,r,t,i,n,h),this.chunkSize=60+n,this.fmt.chunkSize=40,this.fmt.bitsPerSample=(parseInt(o,10)-1|7)+1,this.fmt.cbSize=22,this.fmt.validBitsPerSample=parseInt(o,10),this.fmt.dwChannelMask=mr(r),this.fmt.subformat=[1,1048576,2852126848,1905997824]}createALawMulawHeader_(o,r,t,i,n,h){this.createPCMHeader_(o,r,t,i,n,h),this.chunkSize=40+n,this.fmt.chunkSize=20,this.fmt.cbSize=2,this.fmt.validBitsPerSample=8,this.fact={chunkId:"fact",chunkSize:4,dwSampleLength:n}}bitDepthFromFmt_(){if(this.fmt.audioFormat===3&&this.fmt.bitsPerSample===32)this.bitDepth="32f";else if(this.fmt.audioFormat===6)this.bitDepth="8a";else if(this.fmt.audioFormat===7)this.bitDepth="8m";else this.bitDepth=this.fmt.bitsPerSample.toString()}validateBitDepth_(){if(!this.WAV_AUDIO_FORMATS[this.bitDepth]){if(parseInt(this.bitDepth,10)>8&&parseInt(this.bitDepth,10)<54)return!0;throw new Error("Invalid bit depth.")}return!0}updateDataType_(){if(this.dataType={bits:(parseInt(this.bitDepth,10)-1|7)+1,fp:this.bitDepth=="32f"||this.bitDepth=="64",signed:this.bitDepth!="8",be:this.container=="RIFX"},["4","8a","8m"].indexOf(this.bitDepth)>-1)this.dataType.bits=8,this.dataType.signed=!1}validateWavHeader_(){if(this.validateBitDepth_(),!xo(this.fmt.numChannels,this.fmt.bitsPerSample))throw new Error("Invalid number of channels.");if(!x(this.fmt.numChannels,this.fmt.bitsPerSample,this.fmt.sampleRate))throw new Error("Invalid sample rate.")}}function mr(o){let r=0;if(o===1)r=4;else if(o===2)r=3;else if(o===4)r=51;else if(o===6)r=63;else if(o===8)r=1599;return r}class vo extends lo{getTag(o){let r=this.getTagIndex_(o);if(r.TAG!==null)return this.LIST[r.LIST].subChunks[r.TAG].value;return null}setTag(o,r){o=kr(o);let t=this.getTagIndex_(o);if(t.TAG!==null)this.LIST[t.LIST].subChunks[t.TAG].chunkSize=r.length+1,this.LIST[t.LIST].subChunks[t.TAG].value=r;else if(t.LIST!==null)this.LIST[t.LIST].subChunks.push({chunkId:o,chunkSize:r.length+1,value:r});else this.LIST.push({chunkId:"LIST",chunkSize:8+r.length+1,format:"INFO",subChunks:[]}),this.LIST[this.LIST.length-1].subChunks.push({chunkId:o,chunkSize:r.length+1,value:r})}deleteTag(o){let r=this.getTagIndex_(o);if(r.TAG!==null)return this.LIST[r.LIST].subChunks.splice(r.TAG,1),!0;return!1}listTags(){let o=this.getLISTIndex("INFO"),r={};if(o!==null)for(let t=0,i=this.LIST[o].subChunks.length;t<i;t++)r[this.LIST[o].subChunks[t].chunkId]=this.LIST[o].subChunks[t].value;return r}getLISTIndex(o){for(let r=0,t=this.LIST.length;r<t;r++)if(this.LIST[r].format==o)return r;return null}getTagIndex_(o){let r={LIST:null,TAG:null};for(let t=0,i=this.LIST.length;t<i;t++)if(this.LIST[t].format=="INFO"){r.LIST=t;for(let n=0,h=this.LIST[t].subChunks.length;n<h;n++)if(this.LIST[t].subChunks[n].chunkId==o){r.TAG=n;break}break}return r}}function kr(o){if(o.constructor!==String)throw new Error("Invalid tag name.");else if(o.length<4)for(let r=0,t=4-o.length;r<t;r++)o+=" ";return o}class D extends vo{listCuePoints(){let o=this.getCuePoints_();for(let r=0,t=o.length;r<t;r++){if(o[r].position=o[r].dwSampleOffset/this.fmt.sampleRate*1000,o[r].dwSampleLength)o[r].end=o[r].dwSampleLength/this.fmt.sampleRate*1000,o[r].end+=o[r].position;else o[r].end=null;delete o[r].value}return o}setCuePoint(o){if(this.cue.chunkId="cue ",!o.label)o.label="";let r=this.getCuePoints_();if(this.clearLISTadtl_(),this.cue.points=[],o.dwSampleOffset=o.position*this.fmt.sampleRate/1000,o.dwSampleLength=0,o.end)o.dwSampleLength=o.end*this.fmt.sampleRate/1000-o.dwSampleOffset;if(r.length===0)this.setCuePoint_(o,1);else this.setCuePointInOrder_(r,o);this.cue.dwCuePoints=this.cue.points.length}deleteCuePoint(o){this.cue.chunkId="cue ";let r=this.getCuePoints_();this.clearLISTadtl_();let t=this.cue.points.length;this.cue.points=[];for(let i=0;i<t;i++)if(i+1!==o)this.setCuePoint_(r[i],i+1);if(this.cue.dwCuePoints=this.cue.points.length,this.cue.dwCuePoints)this.cue.chunkId="cue ";else this.cue.chunkId="",this.clearLISTadtl_()}updateLabel(o,r){let t=this.getLISTIndex("adtl");if(t!==null){for(let i=0,n=this.LIST[t].subChunks.length;i<n;i++)if(this.LIST[t].subChunks[i].dwName==o)this.LIST[t].subChunks[i].value=r}}getCuePoints_(){let o=[];for(let r=0;r<this.cue.points.length;r++){let t=this.cue.points[r],i=this.getDataForCuePoint_(t.dwName);i.label=i.value?i.value:"",i.dwPosition=t.dwPosition,i.fccChunk=t.fccChunk,i.dwChunkStart=t.dwChunkStart,i.dwBlockStart=t.dwBlockStart,i.dwSampleOffset=t.dwSampleOffset,o.push(i)}return o}getDataForCuePoint_(o){let r=this.getLISTIndex("adtl"),t={};if(r!==null)this.getCueDataFromLIST_(t,r,o);return t}getCueDataFromLIST_(o,r,t){for(let i=0,n=this.LIST[r].subChunks.length;i<n;i++)if(this.LIST[r].subChunks[i].dwName==t){let h=this.LIST[r].subChunks[i];o.value=h.value||o.value,o.dwName=h.dwName||0,o.dwSampleLength=h.dwSampleLength||0,o.dwPurposeID=h.dwPurposeID||0,o.dwCountry=h.dwCountry||0,o.dwLanguage=h.dwLanguage||0,o.dwDialect=h.dwDialect||0,o.dwCodePage=h.dwCodePage||0}}setCuePoint_(o,r){this.cue.points.push({dwName:r,dwPosition:o.dwPosition?o.dwPosition:0,fccChunk:o.fccChunk?o.fccChunk:"data",dwChunkStart:o.dwChunkStart?o.dwChunkStart:0,dwBlockStart:o.dwBlockStart?o.dwBlockStart:0,dwSampleOffset:o.dwSampleOffset}),this.setLabl_(o,r)}setCuePointInOrder_(o,r){let t=!1;for(let i=0;i<o.length;i++)if(o[i].dwSampleOffset>r.dwSampleOffset&&!t)this.setCuePoint_(r,i+1),this.setCuePoint_(o[i],i+2),t=!0;else this.setCuePoint_(o[i],t?i+2:i+1);if(!t)this.setCuePoint_(r,this.cue.points.length+1)}clearLISTadtl_(){for(let o=0,r=this.LIST.length;o<r;o++)if(this.LIST[o].format=="adtl")this.LIST.splice(o)}setLabl_(o,r){let t=this.getLISTIndex("adtl");if(t===null)this.LIST.push({chunkId:"LIST",chunkSize:4,format:"adtl",subChunks:[]}),t=this.LIST.length-1;if(this.setLabelText_(t,o,r),o.dwSampleLength)this.setLtxtChunk_(t,o,r)}setLabelText_(o,r,t){this.LIST[o].subChunks.push({chunkId:"labl",chunkSize:4,dwName:t,value:r.label}),this.LIST[o].chunkSize+=12}setLtxtChunk_(o,r,t){this.LIST[o].subChunks.push({chunkId:"ltxt",chunkSize:20,dwName:t,dwSampleLength:r.dwSampleLength,dwPurposeID:r.dwPurposeID||0,dwCountry:r.dwCountry||0,dwLanguage:r.dwLanguage||0,dwDialect:r.dwDialect||0,dwCodePage:r.dwCodePage||0,value:r.label}),this.LIST[o].chunkSize+=28}}class go{constructor(o,r,t){if(this.length_=o,this.scaleFactor_=(o-1)/r,this.interpolate=this.sinc,t.method==="point")this.interpolate=this.point;else if(t.method==="linear")this.interpolate=this.linear;else if(t.method==="cubic")this.interpolate=this.cubic;this.tangentFactor_=1-Math.max(0,Math.min(1,t.tension||0)),this.sincFilterSize_=t.sincFilterSize||1,this.kernel_=br(t.sincWindow||fr)}point(o,r){return this.getClippedInput_(Math.round(this.scaleFactor_*o),r)}linear(o,r){o=this.scaleFactor_*o;let t=Math.floor(o);return o-=t,(1-o)*this.getClippedInput_(t,r)+o*this.getClippedInput_(t+1,r)}cubic(o,r){o=this.scaleFactor_*o;let t=Math.floor(o),i=[this.getTangent_(t,r),this.getTangent_(t+1,r)],n=[this.getClippedInput_(t,r),this.getClippedInput_(t+1,r)];o-=t;let h=o*o,d=o*h;return(2*d-3*h+1)*n[0]+(d-2*h+o)*i[0]+(-2*d+3*h)*n[1]+(d-h)*i[1]}sinc(o,r){o=this.scaleFactor_*o;let t=Math.floor(o),i=t-this.sincFilterSize_+1,n=t+this.sincFilterSize_,h=0;for(let d=i;d<=n;d++)h+=this.kernel_(o-d)*this.getClippedInput_(d,r);return h}getTangent_(o,r){return this.tangentFactor_*(this.getClippedInput_(o+1,r)-this.getClippedInput_(o-1,r))/2}getClippedInput_(o,r){if(0<=o&&o<this.length_)return r[o];return 0}}function fr(o){return Math.exp(-o/2*o/2)}function br(o){return function(r){return pr(r)*o(r)}}function pr(o){if(o===0)return 1;return Math.sin(Math.PI*o)/(Math.PI*o)}class wo{constructor(o,r,t){let i=2*Math.PI*t/r,n=0;this.filters=[];for(let h=0;h<=o;h++){if(h-o/2===0)this.filters[h]=i;else this.filters[h]=Math.sin(i*(h-o/2))/(h-o/2),this.filters[h]*=0.54-0.46*Math.cos(2*Math.PI*h/o);n=n+this.filters[h]}for(let h=0;h<=o;h++)this.filters[h]/=n;this.z=this.initZ_()}filter(o){this.z.buf[this.z.pointer]=o;let r=0;for(let t=0,i=this.z.buf.length;t<i;t++)r+=this.filters[t]*this.z.buf[(this.z.pointer+t)%this.z.buf.length];return this.z.pointer=(this.z.pointer+1)%this.z.buf.length,r}reset(){this.z=this.initZ_()}initZ_(){let o=[];for(let r=0;r<this.filters.length-1;r++)o.push(0);return{buf:o,pointer:0}}}class Eo{constructor(o,r,t){let i=[];for(let n=0;n<o;n++)i.push(this.getCoeffs_({Fs:r,Fc:t,Q:0.5/Math.sin(Math.PI/(o*2)*(n+0.5))}));this.stages=[];for(let n=0;n<i.length;n++)this.stages[n]={b0:i[n].b[0],b1:i[n].b[1],b2:i[n].b[2],a1:i[n].a[0],a2:i[n].a[1],k:i[n].k,z:[0,0]}}filter(o){let r=o;for(let t=0,i=this.stages.length;t<i;t++)r=this.runStage_(t,r);return r}getCoeffs_(o){let r={};r.a=[],r.b=[];let t=this.preCalc_(o,r);return r.k=1,r.b.push((1-t.cw)/(2*t.a0)),r.b.push(2*r.b[0]),r.b.push(r.b[0]),r}preCalc_(o,r){let t={},i=2*Math.PI*o.Fc/o.Fs;return t.alpha=Math.sin(i)/(2*o.Q),t.cw=Math.cos(i),t.a0=1+t.alpha,r.a0=t.a0,r.a.push(-2*t.cw/t.a0),r.k=1,r.a.push((1-t.alpha)/t.a0),t}runStage_(o,r){let t=r*this.stages[o].k-this.stages[o].a1*this.stages[o].z[0]-this.stages[o].a2*this.stages[o].z[1],i=this.stages[o].b0*t+this.stages[o].b1*this.stages[o].z[0]+this.stages[o].b2*this.stages[o].z[1];return this.stages[o].z[1]=this.stages[o].z[0],this.stages[o].z[0]=t,i}reset(){for(let o=0;o<this.stages.length;o++)this.stages[o].z=[0,0]}}var ot={point:!1,linear:!1,cubic:!0,sinc:!0},Do={IIR:16,FIR:71},rt={IIR:Eo,FIR:wo};function Mo(o,r,t,i=null){i=i||{};let n=(t-r)/r+1,h=new Float64Array(o.length*n);i.method=i.method||"cubic";let d=new go(o.length,h.length,{method:i.method,tension:i.tension||0,sincFilterSize:i.sincFilterSize||6,sincWindow:i.sincWindow||void 0,clip:i.clip||"mirror"});if(i.LPF===void 0)i.LPF=ot[i.method];if(i.LPF){i.LPFType=i.LPFType||"IIR";let c=rt[i.LPFType];if(t>r){let s=new c(i.LPForder||Do[i.LPFType],t,r/2);tt(o,h,d,s)}else{let s=new c(i.LPForder||Do[i.LPFType],r,t/2);it(o,h,d,s)}}else mo(o,h,d);return h}function mo(o,r,t){for(let i=0,n=r.length;i<n;i++)r[i]=t.interpolate(i,o)}function tt(o,r,t,i){for(let n=0,h=r.length;n<h;n++)r[n]=i.filter(t.interpolate(n,o));i.reset();for(let n=r.length-1;n>=0;n--)r[n]=i.filter(r[n])}function it(o,r,t,i){for(let n=0,h=o.length;n<h;n++)o[n]=i.filter(o[n]);i.reset();for(let n=o.length-1;n>=0;n--)o[n]=i.filter(o[n]);mo(o,r,t)}class Ao extends D{toRIFF(){let o=new Float64Array(V(this.data.samples.length,this.dataType.bits/8));_(this.data.samples,this.dataType,o,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,this.bitDepth,o,{container:"RIFF"})}toRIFX(){let o=new Float64Array(V(this.data.samples.length,this.dataType.bits/8));_(this.data.samples,this.dataType,o,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,this.bitDepth,o,{container:"RIFX"})}toIMAADPCM(){if(this.fmt.sampleRate!==8000)throw new Error("Only 8000 Hz files can be compressed as IMA-ADPCM.");else if(this.fmt.numChannels!==1)throw new Error("Only mono files can be compressed as IMA-ADPCM.");else{this.assure16Bit_();let o=new Int16Array(V(this.data.samples.length,2));_(this.data.samples,this.dataType,o,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"4",Yo(o),{container:this.correctContainer_()})}}fromIMAADPCM(o="16"){if(this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"16",qo(this.data.samples,this.fmt.blockAlign),{container:this.correctContainer_()}),o!="16")this.toBitDepth(o)}toALaw(){this.assure16Bit_();let o=new Int16Array(V(this.data.samples.length,2));_(this.data.samples,this.dataType,o,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"8a",Bo(o),{container:this.correctContainer_()})}fromALaw(o="16"){if(this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"16",zo(this.data.samples),{container:this.correctContainer_()}),o!="16")this.toBitDepth(o)}toMuLaw(){this.assure16Bit_();let o=new Int16Array(V(this.data.samples.length,2));_(this.data.samples,this.dataType,o,0,this.data.samples.length),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"8m",Qo(o),{container:this.correctContainer_()})}fromMuLaw(o="16"){if(this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,"16",Ko(this.data.samples),{container:this.correctContainer_()}),o!="16")this.toBitDepth(o)}toBitDepth(o,r=!0){let t=o,i=this.bitDepth;if(!r){if(o!="32f")t=this.dataType.bits.toString();i=""+this.dataType.bits}this.assureUncompressed_();let n=this.getSamples(!0),h=new Float64Array(n.length);Lo(n,i,h,t),this.fromExisting_(this.fmt.numChannels,this.fmt.sampleRate,o,h,{container:this.correctContainer_()})}toSampleRate(o,r){this.validateResample_(o);let t=this.getSamples(),i=[];if(t.constructor===Float64Array)i=Mo(t,this.fmt.sampleRate,o,r);else for(let n=0;n<t.length;n++)i.push(Mo(t[n],this.fmt.sampleRate,o,r));this.fromExisting_(this.fmt.numChannels,o,this.bitDepth,i,{container:this.correctContainer_()})}validateResample_(o){if(!x(this.fmt.numChannels,this.fmt.bitsPerSample,o))throw new Error("Invalid sample rate.");else if(["4","8a","8m"].indexOf(this.bitDepth)>-1)throw new Error("wavefile can't change the sample rate of compressed files.")}assure16Bit_(){if(this.assureUncompressed_(),this.bitDepth!="16")this.toBitDepth("16")}assureUncompressed_(){if(this.bitDepth=="8a")this.fromALaw();else if(this.bitDepth=="8m")this.fromMuLaw();else if(this.bitDepth=="4")this.fromIMAADPCM()}correctContainer_(){return this.container=="RF64"?"RIFF":this.container}fromExisting_(o,r,t,i,n){let h=new D;Object.assign(this.fmt,h.fmt),Object.assign(this.fact,h.fact),Object.assign(this.ds64,h.ds64),Object.assign(this.data,h.data),this.newWavFile_(o,r,t,i,n)}}function V(o,r){let t=o/r;if(t%2)t++;return t}class q extends Ao{constructor(o){super();if(o)this.fromBuffer(o)}fromBase64(o){this.fromBuffer(To(o))}toBase64(){return Io(this.toBuffer())}toDataURI(){return"data:audio/wav;base64,"+this.toBase64()}fromDataURI(o){this.fromBase64(o.replace("data:audio/wav;base64,",""))}}import{useState as Lt}from"preact/hooks";import{useEditor as $t}from"@blockcode/core";import{useState as Mt}from"preact/hooks";import{useLocale as At,useLayout as Nt,useEditor as Ot}from"@blockcode/core";import{IconSelector as Wt,ActionButton as Ct}from"@blockcode/ui";var bo=Gr(fo(),1);function po(o){return new Promise(async(r,t)=>{let i=new FileReader;i.readAsArrayBuffer(o),i.addEventListener("load",()=>{let n=new q;try{n.fromBuffer(new Uint8Array(i.result)),n.toBitDepth(8),n.toSampleRate(11025)}catch(h){t(h)}r(n)})})}async function or(o){let r=new q,i=await new AudioContext().decodeAudioData(await o.arrayBuffer());return r.fromBuffer(new Uint8Array(bo.default(i))),r.toBitDepth(8),r.toSampleRate(11025),r}async function rr(o){let t=await(await fetch(o,{})).arrayBuffer(),i=new q;return i.fromBuffer(new Uint8Array(t)),i}function No(o){let r=Math.floor(o/60),t=Math.floor(o%60);return`${r}:${`00${t}`.slice(-2)}.${o.toFixed(3).slice(-3)}`}function B(o=32){let r=[];for(let t=0;t<o;t++)r[t]="0123456789abcdefghijklmnopqrstuvwxyz".charAt(Math.random()*36);return r.join("")}function Z(o){let r=globalThis.document,t=r.createElement("style");t.appendChild(r.createTextNode(o)),r.head.append(t)}Z("._5PgNba_selector-wrapper{background:var(--ui-secondary);width:150px;position:relative}._5PgNba_selector-items-wrapper{width:150px;min-height:100%;padding-bottom:100px}._5PgNba_selector-item{width:5rem;height:5rem;margin:.5rem auto}._5PgNba_delete-menu-item:hover{background:var(--error-primary)}._5PgNba_add-button-wrapper{background:linear-gradient(transparent,var(--ui-secondary));width:100%;height:100px;display:flex;position:absolute;bottom:0;left:0;right:0}._5PgNba_add-button{margin:.75rem auto}");var Y={deleteMenuItem:"_5PgNba_delete-menu-item",selectorItem:"_5PgNba_selector-item",selectorItemsWrapper:"_5PgNba_selector-items-wrapper",selectorWrapper:"_5PgNba_selector-wrapper",addButtonWrapper:"_5PgNba_add-button-wrapper",addButton:"_5PgNba_add-button"};var tr="./assets/icon-thumb-jy4n8115.svg";var ir="./assets/icon-sound-56nbc8vm.svg";var nr="./assets/icon-search-6g8kgvdt.svg";var z="./assets/icon-record-k0kczk8k.svg";var hr="./assets/icon-surprise-d5t4529a.svg";var dr="./assets/icon-file-upload-0z25chr6.svg";import{jsx as k,jsxs as ut}from"preact/jsx-runtime";function Oo({soundList:o,soundIndex:r,onSelect:t,onSetupLibrary:i}){let[n,h]=Mt(!1),{getText:d}=At(),{createAlert:c,removeAlert:s}=Nt(),{addAsset:e,deleteAsset:v}=Ot(),{SoundsLibrary:g}=i(),w=()=>h(!0),E=()=>h(!1),C=async(N)=>{let A=B();c("importing",{id:A});let G=await rr(`./assets/${N.id}.wav`);e({...N,id:A,type:"audio/wav",data:G.toBase64(),sampleCount:G.data.chunkSize}),s(A),t(o.length)},M=()=>C(g.surprise()),W=()=>{let N=document.createElement("input");N.type="file",N.accept="audio/wav",N.multiple=!0,N.click(),N.addEventListener("change",async(A)=>{let G=B();c("importing",{id:G});try{for(let S of A.target.files){let T=B(),R=S.name.slice(0,S.name.lastIndexOf(".")),P=await po(S);console.log(P),e({id:T,type:S.type,name:R,data:P.toBase64(),rate:P.fmt.sampleRate,sampleCount:P.data.chunkSize})}s(G)}catch(S){c({id:G,message:d("waveSurfer.error.formatNotSupperted","This wav format is not supported.")},2000)}})},a=()=>{e({id:B(),type:"audio/wav",name:d("waveSurfer.surfer.sound","Sound"),data:"UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAABErAAABAAgAZGF0YQAAAAA=",rate:11025,sampleCount:0,record:!0}),t(o.length)},O=(N)=>{v(o[N].id)};return ut("div",{className:Y.selectorWrapper,children:[k(Wt,{displayOrder:!0,id:"wave-selector",className:Y.selectorItemsWrapper,items:o.map((N,A)=>({...N,details:`${No(N.sampleCount/N.rate||0)}`,icon:tr,order:A,className:Y.selectorItem,contextMenu:[[{label:d("waveSurfer.contextMenu.export","export"),disabled:!0}],[{label:d("waveSurfer.contextMenu.delete","delete"),className:Y.deleteMenuItem,disabled:o.length<=1,onClick:()=>O(A)}]]})),selectedIndex:r,onSelect:t,onDelete:O}),k("div",{className:Y.addButtonWrapper,children:k(Ct,{tooltipPlacement:"right",className:Y.addButton,icon:ir,tooltip:d("waveSurfer.actionButton.sound","Choose a Sound"),onClick:w,moreButtons:[{icon:dr,tooltip:d("waveSurfer.actionButton.upload","Upload Sound"),onClick:W},{icon:hr,tooltip:d("waveSurfer.actionButton.surprise","Surprise"),onClick:M},{icon:z,tooltip:d("waveSurfer.actionButton.record","Record"),onClick:a},{icon:nr,tooltip:d("waveSurfer.actionButton.sound","Choose a Sound"),onClick:w}]})}),n&&g&&k(g,{onClose:E,onSelect:C})]})}function U(o,r,t,i){return new(t||(t=Promise))(function(n,h){function d(e){try{s(i.next(e))}catch(v){h(v)}}function c(e){try{s(i.throw(e))}catch(v){h(v)}}function s(e){var v;e.done?n(e.value):(v=e.value,v instanceof t?v:new t(function(g){g(v)})).then(d,c)}s((i=i.apply(o,r||[])).next())})}class J{constructor(){this.listeners={}}on(o,r,t){if(this.listeners[o]||(this.listeners[o]=new Set),this.listeners[o].add(r),t==null?void 0:t.once){let i=()=>{this.un(o,i),this.un(o,r)};return this.on(o,i),i}return()=>this.un(o,r)}un(o,r){var t;(t=this.listeners[o])===null||t===void 0||t.delete(r)}once(o,r){return this.on(o,r,{once:!0})}unAll(){this.listeners={}}emit(o,...r){this.listeners[o]&&this.listeners[o].forEach((t)=>t(...r))}}var cr={decode:function(o,r){return U(this,void 0,void 0,function*(){let t=new AudioContext({sampleRate:r});return t.decodeAudioData(o).finally(()=>t.close())})},createBuffer:function(o,r){return typeof o[0]=="number"&&(o=[o]),function(t){let i=t[0];if(i.some((n)=>n>1||n<-1)){let n=i.length,h=0;for(let d=0;d<n;d++){let c=Math.abs(i[d]);c>h&&(h=c)}for(let d of t)for(let c=0;c<n;c++)d[c]/=h}}(o),{duration:r,length:o[0].length,sampleRate:o[0].length/r,numberOfChannels:o.length,getChannelData:(t)=>o==null?void 0:o[t],copyFromChannel:AudioBuffer.prototype.copyFromChannel,copyToChannel:AudioBuffer.prototype.copyToChannel}}};function er(o,r){let t=r.xmlns?document.createElementNS(r.xmlns,o):document.createElement(o);for(let[i,n]of Object.entries(r))if(i==="children")for(let[h,d]of Object.entries(r))typeof d=="string"?t.appendChild(document.createTextNode(d)):t.appendChild(er(h,d));else i==="style"?Object.assign(t.style,n):i==="textContent"?t.textContent=n:t.setAttribute(i,n.toString());return t}function sr(o,r,t){let i=er(o,r||{});return t==null||t.appendChild(i),i}var Ht=Object.freeze({__proto__:null,createElement:sr,default:sr}),at={fetchBlob:function(o,r,t){return U(this,void 0,void 0,function*(){let i=yield fetch(o,t);if(i.status>=400)throw new Error(`Failed to fetch ${o}: ${i.status} (${i.statusText})`);return function(n,h){U(this,void 0,void 0,function*(){if(!n.body||!n.headers)return;let d=n.body.getReader(),c=Number(n.headers.get("Content-Length"))||0,s=0,e=(g)=>U(this,void 0,void 0,function*(){s+=(g==null?void 0:g.length)||0;let w=Math.round(s/c*100);h(w)}),v=()=>U(this,void 0,void 0,function*(){let g;try{g=yield d.read()}catch(w){return}g.done||(e(g.value),yield v())});v()})}(i.clone(),r),i.blob()})}};class lr extends J{constructor(o){super(),this.isExternalMedia=!1,o.media?(this.media=o.media,this.isExternalMedia=!0):this.media=document.createElement("audio"),o.mediaControls&&(this.media.controls=!0),o.autoplay&&(this.media.autoplay=!0),o.playbackRate!=null&&this.onMediaEvent("canplay",()=>{o.playbackRate!=null&&(this.media.playbackRate=o.playbackRate)},{once:!0})}onMediaEvent(o,r,t){return this.media.addEventListener(o,r,t),()=>this.media.removeEventListener(o,r,t)}getSrc(){return this.media.currentSrc||this.media.src||""}revokeSrc(){let o=this.getSrc();o.startsWith("blob:")&&URL.revokeObjectURL(o)}canPlayType(o){return this.media.canPlayType(o)!==""}setSrc(o,r){let t=this.getSrc();if(o&&t===o)return;this.revokeSrc();let i=r instanceof Blob&&(this.canPlayType(r.type)||!o)?URL.createObjectURL(r):o;try{this.media.src=i}catch(n){this.media.src=o}}destroy(){this.media.pause(),this.isExternalMedia||(this.media.remove(),this.revokeSrc(),this.media.src="",this.media.load())}setMediaElement(o){this.media=o}play(){return U(this,void 0,void 0,function*(){return this.media.play()})}pause(){this.media.pause()}isPlaying(){return!this.media.paused&&!this.media.ended}setTime(o){this.media.currentTime=o}getDuration(){return this.media.duration}getCurrentTime(){return this.media.currentTime}getVolume(){return this.media.volume}setVolume(o){this.media.volume=o}getMuted(){return this.media.muted}setMuted(o){this.media.muted=o}getPlaybackRate(){return this.media.playbackRate}isSeeking(){return this.media.seeking}setPlaybackRate(o,r){r!=null&&(this.media.preservesPitch=r),this.media.playbackRate=o}getMediaElement(){return this.media}setSinkId(o){return this.media.setSinkId(o)}}class Q extends J{constructor(o,r){super(),this.timeouts=[],this.isScrollable=!1,this.audioData=null,this.resizeObserver=null,this.lastContainerWidth=0,this.isDragging=!1,this.subscriptions=[],this.subscriptions=[],this.options=o;let t=this.parentFromOptionsContainer(o.container);this.parent=t;let[i,n]=this.initHtml();t.appendChild(i),this.container=i,this.scrollContainer=n.querySelector(".scroll"),this.wrapper=n.querySelector(".wrapper"),this.canvasWrapper=n.querySelector(".canvases"),this.progressWrapper=n.querySelector(".progress"),this.cursor=n.querySelector(".cursor"),r&&n.appendChild(r),this.initEvents()}parentFromOptionsContainer(o){let r;if(typeof o=="string"?r=document.querySelector(o):o instanceof HTMLElement&&(r=o),!r)throw new Error("Container not found");return r}initEvents(){let o=(r)=>{let t=this.wrapper.getBoundingClientRect(),i=r.clientX-t.left,n=r.clientY-t.top;return[i/t.width,n/t.height]};if(this.wrapper.addEventListener("click",(r)=>{let[t,i]=o(r);this.emit("click",t,i)}),this.wrapper.addEventListener("dblclick",(r)=>{let[t,i]=o(r);this.emit("dblclick",t,i)}),this.options.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.scrollContainer.addEventListener("scroll",()=>{let{scrollLeft:r,scrollWidth:t,clientWidth:i}=this.scrollContainer,n=r/t,h=(r+i)/t;this.emit("scroll",n,h,r,r+i)}),typeof ResizeObserver=="function"){let r=this.createDelay(100);this.resizeObserver=new ResizeObserver(()=>{r().then(()=>this.onContainerResize()).catch(()=>{})}),this.resizeObserver.observe(this.scrollContainer)}}onContainerResize(){let o=this.parent.clientWidth;o===this.lastContainerWidth&&this.options.height!=="auto"||(this.lastContainerWidth=o,this.reRender())}initDrag(){this.subscriptions.push(function(o,r,t,i,n=3,h=0,d=100){if(!o)return()=>{};let c=matchMedia("(pointer: coarse)").matches,s=()=>{},e=(v)=>{if(v.button!==h)return;v.preventDefault(),v.stopPropagation();let{clientX:g,clientY:w}=v,E=!1,C=Date.now(),M=(A)=>{if(A.preventDefault(),A.stopPropagation(),c&&Date.now()-C<d)return;let{clientX:G,clientY:S}=A,T=G-g,R=S-w;if(E||Math.abs(T)>n||Math.abs(R)>n){let P=o.getBoundingClientRect(),{left:So,top:Po}=P;E||(t==null||t(g-So,w-Po),E=!0),r(T,R,G-So,S-Po),g=G,w=S}},W=(A)=>{if(E){let{clientX:G,clientY:S}=A,T=o.getBoundingClientRect(),{left:R,top:P}=T;i==null||i(G-R,S-P)}s()},a=(A)=>{A.relatedTarget&&A.relatedTarget!==document.documentElement||W(A)},O=(A)=>{E&&(A.stopPropagation(),A.preventDefault())},N=(A)=>{E&&A.preventDefault()};document.addEventListener("pointermove",M),document.addEventListener("pointerup",W),document.addEventListener("pointerout",a),document.addEventListener("pointercancel",a),document.addEventListener("touchmove",N,{passive:!1}),document.addEventListener("click",O,{capture:!0}),s=()=>{document.removeEventListener("pointermove",M),document.removeEventListener("pointerup",W),document.removeEventListener("pointerout",a),document.removeEventListener("pointercancel",a),document.removeEventListener("touchmove",N),setTimeout(()=>{document.removeEventListener("click",O,{capture:!0})},10)}};return o.addEventListener("pointerdown",e),()=>{s(),o.removeEventListener("pointerdown",e)}}(this.wrapper,(o,r,t)=>{this.emit("drag",Math.max(0,Math.min(1,t/this.wrapper.getBoundingClientRect().width)))},(o)=>{this.isDragging=!0,this.emit("dragstart",Math.max(0,Math.min(1,o/this.wrapper.getBoundingClientRect().width)))},(o)=>{this.isDragging=!1,this.emit("dragend",Math.max(0,Math.min(1,o/this.wrapper.getBoundingClientRect().width)))}))}getHeight(o,r){var t;let i=((t=this.audioData)===null||t===void 0?void 0:t.numberOfChannels)||1;if(o==null)return 128;if(!isNaN(Number(o)))return Number(o);if(o==="auto"){let n=this.parent.clientHeight||128;return(r==null?void 0:r.every((h)=>!h.overlay))?n/i:n}return 128}initHtml(){let o=document.createElement("div"),r=o.attachShadow({mode:"open"}),t=this.options.cspNonce&&typeof this.options.cspNonce=="string"?this.options.cspNonce.replace(/"/g,""):"";return r.innerHTML=`
      <style${t?` nonce="${t}"`:""}>
        :host {
          user-select: none;
          min-width: 1px;
        }
        :host audio {
          display: block;
          width: 100%;
        }
        :host .scroll {
          overflow-x: auto;
          overflow-y: hidden;
          width: 100%;
          position: relative;
        }
        :host .noScrollbar {
          scrollbar-color: transparent;
          scrollbar-width: none;
        }
        :host .noScrollbar::-webkit-scrollbar {
          display: none;
          -webkit-appearance: none;
        }
        :host .wrapper {
          position: relative;
          overflow: visible;
          z-index: 2;
        }
        :host .canvases {
          min-height: ${this.getHeight(this.options.height,this.options.splitChannels)}px;
        }
        :host .canvases > div {
          position: relative;
        }
        :host canvas {
          display: block;
          position: absolute;
          top: 0;
          image-rendering: pixelated;
        }
        :host .progress {
          pointer-events: none;
          position: absolute;
          z-index: 2;
          top: 0;
          left: 0;
          width: 0;
          height: 100%;
          overflow: hidden;
        }
        :host .progress > div {
          position: relative;
        }
        :host .cursor {
          pointer-events: none;
          position: absolute;
          z-index: 5;
          top: 0;
          left: 0;
          height: 100%;
          border-radius: 2px;
        }
      </style>

      <div class="scroll" part="scroll">
        <div class="wrapper" part="wrapper">
          <div class="canvases" part="canvases"></div>
          <div class="progress" part="progress"></div>
          <div class="cursor" part="cursor"></div>
        </div>
      </div>
    `,[o,r]}setOptions(o){if(this.options.container!==o.container){let r=this.parentFromOptionsContainer(o.container);r.appendChild(this.container),this.parent=r}o.dragToSeek!==!0&&typeof this.options.dragToSeek!="object"||this.initDrag(),this.options=o,this.reRender()}getWrapper(){return this.wrapper}getWidth(){return this.scrollContainer.clientWidth}getScroll(){return this.scrollContainer.scrollLeft}setScroll(o){this.scrollContainer.scrollLeft=o}setScrollPercentage(o){let{scrollWidth:r}=this.scrollContainer,t=r*o;this.setScroll(t)}destroy(){var o,r;this.subscriptions.forEach((t)=>t()),this.container.remove(),(o=this.resizeObserver)===null||o===void 0||o.disconnect(),(r=this.unsubscribeOnScroll)===null||r===void 0||r.call(this)}createDelay(o=10){let r,t,i=()=>{r&&clearTimeout(r),t&&t()};return this.timeouts.push(i),()=>new Promise((n,h)=>{i(),t=h,r=setTimeout(()=>{r=void 0,t=void 0,n()},o)})}convertColorValues(o){if(!Array.isArray(o))return o||"";if(o.length<2)return o[0]||"";let r=document.createElement("canvas"),t=r.getContext("2d"),i=r.height*(window.devicePixelRatio||1),n=t.createLinearGradient(0,0,0,i),h=1/(o.length-1);return o.forEach((d,c)=>{let s=c*h;n.addColorStop(s,d)}),n}getPixelRatio(){return Math.max(1,window.devicePixelRatio||1)}renderBarWaveform(o,r,t,i){let n=o[0],h=o[1]||o[0],d=n.length,{width:c,height:s}=t.canvas,e=s/2,v=this.getPixelRatio(),g=r.barWidth?r.barWidth*v:1,w=r.barGap?r.barGap*v:r.barWidth?g/2:0,E=r.barRadius||0,C=c/(g+w)/d,M=E&&"roundRect"in t?"roundRect":"rect";t.beginPath();let W=0,a=0,O=0;for(let N=0;N<=d;N++){let A=Math.round(N*C);if(A>W){let T=Math.round(a*e*i),R=T+Math.round(O*e*i)||1,P=e-T;r.barAlign==="top"?P=0:r.barAlign==="bottom"&&(P=s-R),t[M](W*(g+w),P,g,R,E),W=A,a=0,O=0}let G=Math.abs(n[N]||0),S=Math.abs(h[N]||0);G>a&&(a=G),S>O&&(O=S)}t.fill(),t.closePath()}renderLineWaveform(o,r,t,i){let n=(h)=>{let d=o[h]||o[0],c=d.length,{height:s}=t.canvas,e=s/2,v=t.canvas.width/c;t.moveTo(0,e);let g=0,w=0;for(let E=0;E<=c;E++){let C=Math.round(E*v);if(C>g){let W=e+(Math.round(w*e*i)||1)*(h===0?-1:1);t.lineTo(g,W),g=C,w=0}let M=Math.abs(d[E]||0);M>w&&(w=M)}t.lineTo(g,e)};t.beginPath(),n(0),n(1),t.fill(),t.closePath()}renderWaveform(o,r,t){if(t.fillStyle=this.convertColorValues(r.waveColor),r.renderFunction)return void r.renderFunction(o,t);let i=r.barHeight||1;if(r.normalize){let n=Array.from(o[0]).reduce((h,d)=>Math.max(h,Math.abs(d)),0);i=n?1/n:1}r.barWidth||r.barGap||r.barAlign?this.renderBarWaveform(o,r,t,i):this.renderLineWaveform(o,r,t,i)}renderSingleCanvas(o,r,t,i,n,h,d){let c=this.getPixelRatio(),s=document.createElement("canvas");s.width=Math.round(t*c),s.height=Math.round(i*c),s.style.width=`${t}px`,s.style.height=`${i}px`,s.style.left=`${Math.round(n)}px`,h.appendChild(s);let e=s.getContext("2d");if(this.renderWaveform(o,r,e),s.width>0&&s.height>0){let v=s.cloneNode(),g=v.getContext("2d");g.drawImage(s,0,0),g.globalCompositeOperation="source-in",g.fillStyle=this.convertColorValues(r.progressColor),g.fillRect(0,0,s.width,s.height),d.appendChild(v)}}renderMultiCanvas(o,r,t,i,n,h){let d=this.getPixelRatio(),{clientWidth:c}=this.scrollContainer,s=t/d,e=Math.min(Q.MAX_CANVAS_WIDTH,c,s),v={};if(r.barWidth||r.barGap){let M=r.barWidth||0.5,W=M+(r.barGap||M/2);e%W!=0&&(e=Math.floor(e/W)*W)}let g=(M)=>{if(M<0||M>=w)return;if(v[M])return;v[M]=!0;let W=M*e,a=Math.min(s-W,e);if(a<=0)return;let O=o.map((N)=>{let A=Math.floor(W/s*N.length),G=Math.floor((W+a)/s*N.length);return N.slice(A,G)});this.renderSingleCanvas(O,r,a,i,W,n,h)},w=Math.ceil(s/e);if(!this.isScrollable){for(let M=0;M<w;M++)g(M);return}let E=this.scrollContainer.scrollLeft/s,C=Math.floor(E*w);g(C-1),g(C),g(C+1),w>1&&(this.unsubscribeOnScroll=this.on("scroll",()=>{let{scrollLeft:M}=this.scrollContainer,W=Math.floor(M/s*w);Object.keys(v).length>Q.MAX_NODES&&(n.innerHTML="",h.innerHTML="",v={}),g(W-1),g(W),g(W+1)}))}renderChannel(o,r,t,i){var{overlay:n}=r,h=function(e,v){var g={};for(var w in e)Object.prototype.hasOwnProperty.call(e,w)&&v.indexOf(w)<0&&(g[w]=e[w]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function"){var E=0;for(w=Object.getOwnPropertySymbols(e);E<w.length;E++)v.indexOf(w[E])<0&&Object.prototype.propertyIsEnumerable.call(e,w[E])&&(g[w[E]]=e[w[E]])}return g}(r,["overlay"]);let d=document.createElement("div"),c=this.getHeight(h.height,h.splitChannels);d.style.height=`${c}px`,n&&i>0&&(d.style.marginTop=`-${c}px`),this.canvasWrapper.style.minHeight=`${c}px`,this.canvasWrapper.appendChild(d);let s=d.cloneNode();this.progressWrapper.appendChild(s),this.renderMultiCanvas(o,h,t,c,d,s)}render(o){return U(this,void 0,void 0,function*(){var r;this.timeouts.forEach((c)=>c()),this.timeouts=[],this.canvasWrapper.innerHTML="",this.progressWrapper.innerHTML="",this.options.width!=null&&(this.scrollContainer.style.width=typeof this.options.width=="number"?`${this.options.width}px`:this.options.width);let t=this.getPixelRatio(),i=this.scrollContainer.clientWidth,n=Math.ceil(o.duration*(this.options.minPxPerSec||0));this.isScrollable=n>i;let h=this.options.fillParent&&!this.isScrollable,d=(h?i:n)*t;if(this.wrapper.style.width=h?"100%":`${n}px`,this.scrollContainer.style.overflowX=this.isScrollable?"auto":"hidden",this.scrollContainer.classList.toggle("noScrollbar",!!this.options.hideScrollbar),this.cursor.style.backgroundColor=`${this.options.cursorColor||this.options.progressColor}`,this.cursor.style.width=`${this.options.cursorWidth}px`,this.audioData=o,this.emit("render"),this.options.splitChannels)for(let c=0;c<o.numberOfChannels;c++){let s=Object.assign(Object.assign({},this.options),(r=this.options.splitChannels)===null||r===void 0?void 0:r[c]);this.renderChannel([o.getChannelData(c)],s,d,c)}else{let c=[o.getChannelData(0)];o.numberOfChannels>1&&c.push(o.getChannelData(1)),this.renderChannel(c,this.options,d,0)}Promise.resolve().then(()=>this.emit("rendered"))})}reRender(){var o;if((o=this.unsubscribeOnScroll)===null||o===void 0||o.call(this),delete this.unsubscribeOnScroll,!this.audioData)return;let{scrollWidth:r}=this.scrollContainer,{right:t}=this.progressWrapper.getBoundingClientRect();if(this.render(this.audioData),this.isScrollable&&r!==this.scrollContainer.scrollWidth){let{right:i}=this.progressWrapper.getBoundingClientRect(),n=i-t;n*=2,n=n<0?Math.floor(n):Math.ceil(n),n/=2,this.scrollContainer.scrollLeft+=n}}zoom(o){this.options.minPxPerSec=o,this.reRender()}scrollIntoView(o,r=!1){let{scrollLeft:t,scrollWidth:i,clientWidth:n}=this.scrollContainer,h=o*i,d=t,c=t+n,s=n/2;if(this.isDragging)h+30>c?this.scrollContainer.scrollLeft+=30:h-30<d&&(this.scrollContainer.scrollLeft-=30);else{(h<d||h>c)&&(this.scrollContainer.scrollLeft=h-(this.options.autoCenter?s:0));let e=h-t-s;r&&this.options.autoCenter&&e>0&&(this.scrollContainer.scrollLeft+=Math.min(e,10))}{let e=this.scrollContainer.scrollLeft,v=e/i,g=(e+n)/i;this.emit("scroll",v,g,e,e+n)}}renderProgress(o,r){if(isNaN(o))return;let t=100*o;this.canvasWrapper.style.clipPath=`polygon(${t}% 0, 100% 0, 100% 100%, ${t}% 100%)`,this.progressWrapper.style.width=`${t}%`,this.cursor.style.left=`${t}%`,this.cursor.style.transform=`translateX(-${Math.round(t)===100?this.options.cursorWidth:0}px)`,this.isScrollable&&this.options.autoScroll&&this.scrollIntoView(o,r)}exportImage(o,r,t){return U(this,void 0,void 0,function*(){let i=this.canvasWrapper.querySelectorAll("canvas");if(!i.length)throw new Error("No waveform data");if(t==="dataURL"){let n=Array.from(i).map((h)=>h.toDataURL(o,r));return Promise.resolve(n)}return Promise.all(Array.from(i).map((n)=>new Promise((h,d)=>{n.toBlob((c)=>{c?h(c):d(new Error("Could not export image"))},o,r)})))})}}Q.MAX_CANVAS_WIDTH=8000,Q.MAX_NODES=10;class vr extends J{constructor(){super(...arguments),this.unsubscribe=()=>{}}start(){this.unsubscribe=this.on("tick",()=>{requestAnimationFrame(()=>{this.emit("tick")})}),this.emit("tick")}stop(){this.unsubscribe()}destroy(){this.unsubscribe()}}class Wo extends J{constructor(o=new AudioContext){super(),this.bufferNode=null,this.playStartTime=0,this.playedDuration=0,this._muted=!1,this._playbackRate=1,this._duration=void 0,this.buffer=null,this.currentSrc="",this.paused=!0,this.crossOrigin=null,this.seeking=!1,this.autoplay=!1,this.addEventListener=this.on,this.removeEventListener=this.un,this.audioContext=o,this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination)}load(){return U(this,void 0,void 0,function*(){})}get src(){return this.currentSrc}set src(o){if(this.currentSrc=o,this._duration=void 0,!o)return this.buffer=null,void this.emit("emptied");fetch(o).then((r)=>{if(r.status>=400)throw new Error(`Failed to fetch ${o}: ${r.status} (${r.statusText})`);return r.arrayBuffer()}).then((r)=>this.currentSrc!==o?null:this.audioContext.decodeAudioData(r)).then((r)=>{this.currentSrc===o&&(this.buffer=r,this.emit("loadedmetadata"),this.emit("canplay"),this.autoplay&&this.play())})}_play(){var o;if(!this.paused)return;this.paused=!1,(o=this.bufferNode)===null||o===void 0||o.disconnect(),this.bufferNode=this.audioContext.createBufferSource(),this.buffer&&(this.bufferNode.buffer=this.buffer),this.bufferNode.playbackRate.value=this._playbackRate,this.bufferNode.connect(this.gainNode);let r=this.playedDuration*this._playbackRate;r>=this.duration&&(r=0,this.playedDuration=0),this.bufferNode.start(this.audioContext.currentTime,r),this.playStartTime=this.audioContext.currentTime,this.bufferNode.onended=()=>{this.currentTime>=this.duration&&(this.pause(),this.emit("ended"))}}_pause(){var o;this.paused=!0,(o=this.bufferNode)===null||o===void 0||o.stop(),this.playedDuration+=this.audioContext.currentTime-this.playStartTime}play(){return U(this,void 0,void 0,function*(){this.paused&&(this._play(),this.emit("play"))})}pause(){this.paused||(this._pause(),this.emit("pause"))}stopAt(o){var r,t;let i=o-this.currentTime;(r=this.bufferNode)===null||r===void 0||r.stop(this.audioContext.currentTime+i),(t=this.bufferNode)===null||t===void 0||t.addEventListener("ended",()=>{this.bufferNode=null,this.pause()},{once:!0})}setSinkId(o){return U(this,void 0,void 0,function*(){return this.audioContext.setSinkId(o)})}get playbackRate(){return this._playbackRate}set playbackRate(o){this._playbackRate=o,this.bufferNode&&(this.bufferNode.playbackRate.value=o)}get currentTime(){return(this.paused?this.playedDuration:this.playedDuration+(this.audioContext.currentTime-this.playStartTime))*this._playbackRate}set currentTime(o){let r=!this.paused;r&&this._pause(),this.playedDuration=o/this._playbackRate,r&&this._play(),this.emit("seeking"),this.emit("timeupdate")}get duration(){var o,r;return(o=this._duration)!==null&&o!==void 0?o:((r=this.buffer)===null||r===void 0?void 0:r.duration)||0}set duration(o){this._duration=o}get volume(){return this.gainNode.gain.value}set volume(o){this.gainNode.gain.value=o,this.emit("volumechange")}get muted(){return this._muted}set muted(o){this._muted!==o&&(this._muted=o,this._muted?this.gainNode.disconnect():this.gainNode.connect(this.audioContext.destination))}canPlayType(o){return/^(audio|video)\//.test(o)}getGainNode(){return this.gainNode}getChannelData(){let o=[];if(!this.buffer)return o;let r=this.buffer.numberOfChannels;for(let t=0;t<r;t++)o.push(this.buffer.getChannelData(t));return o}}var Gt={waveColor:"#999",progressColor:"#555",cursorWidth:1,minPxPerSec:0,fillParent:!0,interact:!0,dragToSeek:!1,autoScroll:!0,autoCenter:!0,sampleRate:8000};class K extends lr{static create(o){return new K(o)}constructor(o){let r=o.media||(o.backend==="WebAudio"?new Wo:void 0);super({media:r,mediaControls:o.mediaControls,autoplay:o.autoplay,playbackRate:o.audioRate}),this.plugins=[],this.decodedData=null,this.subscriptions=[],this.mediaSubscriptions=[],this.abortController=null,this.options=Object.assign({},Gt,o),this.timer=new vr;let t=r?void 0:this.getMediaElement();this.renderer=new Q(this.options,t),this.initPlayerEvents(),this.initRendererEvents(),this.initTimerEvents(),this.initPlugins();let i=this.options.url||this.getSrc()||"";Promise.resolve().then(()=>{this.emit("init");let{peaks:n,duration:h}=this.options;(i||n&&h)&&this.load(i,n,h).catch(()=>null)})}updateProgress(o=this.getCurrentTime()){return this.renderer.renderProgress(o/this.getDuration(),this.isPlaying()),o}initTimerEvents(){this.subscriptions.push(this.timer.on("tick",()=>{if(!this.isSeeking()){let o=this.updateProgress();this.emit("timeupdate",o),this.emit("audioprocess",o)}}))}initPlayerEvents(){this.isPlaying()&&(this.emit("play"),this.timer.start()),this.mediaSubscriptions.push(this.onMediaEvent("timeupdate",()=>{let o=this.updateProgress();this.emit("timeupdate",o)}),this.onMediaEvent("play",()=>{this.emit("play"),this.timer.start()}),this.onMediaEvent("pause",()=>{this.emit("pause"),this.timer.stop()}),this.onMediaEvent("emptied",()=>{this.timer.stop()}),this.onMediaEvent("ended",()=>{this.emit("finish")}),this.onMediaEvent("seeking",()=>{this.emit("seeking",this.getCurrentTime())}),this.onMediaEvent("error",(o)=>{this.emit("error",o.error)}))}initRendererEvents(){this.subscriptions.push(this.renderer.on("click",(o,r)=>{this.options.interact&&(this.seekTo(o),this.emit("interaction",o*this.getDuration()),this.emit("click",o,r))}),this.renderer.on("dblclick",(o,r)=>{this.emit("dblclick",o,r)}),this.renderer.on("scroll",(o,r,t,i)=>{let n=this.getDuration();this.emit("scroll",o*n,r*n,t,i)}),this.renderer.on("render",()=>{this.emit("redraw")}),this.renderer.on("rendered",()=>{this.emit("redrawcomplete")}),this.renderer.on("dragstart",(o)=>{this.emit("dragstart",o)}),this.renderer.on("dragend",(o)=>{this.emit("dragend",o)}));{let o;this.subscriptions.push(this.renderer.on("drag",(r)=>{if(!this.options.interact)return;let t;this.renderer.renderProgress(r),clearTimeout(o),this.isPlaying()?t=0:this.options.dragToSeek===!0?t=200:typeof this.options.dragToSeek=="object"&&this.options.dragToSeek!==void 0&&(t=this.options.dragToSeek.debounceTime),o=setTimeout(()=>{this.seekTo(r)},t),this.emit("interaction",r*this.getDuration()),this.emit("drag",r)}))}}initPlugins(){var o;((o=this.options.plugins)===null||o===void 0?void 0:o.length)&&this.options.plugins.forEach((r)=>{this.registerPlugin(r)})}unsubscribePlayerEvents(){this.mediaSubscriptions.forEach((o)=>o()),this.mediaSubscriptions=[]}setOptions(o){this.options=Object.assign({},this.options,o),this.renderer.setOptions(this.options),o.audioRate&&this.setPlaybackRate(o.audioRate),o.mediaControls!=null&&(this.getMediaElement().controls=o.mediaControls)}registerPlugin(o){return o._init(this),this.plugins.push(o),this.subscriptions.push(o.once("destroy",()=>{this.plugins=this.plugins.filter((r)=>r!==o)})),o}getWrapper(){return this.renderer.getWrapper()}getWidth(){return this.renderer.getWidth()}getScroll(){return this.renderer.getScroll()}setScroll(o){return this.renderer.setScroll(o)}setScrollTime(o){let r=o/this.getDuration();this.renderer.setScrollPercentage(r)}getActivePlugins(){return this.plugins}loadAudio(o,r,t,i){return U(this,void 0,void 0,function*(){var n;if(this.emit("load",o),!this.options.media&&this.isPlaying()&&this.pause(),this.decodedData=null,!r&&!t){let d=this.options.fetchParams||{};window.AbortController&&!d.signal&&(this.abortController=new AbortController,d.signal=(n=this.abortController)===null||n===void 0?void 0:n.signal);let c=(s)=>this.emit("loading",s);r=yield at.fetchBlob(o,c,d)}this.setSrc(o,r);let h=yield new Promise((d)=>{let c=i||this.getDuration();c?d(c):this.mediaSubscriptions.push(this.onMediaEvent("loadedmetadata",()=>d(this.getDuration()),{once:!0}))});if(!o&&!r){let d=this.getMediaElement();d instanceof Wo&&(d.duration=h)}if(t)this.decodedData=cr.createBuffer(t,h||0);else if(r){let d=yield r.arrayBuffer();this.decodedData=yield cr.decode(d,this.options.sampleRate)}this.decodedData&&(this.emit("decode",this.getDuration()),this.renderer.render(this.decodedData)),this.emit("ready",this.getDuration())})}load(o,r,t){return U(this,void 0,void 0,function*(){try{return yield this.loadAudio(o,void 0,r,t)}catch(i){throw this.emit("error",i),i}})}loadBlob(o,r,t){return U(this,void 0,void 0,function*(){try{return yield this.loadAudio("",o,r,t)}catch(i){throw this.emit("error",i),i}})}zoom(o){if(!this.decodedData)throw new Error("No audio loaded");this.renderer.zoom(o),this.emit("zoom",o)}getDecodedData(){return this.decodedData}exportPeaks({channels:o=2,maxLength:r=8000,precision:t=1e4}={}){if(!this.decodedData)throw new Error("The audio has not been decoded yet");let i=Math.min(o,this.decodedData.numberOfChannels),n=[];for(let h=0;h<i;h++){let d=this.decodedData.getChannelData(h),c=[],s=d.length/r;for(let e=0;e<r;e++){let v=d.slice(Math.floor(e*s),Math.ceil((e+1)*s)),g=0;for(let w=0;w<v.length;w++){let E=v[w];Math.abs(E)>Math.abs(g)&&(g=E)}c.push(Math.round(g*t)/t)}n.push(c)}return n}getDuration(){let o=super.getDuration()||0;return o!==0&&o!==1/0||!this.decodedData||(o=this.decodedData.duration),o}toggleInteraction(o){this.options.interact=o}setTime(o){super.setTime(o),this.updateProgress(o),this.emit("timeupdate",o)}seekTo(o){let r=this.getDuration()*o;this.setTime(r)}playPause(){return U(this,void 0,void 0,function*(){return this.isPlaying()?this.pause():this.play()})}stop(){this.pause(),this.setTime(0)}skip(o){this.setTime(this.getCurrentTime()+o)}empty(){this.load("",[[0]],0.001)}setMediaElement(o){this.unsubscribePlayerEvents(),super.setMediaElement(o),this.initPlayerEvents()}exportImage(){return U(this,arguments,void 0,function*(o="image/png",r=1,t="dataURL"){return this.renderer.exportImage(o,r,t)})}destroy(){var o;this.emit("destroy"),(o=this.abortController)===null||o===void 0||o.abort(),this.plugins.forEach((r)=>r.destroy()),this.subscriptions.forEach((r)=>r()),this.unsubscribePlayerEvents(),this.timer.destroy(),this.renderer.destroy(),super.destroy()}}K.BasePlugin=class extends J{constructor(o){super(),this.subscriptions=[],this.options=o}onInit(){}_init(o){this.wavesurfer=o,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((o)=>o())}},K.dom=Ht;function Co(o,r,t,i){return new(t||(t=Promise))(function(n,h){function d(e){try{s(i.next(e))}catch(v){h(v)}}function c(e){try{s(i.throw(e))}catch(v){h(v)}}function s(e){var v;e.done?n(e.value):(v=e.value,v instanceof t?v:new t(function(g){g(v)})).then(d,c)}s((i=i.apply(o,r||[])).next())})}class uo{constructor(){this.listeners={}}on(o,r,t){if(this.listeners[o]||(this.listeners[o]=new Set),this.listeners[o].add(r),t==null?void 0:t.once){let i=()=>{this.un(o,i),this.un(o,r)};return this.on(o,i),i}return()=>this.un(o,r)}un(o,r){var t;(t=this.listeners[o])===null||t===void 0||t.delete(r)}once(o,r){return this.on(o,r,{once:!0})}unAll(){this.listeners={}}emit(o,...r){this.listeners[o]&&this.listeners[o].forEach((t)=>t(...r))}}class gr extends uo{constructor(o){super(),this.subscriptions=[],this.options=o}onInit(){}_init(o){this.wavesurfer=o,this.onInit()}destroy(){this.emit("destroy"),this.subscriptions.forEach((o)=>o())}}class wr extends uo{constructor(){super(...arguments),this.unsubscribe=()=>{}}start(){this.unsubscribe=this.on("tick",()=>{requestAnimationFrame(()=>{this.emit("tick")})}),this.emit("tick")}stop(){this.unsubscribe()}destroy(){this.unsubscribe()}}var Ut=["audio/webm","audio/wav","audio/mpeg","audio/mp4","audio/mp3"];class f extends gr{constructor(o){var r,t,i,n,h,d;super(Object.assign(Object.assign({},o),{audioBitsPerSecond:(r=o.audioBitsPerSecond)!==null&&r!==void 0?r:128000,scrollingWaveform:(t=o.scrollingWaveform)!==null&&t!==void 0&&t,scrollingWaveformWindow:(i=o.scrollingWaveformWindow)!==null&&i!==void 0?i:5,continuousWaveform:(n=o.continuousWaveform)!==null&&n!==void 0&&n,renderRecordedAudio:(h=o.renderRecordedAudio)===null||h===void 0||h,mediaRecorderTimeslice:(d=o.mediaRecorderTimeslice)!==null&&d!==void 0?d:void 0})),this.stream=null,this.mediaRecorder=null,this.dataWindow=null,this.isWaveformPaused=!1,this.lastStartTime=0,this.lastDuration=0,this.duration=0,this.timer=new wr,this.subscriptions.push(this.timer.on("tick",()=>{let c=performance.now()-this.lastStartTime;this.duration=this.isPaused()?this.duration:this.lastDuration+c,this.emit("record-progress",this.duration)}))}static create(o){return new f(o||{})}renderMicStream(o){var r;let t=new AudioContext,i=t.createMediaStreamSource(o),n=t.createAnalyser();i.connect(n),this.options.continuousWaveform&&(n.fftSize=32);let h=n.frequencyBinCount,d=new Float32Array(h),c=0;this.wavesurfer&&((r=this.originalOptions)!==null&&r!==void 0||(this.originalOptions=Object.assign({},this.wavesurfer.options)),this.wavesurfer.options.interact=!1,this.options.scrollingWaveform&&(this.wavesurfer.options.cursorWidth=0));let s=setInterval(()=>{var e,v,g,w;if(!this.isWaveformPaused){if(n.getFloatTimeDomainData(d),this.options.scrollingWaveform){let E=Math.floor((this.options.scrollingWaveformWindow||0)*t.sampleRate),C=Math.min(E,this.dataWindow?this.dataWindow.length+h:h),M=new Float32Array(E);if(this.dataWindow){let W=Math.max(0,E-this.dataWindow.length);M.set(this.dataWindow.slice(-C+h),W)}M.set(d,E-h),this.dataWindow=M}else if(this.options.continuousWaveform){if(!this.dataWindow){let C=this.options.continuousWaveformDuration?Math.round(100*this.options.continuousWaveformDuration):((v=(e=this.wavesurfer)===null||e===void 0?void 0:e.getWidth())!==null&&v!==void 0?v:0)*window.devicePixelRatio;this.dataWindow=new Float32Array(C)}let E=0;for(let C=0;C<h;C++){let M=Math.abs(d[C]);M>E&&(E=M)}if(c+1>this.dataWindow.length){let C=new Float32Array(2*this.dataWindow.length);C.set(this.dataWindow,0),this.dataWindow=C}this.dataWindow[c]=E,c++}else this.dataWindow=d;if(this.wavesurfer){let E=((w=(g=this.dataWindow)===null||g===void 0?void 0:g.length)!==null&&w!==void 0?w:0)/100;this.wavesurfer.load("",[this.dataWindow],this.options.scrollingWaveform?this.options.scrollingWaveformWindow:E).then(()=>{this.wavesurfer&&this.options.continuousWaveform&&(this.wavesurfer.setTime(this.getDuration()/1000),this.wavesurfer.options.minPxPerSec||this.wavesurfer.setOptions({minPxPerSec:this.wavesurfer.getWidth()/this.wavesurfer.getDuration()}))}).catch((C)=>{console.error("Error rendering real-time recording data:",C)})}}},10);return{onDestroy:()=>{clearInterval(s),i==null||i.disconnect(),t==null||t.close()},onEnd:()=>{this.isWaveformPaused=!0,clearInterval(s),this.stopMic()}}}startMic(o){return Co(this,void 0,void 0,function*(){let r;try{r=yield navigator.mediaDevices.getUserMedia({audio:!(o==null?void 0:o.deviceId)||{deviceId:o.deviceId}})}catch(n){throw new Error("Error accessing the microphone: "+n.message)}let{onDestroy:t,onEnd:i}=this.renderMicStream(r);return this.subscriptions.push(this.once("destroy",t)),this.subscriptions.push(this.once("record-end",i)),this.stream=r,r})}stopMic(){this.stream&&(this.stream.getTracks().forEach((o)=>o.stop()),this.stream=null,this.mediaRecorder=null)}startRecording(o){return Co(this,void 0,void 0,function*(){let r=this.stream||(yield this.startMic(o));this.dataWindow=null;let t=this.mediaRecorder||new MediaRecorder(r,{mimeType:this.options.mimeType||Ut.find((h)=>MediaRecorder.isTypeSupported(h)),audioBitsPerSecond:this.options.audioBitsPerSecond});this.mediaRecorder=t,this.stopRecording();let i=[];t.ondataavailable=(h)=>{h.data.size>0&&i.push(h.data),this.emit("record-data-available",h.data)};let n=(h)=>{var d;let c=new Blob(i,{type:t.mimeType});this.emit(h,c),this.options.renderRecordedAudio&&(this.applyOriginalOptionsIfNeeded(),(d=this.wavesurfer)===null||d===void 0||d.load(URL.createObjectURL(c)))};t.onpause=()=>n("record-pause"),t.onstop=()=>n("record-end"),t.start(this.options.mediaRecorderTimeslice),this.lastStartTime=performance.now(),this.lastDuration=0,this.duration=0,this.isWaveformPaused=!1,this.timer.start(),this.emit("record-start")})}getDuration(){return this.duration}isRecording(){var o;return((o=this.mediaRecorder)===null||o===void 0?void 0:o.state)==="recording"}isPaused(){var o;return((o=this.mediaRecorder)===null||o===void 0?void 0:o.state)==="paused"}isActive(){var o;return((o=this.mediaRecorder)===null||o===void 0?void 0:o.state)!=="inactive"}stopRecording(){var o;this.isActive()&&((o=this.mediaRecorder)===null||o===void 0||o.stop(),this.timer.stop())}pauseRecording(){var o,r;this.isRecording()&&(this.isWaveformPaused=!0,(o=this.mediaRecorder)===null||o===void 0||o.requestData(),(r=this.mediaRecorder)===null||r===void 0||r.pause(),this.timer.stop(),this.lastDuration=this.duration)}resumeRecording(){var o;this.isPaused()&&(this.isWaveformPaused=!1,(o=this.mediaRecorder)===null||o===void 0||o.resume(),this.timer.start(),this.lastStartTime=performance.now(),this.emit("record-resume"))}static getAvailableAudioDevices(){return Co(this,void 0,void 0,function*(){return navigator.mediaDevices.enumerateDevices().then((o)=>o.filter((r)=>r.kind==="audioinput"))})}destroy(){this.applyOriginalOptionsIfNeeded(),super.destroy(),this.stopRecording(),this.stopMic()}applyOriginalOptionsIfNeeded(){this.wavesurfer&&this.originalOptions&&(this.wavesurfer.setOptions(this.originalOptions),delete this.originalOptions)}}import{useRef as ao,useEffect as Ft}from"preact/hooks";import{useLocale as It,useEditor as Tt}from"@blockcode/core";import{classNames as Go,Label as Rt,BufferedInput as _t,Button as Er}from"@blockcode/ui";Z(".AHUB0G_surfer-wrapper{padding:calc(var(--space)*1.5);border-left:1px solid var(--ui-black-transparent);color:var(--text-primary);flex-direction:column;flex:1;display:flex}.AHUB0G_surfer-wrapper.AHUB0G_disabled{opacity:.5;pointer-events:none}.AHUB0G_row{min-height:3rem;margin-bottom:.5rem;display:flex}.AHUB0G_row-fill{padding-top:calc(var(--space)*2.5);border-top:1px dashed var(--ui-black-transparent);flex-direction:row;flex:1}.AHUB0G_row-right{margin-right:var(--space);justify-content:right}.AHUB0G_row:last-child{min-height:unset;margin-bottom:0}.AHUB0G_group{margin-right:calc(var(--space)*1.5);flex-direction:row;align-items:center;display:inline-flex}.AHUB0G_dashed-border{border-right:1px dashed var(--ui-black-transparent);padding-right:var(--space)}.AHUB0G_name-input{width:8rem}.AHUB0G_large-input{width:4rem}.AHUB0G_tool-icon{margin-right:var(--space);width:2rem;height:2rem}.AHUB0G_label-image{vertical-align:middle;margin-right:calc(var(--space)/2)}.AHUB0G_button{width:calc(2rem + 2px);height:calc(2rem + 2px);padding:.375rem}.AHUB0G_button-icon{width:100%;height:100%;margin:auto}.AHUB0G_group-button{border-left:none;border-radius:0}.AHUB0G_group-button-first{border-top-right-radius:0;border-bottom-right-radius:0}.AHUB0G_group-button-last{border-left:none;border-top-left-radius:0;border-bottom-left-radius:0}.AHUB0G_group-button-toggled-off{filter:saturate(0)}.AHUB0G_label-button{border:0;font-weight:400}.AHUB0G_label-button.AHUB0G_selected{background:var(--motion-primary);color:var(--ui-white)}.AHUB0G_label-button.AHUB0G_selected .AHUB0G_button-icon{filter:brightness(0)invert()}.AHUB0G_play-button,.AHUB0G_record-button{cursor:pointer;margin:0 var(--space);border:0;border-radius:100%;width:3rem;height:3rem;padding:.75rem}.AHUB0G_play-button{background:var(--motion-primary)}.AHUB0G_record-button{background:var(--red-primary)}.AHUB0G_wave-box-wrapper{margin:20px var(--space);border:1px solid var(--ui-black-transparent);border-radius:calc(var(--space)*.8);background:hsl(from var(--sound-primary)h s l/.15);flex:1;min-height:160px;position:relative;overflow:hidden}");var u={group:"AHUB0G_group",selected:"AHUB0G_selected",groupButtonToggledOff:"AHUB0G_group-button-toggled-off",groupButton:"AHUB0G_group-button",rowFill:"AHUB0G_row-fill",labelImage:"AHUB0G_label-image",groupButtonFirst:"AHUB0G_group-button-first",largeInput:"AHUB0G_large-input",playButton:"AHUB0G_play-button",surferWrapper:"AHUB0G_surfer-wrapper",waveBoxWrapper:"AHUB0G_wave-box-wrapper",row:"AHUB0G_row",nameInput:"AHUB0G_name-input",buttonIcon:"AHUB0G_button-icon",recordButton:"AHUB0G_record-button",dashedBorder:"AHUB0G_dashed-border",groupButtonLast:"AHUB0G_group-button-last",rowRight:"AHUB0G_row-right",button:"AHUB0G_button",disabled:"AHUB0G_disabled",labelButton:"AHUB0G_label-button",toolIcon:"AHUB0G_tool-icon"};var b="./assets/icon-play-mnpftarf.svg";var Ho="./assets/icon-stop-547qvw0a.svg";import{jsx as I,jsxs as Mr}from"preact/jsx-runtime";function Uo({soundList:o,soundIndex:r}){let t=ao(),i=ao(),n=ao(),{getText:h}=It(),{modifyAsset:d}=Tt(),c=o[r],s=!c;if(t.ws)t.ws.stop(),t.ws.setTime(0),setTimeout(()=>{t.ws.setOptions({cursorColor:"hsla(215, 100%, 65%, 0)",cursorWidth:0})});if(t.record)t.record.soundAsset=c;if(i.current)i.current.src=b,i.current.title=h("waveSurfer.surfer.play","Play");if(n.current)n.current.src=z,n.current.title=h("waveSurfer.surfer.record","Record");let e=(O,N)=>{d({...c,[O]:N})},v=()=>{if(t.ws){if(t.ws.isPlaying())t.ws.stop();else if(c.sampleCount>0)t.ws.play()}if(n.current)setTimeout(()=>{let O=n.current.parentElement.parentElement;if(O.disabled=t.ws.isPlaying(),t.ws.isPlaying())O.classList.add(u.groupButtonToggledOff);else O.classList.remove(u.groupButtonToggledOff)})},g=()=>{if(i.current)i.current.src=Ho,i.current.title=h("waveSurfer.surfer.stop","Stop");if(t.ws)t.ws.setOptions({cursorColor:"hsla(215, 100%, 65%, 1)",cursorWidth:1});if(n.current){let O=n.current.parentElement.parentElement;O.disabled=!1,O.classList.remove(u.groupButtonToggledOff)}},w=()=>{if(i.current){if(i.current.src=b,i.current.title=h("waveSurfer.surfer.play","Play"),t.ws)t.ws.setTime(0),setTimeout(()=>{t.ws.setOptions({cursorColor:"hsla(215, 100%, 65%, 0)",cursorWidth:0})})}if(n.current){n.current.src=z,n.current.title=h("waveSurfer.surfer.record","Record");let O=n.current.parentElement.parentElement;O.disabled=!1,O.classList.remove(u.groupButtonToggledOff)}},E=()=>{if(t.ws&&!t.record.isRecording())t.ws.setOptions({cursorColor:"hsla(215, 100%, 65%, 1)",cursorWidth:1})},C=()=>{if(n.current)n.current.src=Ho,n.current.title=h("waveSurfer.surfer.stop","Stop");if(i.current){let O=i.current.parentElement.parentElement;O.disabled=!0,O.classList.add(u.groupButtonToggledOff)}},M,W=()=>{if(t.record)if(t.record.isRecording())t.record.stopRecording(),t.record.stopMic(),clearTimeout(M);else t.record.startRecording(),M=setTimeout(W,1e4)},a=async(O)=>{let N=await or(O);if(d({...t.record.soundAsset,data:N.toBase64(),sampleCount:N.data.chunkSize}),i.current){let A=i.current.parentElement.parentElement;A.disabled=!1,A.classList.remove(u.groupButtonToggledOff)}};if(c&&t.ws){if(t.ws.isPlaying())t.ws.stop();if(t.ws.empty(),c.sampleCount>0)t.ws.load(`data:${c.type};base64,${c.data}`)}return Ft(()=>{if(t.current){if(t.ws=K.create({container:t.current,dragToSeek:!0,height:"auto",waveColor:"hsla(300, 48%, 50%, 1)",progressColor:"hsla(300, 48%, 50%, 0.8)",cursorColor:"hsla(215, 100%, 65%, 0)",cursorWidth:0}),t.record=t.ws.registerPlugin(f.create()),t.ws.on("play",g),t.ws.on("pause",w),t.ws.on("finish",w),t.ws.on("seeking",E),t.record.on("record-start",C),t.record.on("record-end",a),c){if(t.ws.empty(),c.sampleCount>0)t.ws.load(`data:${c.type};base64,${c.data}`);t.record.soundAsset=c}}return()=>{if(t.ws)t.ws.destroy()}},[t]),Mr("div",{className:Go(u.surferWrapper,{[u.disabled]:s}),children:[I("div",{className:u.row,children:I("div",{className:u.group,children:I(Rt,{text:h("waveSurfer.surfer.sound","Sound"),children:I(_t,{disabled:s,className:u.nameInput,placeholder:h("waveSurfer.surfer.name","name"),onSubmit:(O)=>e("name",O),value:c?c.name:h("waveSurfer.surfer.sound","Sound")})})})}),I("div",{className:u.row,children:I("div",{ref:t,className:u.waveBoxWrapper})}),Mr("div",{className:u.row,children:[I(Er,{className:Go(u.button,u.playButton,{[u.groupButtonToggledOff]:s}),onClick:v,children:I("img",{ref:i,src:b,className:u.buttonIcon,title:h("waveSurfer.surfer.play","Play")})}),c&&c.record&&I(Er,{className:Go(u.button,u.recordButton,{[u.groupButtonToggledOff]:s}),onClick:W,children:I("img",{ref:n,src:z,className:u.buttonIcon,title:h("waveSurfer.surfer.record","Record")})})]})]})}Z(".adcUka_wave-surfer-wrapper{background:var(--ui-white);border-radius:inherit;flex-grow:1;display:flex}");var Ar={waveSurferWrapper:"adcUka_wave-surfer-wrapper"};import{jsx as Nr,jsxs as Yt}from"preact/jsx-runtime";function Zt({onSetupLibrary:o}){let[r,t]=Lt(0),{assetList:i}=$t(),n=i.filter((d)=>/^audio\//.test(d.type)),h=n.findLastIndex((d)=>d.record&&d.sampleCount===0);if(h!==-1)t(h);return Yt("div",{className:Ar.waveSurferWrapper,children:[Nr(Oo,{soundList:n,soundIndex:r,onSelect:t,onSetupLibrary:o}),Nr(Uo,{soundList:n,soundIndex:r})]})}var Or={"waveSurfer.contextMenu.export":"export","waveSurfer.contextMenu.delete":"delete","waveSurfer.actionButton.upload":"Upload Sound","waveSurfer.actionButton.surprise":"Surprise","waveSurfer.actionButton.record":"Record","waveSurfer.actionButton.sound":"Choose a Sound","waveSurfer.surfer.sound":"Sound","waveSurfer.surfer.play":"Play","waveSurfer.surfer.record":"Record","waveSurfer.surfer.stop":"Stop","waveSurfer.surfer.name":"name","waveSurfer.error.formatNotSupperted":"This wav format is not supported."};var Wr={"waveSurfer.contextMenu.export":"导出","waveSurfer.contextMenu.delete":"删除","waveSurfer.actionButton.upload":"上传声音","waveSurfer.actionButton.surprise":"随机","waveSurfer.actionButton.record":"录制","waveSurfer.actionButton.sound":"选择一个声音","waveSurfer.surfer.sound":"声音","waveSurfer.surfer.play":"播放","waveSurfer.surfer.record":"录音","waveSurfer.surfer.stop":"停止","waveSurfer.surfer.name":"名称","waveSurfer.error.formatNotSupperted":"声音文件格式不支持。"};var J1={en:Or,"zh-Hans":Wr};export{J1 as locales,Zt as WaveSurfer,q as WaveFile};
